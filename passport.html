<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surpresso ‚Äî –ü–∞—Å–ø–æ—Ä—Ç</title>

  <style>
    :root{
      --yellow:#F2C94C;
      --text:#222;
      --muted:#666;
      --line:#eee;
      --card:#fff;
    }

    body{
      font-family: "Segoe UI", system-ui, Arial, sans-serif;
      margin:0;
      background:#f7f7f7;
      color:var(--text);
      font-size:14px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-top:12px;
      overflow:hidden;
    }

    .top{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:2px solid var(--yellow);
      padding-bottom:10px;
    }

    .logo{ font-size:20px; font-weight:900; }
    .sub{ font-size:12px; color:var(--muted); }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background:#f1f1f1;
    }
    .btn-yellow{ background:var(--yellow); }

    .pill{
      background:#f4f4f4;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    td{
      padding:7px 6px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    td.lbl{
      width:230px;
      font-weight:800;
      color:#111;
    }
    .muted{ color:var(--muted); font-size:12px; }

    h2{
      margin:0 0 8px;
      font-size:14px;
      border-left:4px solid var(--yellow);
      padding-left:8px;
    }

    /* photos */
    .photosGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:12px;
      margin-top:10px;
    }
    @media(max-width:560px){ .photosGrid{grid-template-columns:1fr} }

    .ph{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#fafafa;
    }

    .phMedia{
      position:relative;
      width:100%;
      aspect-ratio:4/3;
      background:#111;
    }
    .ph img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      cursor:pointer;
      background:#111;
      position:absolute;
      inset:0;
    }

    /* lightbox */
    .lb{
      position:fixed; inset:0;
      background:rgba(0,0,0,.80);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .lbInner{ max-width:980px; width:100%; }
    .lbTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color:#fff;
      margin-bottom:10px;
    }
    .lbTitle{
      font-weight:800;
      font-size:14px;
      opacity:.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .lbBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .lbBtn{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .lbImgWrap{
      background:#111;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .lbImg{
      width:100%;
      max-height:78vh;
      object-fit:contain;
      display:block;
      background:#111;
    }

    /* PRINT A4 */
    @media print{
      body{ background:#fff; }
      .wrap{ max-width:none; padding:0; }
      .card{ border:0; border-radius:0; padding:0; margin:0 0 10px; }
      .actions{ display:none !important; }
      .photosGrid{ grid-template-columns:repeat(3,1fr); }
      .ph{ break-inside:avoid; }
      .phMedia{ aspect-ratio:4/3; }
    }

    @page{
      size: A4;
      margin: 12mm;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="logo">Surpresso Service</div>
        <div class="sub">–ü–∞—Å–ø–æ—Ä—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è (–¥–∏–Ω–∞–º—ñ—á–Ω–∏–π)</div>
      </div>

      <div class="sub">
        ID: <b id="eqId">‚Äî</b><br />
        <span class="muted" id="updatedAt"></span>
      </div>
    </div>

    <div class="card actions">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill" id="pillOwner">owner: ‚Äî</span>
          <span class="pill" id="pillType">type: ‚Äî</span>
          <span class="pill">—Å—Ç–∞—Ç—É—Å: <b id="curStatus">‚Äî</b></span>
        </div>

        <div class="row">
          <button class="btn" id="btnRefresh">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
          <button class="btn btn-yellow" id="btnPrint">üñ® –î—Ä—É–∫ A4</button>
        </div>
      </div>

      <div class="muted" style="margin-top:8px" id="hint"></div>
    </div>

    <div id="noId" class="card" style="display:none">
      <div style="color:#b00;font-weight:900">
        –ù–µ–º–∞—î ID. –í—ñ–¥–∫—Ä–∏–π —è–∫ <b>passport.html?id=...</b>
      </div>
    </div>

    <div id="main" style="display:none">
      <div class="card">
        <h2>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h2>
        <table id="info"></table>
      </div>

      <div class="card">
        <h2>–§–æ—Ç–æ</h2>
        <div class="muted" id="photosHint"></div>
        <div class="photosGrid" id="photos"></div>
      </div>

      <div class="card">
        <h2>–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤</h2>
        <table id="log"></table>
      </div>

      <div class="card">
        <h2>–ü—ñ–¥–ø–∏—Å</h2>
        <div class="row" style="gap:20px">
          <div>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π: <span style="display:inline-block;border-bottom:1px solid #222; width:260px; height:16px;"></span></div>
          <div>–î–∞—Ç–∞: <span style="display:inline-block;border-bottom:1px solid #222; width:140px; height:16px;"></span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div class="lb" id="lightbox" onclick="closeLightbox(event)">
    <div class="lbInner">
      <div class="lbTop">
        <div class="lbTitle" id="lbTitle">–§–æ—Ç–æ</div>
        <div class="lbBtns">
          <button class="lbBtn" id="lbOpenDrive" onclick="openDriveFromLightbox(event)">–í—ñ–¥–∫—Ä–∏—Ç–∏</button>
          <button class="lbBtn" onclick="forceCloseLightbox(event)">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
      <div class="lbImgWrap">
        <img class="lbImg" id="lbImg" src="" alt="">
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const PWA_KEY_STORAGE = "surpresso_pwa_key";
    const API_BASE = "";

    const $ = (id) => document.getElementById(id);

    // ==========================
    // ID
    // ==========================
    const params = new URLSearchParams(location.search);
    const EQUIPMENT_ID = (params.get("id") || "").trim();

    if (!EQUIPMENT_ID) {
      $("noId").style.display = "block";
    } else {
      $("main").style.display = "block";
      $("eqId").textContent = EQUIPMENT_ID;

      $("btnPrint").onclick = () => window.print();
      $("btnRefresh").onclick = load;

      load();
    }

    // ==========================
    // AUTH headers (x-surpresso-key)
    // ==========================
    function getKey() {
      return localStorage.getItem(PWA_KEY_STORAGE) || "";
    }
    function headersWithKey() {
      const k = getKey();
      return k ? { "x-surpresso-key": k } : {};
    }

    // ==========================
    // API
    // ==========================
    async function apiGet(url) {
      const resp = await fetch(url, { headers: headersWithKey() });
      return await resp.json();
    }

    // ==========================
    // LOAD / RENDER
    // ==========================
    async function load() {
      $("hint").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      const data = await apiGet(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}`);

      if (!data.ok) {
        $("hint").textContent = "";
        return alert(data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è");
      }

      render(data);
      $("hint").textContent = "";
    }

    function render(data) {
      const eq = data.equipment || {};
      const photos = Array.isArray(data.photos) ? data.photos : [];
      const log = Array.isArray(data.log) ? data.log : [];

      $("curStatus").textContent = eq.status || "‚Äî";
      $("updatedAt").textContent = eq.updatedAt ? ("–û–Ω–æ–≤–ª–µ–Ω–æ: " + fmt(eq.updatedAt)) : "";

      $("pillOwner").textContent = "owner: " + (eq.owner || "‚Äî");
      $("pillType").textContent = "type: " + (eq.type || "‚Äî");

      // info rows
      const rows = [];
      const add = (k, v) => rows.push(`<tr><td class="lbl">${k}</td><td>${esc(v)}</td></tr>`);

      add("ID", eq.id || EQUIPMENT_ID);
      add("–¢–∏–ø", eq.type || "‚Äî");
      add("–í–ª–∞—Å–Ω–∏–∫", eq.owner || "‚Äî");

      if (String(eq.isContract) === "true") add("–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è", "–ó–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º ‚úÖ");

      if (eq.owner === "client") {
        add("–ö–ª—ñ—î–Ω—Ç", eq.clientName || "‚Äî");
        add("–¢–µ–ª–µ—Ñ–æ–Ω", eq.clientPhone || "‚Äî");
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.clientLocation || "‚Äî");
        add("–ú–æ–¥–µ–ª—å", eq.model || "‚Äî");
        add("–°–µ—Ä—ñ–π–Ω–∏–π", eq.serial || "‚Äî");
      } else {
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.companyLocation || "‚Äî");
        add("–ù–∞–∑–≤–∞", eq.name || "‚Äî");
        add("–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ‚Ññ", eq.internalNumber || "‚Äî");
      }

      add("–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å", eq.status || "‚Äî");
      add("–û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", eq.lastComment || "‚Äî");
      add("–°—Ç–≤–æ—Ä–µ–Ω–æ", fmt(eq.createdAt) || "‚Äî");
      add("–û–Ω–æ–≤–ª–µ–Ω–æ", fmt(eq.updatedAt) || "‚Äî");

      $("info").innerHTML = rows.join("");

      // photos
      renderPhotos(photos);

      // log
      $("log").innerHTML = log.length
        ? log.slice(0, 12).map(r => `
          <tr>
            <td style="width:160px">${fmt(r.ts)}</td>
            <td>
              <b>${esc(r.newStatus)}</b>
              ${r.comment ? " ‚Äî " + esc(r.comment) : ""}
              ${r.actor ? ` <span class="muted">(${esc(r.actor)})</span>` : ""}
            </td>
          </tr>
        `).join("")
        : `<tr><td class="muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</td></tr>`;
    }

    function renderPhotos(photos) {
      if (!photos.length) {
        $("photosHint").textContent = "–§–æ—Ç–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ";
        $("photos").innerHTML = "";
        return;
      }

      $("photosHint").textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ —Ñ–æ—Ç–æ: ${photos.length}`;

      $("photos").innerHTML = photos.map((p, i) => {
        const driveUrl = String(p.url || "");
        const imgUrl = String(p.imgUrl || "") || driveToImageUrl(driveUrl);
        const cap = p.caption || `–§–æ—Ç–æ ${i + 1}`;
        const safeCap = esc(cap);
        const safeDrive = esc(driveUrl);
        const fresh = (imgUrl && imgUrl.includes("?")) ? `${imgUrl}&t=${Date.now()}` : `${imgUrl}?t=${Date.now()}`;

        // –µ—Å–ª–∏ imgUrl –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–∫–∞–∂–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç—å
        if (!imgUrl) {
          return `
            <div class="ph">
              <div style="padding:18px" class="muted">
                –ù–µ–º–∞—î –ø—Ä–µ–≤‚Äô—é.
                ${driveUrl ? `<br><a href="${safeDrive}" target="_blank">–í—ñ–¥–∫—Ä–∏—Ç–∏</a>` : ""}
              </div>
            </div>
          `;
        }

        return `
          <div class="ph">
            <div class="phMedia">
              <img
                src="${fresh}"
                alt="${safeCap}"
                loading="lazy"
                onclick="openLightbox('${escapeJs(fresh)}','${escapeJs(driveUrl)}','${escapeJs(cap)}')"
                onerror="this.onerror=null; this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px&quot; class=&quot;muted&quot;>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é. <a target=_blank href=&quot;${safeDrive}&quot;>–í—ñ–¥–∫—Ä–∏—Ç–∏</a></div>';"
              />
            </div>
          </div>
        `;
      }).join("");
    }

    // ‚úÖ –ü—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π proxy (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ img -> –∏—Å–ø–æ–ª—å–∑—É–µ–º ?k=...)
    function driveToImageUrl(driveUrl) {
      if (!driveUrl) return "";

      const s = String(driveUrl);
      let fileId = null;

      if (s.includes("uc?export=view&id=")) {
        const m = s.match(/id=([^&]+)/i);
        if (m) fileId = m[1];
      } else if (s.includes("/file/d/")) {
        const m = s.match(/\/file\/d\/([^\/]+)\//i);
        if (m) fileId = m[1];
      } else if (s.includes("id=")) {
        const m = s.match(/[?&]id=([^&]+)/i);
        if (m) fileId = m[1];
      }

      if (fileId) {
        const k = getKey();
        const q = k ? `?k=${encodeURIComponent(k)}` : "";
        return `${API_BASE}/proxy-drive/${encodeURIComponent(fileId)}${q}`;
      }

      return s;
    }

    // ==========================
    // LIGHTBOX
    // ==========================
    let LB_DRIVE_URL = "";

    function openLightbox(imgUrl, driveUrl, title) {
      LB_DRIVE_URL = driveUrl || "";
      $("lbImg").src = imgUrl || "";
      $("lbTitle").textContent = title || "–§–æ—Ç–æ";
      $("lightbox").style.display = "flex";
      $("lbOpenDrive").style.display = LB_DRIVE_URL ? "inline-flex" : "none";
    }

    function closeLightbox(e) {
      if (e.target && e.target.id === "lightbox") {
        $("lightbox").style.display = "none";
        $("lbImg").src = "";
        LB_DRIVE_URL = "";
      }
    }

    function forceCloseLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      $("lightbox").style.display = "none";
      $("lbImg").src = "";
      LB_DRIVE_URL = "";
    }

    function openDriveFromLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      if (!LB_DRIVE_URL) return;
      window.open(LB_DRIVE_URL, "_blank");
    }

    // ==========================
    // UTILS
    // ==========================
    function fmt(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const yy = String(dt.getFullYear());
        const hh = String(dt.getHours()).padStart(2, "0");
        const mi = String(dt.getMinutes()).padStart(2, "0");
        return `${dd}.${mm}.${yy} ${hh}:${mi}`;
      } catch (e) { return ""; }
    }

    function esc(v) {
      if (v === null || v === undefined || String(v).trim() === "") return "‚Äî";
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function escapeJs(s){
      return String(s || "")
        .replaceAll("\\", "\\\\")
        .replaceAll("'", "\\'")
        .replaceAll("\n", "\\n")
        .replaceAll("\r", "");
    }
  </script>
</body>
</html>
