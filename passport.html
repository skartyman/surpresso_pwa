<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surpresso ‚Äî –ü–∞—Å–ø–æ—Ä—Ç</title>

  <style>
    :root{
      --yellow:#F2C94C;
      --text:#1b1b1b;
      --muted:#6b6f76;
      --line:#ececec;
      --card:#fff;
      --shadow:0 12px 28px rgba(17, 17, 17, 0.08);
      --blue:#2f80ed;
      --dark:#1f2328;
    }

    body{
      font-family: "Segoe UI", system-ui, Arial, sans-serif;
      margin:0;
      background:#f6f7fb;
      color:var(--text);
      font-size:14px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:18px 16px 40px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      margin-top:12px;
      overflow:hidden;
      box-shadow:var(--shadow);
    }

    .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:linear-gradient(120deg, #23272f, #2d313a 45%, #3b3f48);
      border-radius:20px;
      color:#fff;
      box-shadow:0 18px 32px rgba(17, 17, 17, 0.2);
    }

    .logo{
      font-size:18px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo img{
      width:40px;
      height:40px;
      border-radius:12px;
      background:#fff;
      padding:6px;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    .sub{ font-size:12px; color:rgba(255,255,255,.75); }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background:#f1f1f1;
    }
    .btn-yellow{ background:var(--yellow); }
    .btn-dark{
      background:#1f2328;
      color:#fff;
    }

    .pill{
      background:#f4f4f4;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill-status{
      background:rgba(242, 201, 76, 0.2);
      color:#000;
      font-weight:800;
      border:1px solid rgba(242, 201, 76, 0.5);
    }
    .statusHighlight{
      margin-top:12px;
      display:flex;
      gap:16px;
      align-items:stretch;
      background:#f8f9fb;
      border:1px solid #e6e9ef;
      border-radius:14px;
      padding:12px 14px;
    }
    .statusBlock{
      flex:1;
      min-width:0;
    }
    .statusLabel{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .statusValue{
      font-size:15px;
      font-weight:800;
      color:#111;
      word-break:break-word;
    }
    .statusDivider{
      width:1px;
      background:#e2e6ee;
      align-self:stretch;
    }
    .statusComment{
      font-weight:600;
      color:#222;
    }

    .hero{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:16px;
      align-items:stretch;
    }
    .heroMedia{
      border-radius:16px;
      overflow:hidden;
      background:#f0f2f6;
      min-height:220px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      border:1px solid #e3e6eb;
    }
    .heroMedia img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .heroBadge{
      position:absolute;
      bottom:12px;
      left:12px;
      background:rgba(31, 35, 40, 0.85);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .heroInfo h1{
      margin:0 0 6px;
      font-size:20px;
    }
    .heroMeta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      margin-bottom:12px;
    }
    .heroList{
      display:grid;
      gap:8px;
      font-size:13px;
    }
    .heroList b{
      color:#111;
    }

    .infoGrid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    .infoCard{
      background:#f8f9fb;
      border:1px solid #ebedf2;
      border-radius:14px;
      padding:12px 14px;
    }
    .infoCard span{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .tgLink{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#111;
      color:#fff;
      font-size:12px;
      text-decoration:none;
    }
    .tgLink:hover{ opacity:.9; }

    .tgCard{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:16px;
      align-items:center;
      padding:18px;
      background:linear-gradient(130deg, #eef5ff, #f9fbff);
      border:1px solid #d8e6ff;
    }
    .tgArt{
      width:64px;
      height:64px;
      border-radius:18px;
      background:#2f80ed;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 20px rgba(47, 128, 237, 0.25);
    }
    .tgArt svg{
      width:36px;
      height:36px;
      fill:#fff;
    }
    .tgText h3{
      margin:0 0 6px;
      font-size:16px;
    }
    .tgText p{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    td{
      padding:7px 6px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    td.lbl{
      width:230px;
      font-weight:800;
      color:#111;
    }
    .muted{ color:var(--muted); font-size:12px; }

    h2{
      margin:0 0 8px;
      font-size:14px;
      border-left:4px solid var(--yellow);
      padding-left:8px;
    }

    /* photos */
    .photosGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      margin-top:10px;
      background:#f4f5f9;
      padding:12px;
      border-radius:14px;
    }

    .ph{
      border:0;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      border:1px solid #e3e6eb;
      display:flex;
      flex-direction:column;
    }

    .phMedia{
      width:100%;
      background:#fff;
    }

    .ph img{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
      cursor:pointer;
      background:#fff;
    }
    .phFooter{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .phFooter span{
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .phBtn{
      border-radius:999px;
      border:1px solid #d8dbe0;
      background:#fff;
      padding:6px 10px;
      font-size:11px;
      font-weight:700;
      cursor:pointer;
    }
    .phBtn.is-active{
      background:var(--yellow);
      border-color:var(--yellow);
      color:#111;
    }

    /* lightbox */
    .lb{
      position:fixed; inset:0;
      background:rgba(0,0,0,.80);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .lbInner{ max-width:980px; width:100%; }
    .lbTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      color:#fff;
      margin-bottom:10px;
    }
    .lbTitle{
      flex:1 1 auto;
      min-width:0;
      font-weight:800;
      font-size:14px;
      opacity:.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .lbBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .lbBtn{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .lbImgWrap{
      background:#111;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .lbImg{
      width:100%;
      max-height:78vh;
      object-fit:contain;
      display:block;
      background:#111;
    }
    @media(max-width:520px){
      .lbTop{
        flex-direction:column;
        align-items:stretch;
      }
      .lbBtns{ width:100%; }
      .lbBtn{
        flex:1 1 auto;
        padding:6px 8px;
        font-size:12px;
        text-align:center;
      }
    }

    /* PRINT A4 */
    @media(max-width:860px){
      .hero{
        grid-template-columns:1fr;
      }
      .infoGrid{
        grid-template-columns:1fr;
      }
      .tgCard{
        grid-template-columns:1fr;
        text-align:center;
      }
      .tgCard .tgArt{
        margin:0 auto;
      }
    }

    @media(max-width:560px){
      .photosGrid{ grid-template-columns:repeat(2,1fr); }
      .actions .action-buttons{
        width:100%;
      }
      .actions .action-buttons .btn{
        flex:1 1 calc(50% - 5px);
        text-align:center;
      }
    }

    @media print{
      body{ background:#fff; }
      .wrap{ max-width:none; padding:0; }
      .card{ border:0; border-radius:0; padding:0; margin:0 0 10px; box-shadow:none; }
      .actions{ display:none !important; }
      .photosGrid{
        grid-template-columns:repeat(2,1fr);
        gap:6mm;
      }
      .ph{
        break-inside:avoid;
      }
      .phMedia{
        height:70mm;
        display:flex;
        align-items:center;
        justify-content:center;
        background:#fff;
        border:1px solid #111;
      }
      .ph img{
        width:100%;
        height:100%;
        object-fit:contain;
        background:#fff;
      }
    }

    @page{
      size: A4;
      margin: 12mm;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="logo">
          <img src="icons/192.png" alt="Surpresso" />
          <div>
            <div>Surpresso</div>
            <div class="sub">Service & Rental</div>
          </div>
        </div>
        <div class="sub" style="margin-top:6px">–ü–∞—Å–ø–æ—Ä—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <span class="pill pill-status">‚óè <span id="curStatus">‚Äî</span></span>
        <div class="sub" style="text-align:right">
          ID: <b id="eqId">‚Äî</b><br />
          <span class="muted" id="updatedAt"></span>
        </div>
      </div>
    </div>

    <div class="card actions">
        <div class="row" style="justify-content:space-between">
          <div class="row">
          <span class="pill" id="pillOwner">‚Äî</span>
          <span class="pill" id="pillType">‚Äî</span>
          <span class="pill"><b id="curStatusMobile">‚Äî</b></span>
        </div>

        <div class="row action-buttons">
          <button class="btn" id="btnRefresh">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
          <button class="btn btn-yellow" id="btnPrint">üñ® –î—Ä—É–∫ A4</button>
        </div>
      </div>

      <div class="statusHighlight">
        <div class="statusBlock">
          <span class="statusLabel">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å</span>
          <div class="statusValue" id="curStatusTop">‚Äî</div>
        </div>
        <div class="statusDivider" aria-hidden="true"></div>
        <div class="statusBlock">
          <span class="statusLabel">–û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä</span>
          <div class="statusValue statusComment" id="lastCommentTop">‚Äî</div>
        </div>
      </div>

      <div class="muted" style="margin-top:8px" id="hint"></div>
    </div>

    <div id="noId" class="card" style="display:none">
      <div style="color:#b00;font-weight:900">
        –ù–µ–º–∞—î ID. –í—ñ–¥–∫—Ä–∏–π —è–∫ <b>passport.html?id=...</b>
      </div>
    </div>

    <div id="main" style="display:none">
      <div class="card hero">
        <div class="heroMedia">
          <img id="mainPhoto" src="" alt="–ì–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ" />
          <div class="heroBadge">‚≠ê –û–±–∫–ª–∞–¥–∏–Ω–∫–∞</div>
        </div>
        <div class="heroInfo">
          <h1 id="heroTitle">–ü–∞—Å–ø–æ—Ä—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</h1>
          <div class="heroMeta">
            <span id="heroId">ID: ‚Äî</span>
            <span id="heroUpdated">–û–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</span>
          </div>
          <div class="infoGrid">
            <div class="infoCard">
              <span>–¢–∏–ø</span>
              <b id="heroType">‚Äî</b>
            </div>
            <div class="infoCard">
              <span>–í–ª–∞—Å–Ω–∏–∫</span>
              <b id="heroOwner">‚Äî</b>
            </div>
            <div class="infoCard">
              <span>–õ–æ–∫–∞—Ü—ñ—è</span>
              <b id="heroLocation">‚Äî</b>
            </div>
            <div class="infoCard">
              <span>–ú–æ–¥–µ–ª—å</span>
              <b id="heroModel">‚Äî</b>
            </div>
          </div>
        </div>
      </div>

      <div class="card tgCard" id="tgCard">
        <div class="tgArt" aria-hidden="true">
          <svg viewBox="0 0 240 240" role="img" aria-label="Telegram">
            <path d="M209.8 48.6c-4.4-3.6-10.5-4.6-16.9-2.4L42.7 104.9c-6.4 2.2-10.5 6.4-11.2 11.6-.7 5.1 2.2 9.9 7.9 13l34.9 18.4 16.6 50.3c1.7 5.1 6.5 8.5 12.1 8.7h.5c5.4 0 10.3-2.8 12.9-7.4l22.4-40.6 46.7 34.4c4.5 3.3 10.1 4.2 15.4 2.3 5.3-1.9 9.2-6.2 10.4-11.7l29.5-128.5c1.4-6.1-.7-12.3-5.5-16.6zM94.6 142.7l-3.4 40.2-12.2-36.8 79.6-71.3-63.9 67.9z"/>
          </svg>
        </div>
        <div class="tgText">
          <h3>–ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
          <p>–û—Ç—Ä–∏–º—É–π—Ç–µ —Å—Ç–∞—Ç—É—Å–∏ —Ä–µ–º–æ–Ω—Ç—É, ETA —Ç–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –ø–æ —Ü—å–æ–º—É –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—é.</p>
        </div>
        <div id="telegramSubscribe"></div>
      </div>

      <div class="card">
        <h2>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h2>
        <table id="info"></table>
      </div>

      <div class="card">
        <h2>–§–æ—Ç–æ</h2>
        <div class="muted" id="photosHint"></div>
        <div class="photosGrid" id="photos"></div>
      </div>

      <div class="card">
        <h2>–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤</h2>
        <table id="log"></table>
      </div>

      <div class="card">
        <h2>–ü—ñ–¥–ø–∏—Å</h2>
        <div class="row" style="gap:20px">
          <div>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π: <span style="display:inline-block;border-bottom:1px solid #222; width:260px; height:16px;"></span></div>
          <div>–î–∞—Ç–∞: <span style="display:inline-block;border-bottom:1px solid #222; width:140px; height:16px;"></span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div class="lb" id="lightbox" onclick="closeLightbox(event)">
    <div class="lbInner">
      <div class="lbTop">
        <div class="lbTitle" id="lbTitle">–§–æ—Ç–æ</div>
        <div class="lbBtns">
          <button class="lbBtn" id="lbOpenDrive" onclick="openDriveFromLightbox(event)">–í—ñ–¥–∫—Ä–∏—Ç–∏</button>
          <button class="lbBtn" onclick="forceCloseLightbox(event)">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
      <div class="lbImgWrap">
        <img class="lbImg" id="lbImg" src="" alt="">
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const PWA_KEY_STORAGE = "surpresso_pwa_key";
    const API_BASE = "";

    const $ = (id) => document.getElementById(id);
    const coverKey = (id) => `surpresso_cover_${id}`;
    let CURRENT_PHOTOS = [];

    // ==========================
    // ID
    // ==========================
    const params = new URLSearchParams(location.search);
    const EQUIPMENT_ID = (params.get("id") || "").trim();

    if (!EQUIPMENT_ID) {
      $("noId").style.display = "block";
    } else {
      $("main").style.display = "block";
      $("eqId").textContent = EQUIPMENT_ID;

      $("btnPrint").onclick = () => window.print();
      $("btnRefresh").onclick = load;

      load();
    }

    // ==========================
    // AUTH headers (x-surpresso-key)
    // ==========================
    function getKey() {
      return localStorage.getItem(PWA_KEY_STORAGE) || "";
    }
    function headersWithKey() {
      const k = getKey();
      return k ? { "x-surpresso-key": k } : {};
    }

    // ==========================
    // API
    // ==========================
    async function apiGet(url) {
      const resp = await fetch(url, { headers: headersWithKey() });
      return await resp.json();
    }

    // ==========================
    // LOAD / RENDER
    // ==========================
    async function load() {
      $("hint").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      const data = await apiGet(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}`);

      if (!data.ok) {
        $("hint").textContent = "";
        return alert(data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è");
      }

      render(data);
      $("hint").textContent = "";
    }

    function render(data) {
      const eq = data.equipment || {};
      const photos = Array.isArray(data.photos) ? data.photos : [];
      const log = Array.isArray(data.log) ? data.log : [];
      const ownerLabel = mapOwner(eq.owner);
      const typeLabel = mapType(eq.type);

      $("curStatus").textContent = eq.status || "‚Äî";
      $("curStatusMobile").textContent = eq.status || "‚Äî";
      $("curStatusTop").textContent = eq.status || "‚Äî";
      $("lastCommentTop").textContent = eq.lastComment || "‚Äî";
      $("updatedAt").textContent = eq.updatedAt ? ("–û–Ω–æ–≤–ª–µ–Ω–æ: " + fmt(eq.updatedAt)) : "";

      $("pillOwner").textContent = ownerLabel || "‚Äî";
      $("pillType").textContent = typeLabel || "‚Äî";

      $("heroTitle").textContent = eq.name || "–ü–∞—Å–ø–æ—Ä—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è";
      $("heroId").textContent = `ID: ${eq.id || EQUIPMENT_ID}`;
      $("heroUpdated").textContent = eq.updatedAt ? `–û–Ω–æ–≤–ª–µ–Ω–æ: ${fmt(eq.updatedAt)}` : "–û–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî";
      $("heroType").textContent = typeLabel || "‚Äî";
      $("heroOwner").textContent = ownerLabel || "‚Äî";
      $("heroLocation").textContent = eq.owner === "client" ? (eq.clientLocation || "‚Äî") : (eq.companyLocation || "‚Äî");
      $("heroModel").textContent = eq.model || eq.name || "‚Äî";

      // info rows
      const rows = [];
      const add = (k, v) => rows.push(`<tr><td class="lbl">${k}</td><td>${esc(v)}</td></tr>`);
      const addHtml = (k, html) => rows.push(`<tr><td class="lbl">${k}</td><td>${html}</td></tr>`);
      const personalHiddenLabel = "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ";

      add("ID", eq.id || EQUIPMENT_ID);
      add("–¢–∏–ø", typeLabel || "‚Äî");
      add("–í–ª–∞—Å–Ω–∏–∫", ownerLabel || "‚Äî");
      const tgCard = $("tgCard");
      if (eq.owner === "company") {
        tgCard.style.display = "none";
        $("telegramSubscribe").innerHTML = "";
      } else {
        const tgLink = buildTelegramSubscribeLink(eq.id || EQUIPMENT_ID, data.tgBotUsername);
        $("telegramSubscribe").innerHTML = tgLink;
        tgCard.style.display = "";
      }

      if (String(eq.isContract) === "true") add("–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è", "–ó–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º ‚úÖ");

      if (eq.owner === "client") {
        add("–ö–ª—ñ—î–Ω—Ç", personalHiddenLabel);
        add("–¢–µ–ª–µ—Ñ–æ–Ω", personalHiddenLabel);
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.clientLocation || "‚Äî");
        add("–ú–æ–¥–µ–ª—å", eq.model || "‚Äî");
        add("–°–µ—Ä—ñ–π–Ω–∏–π", eq.serial || "‚Äî");
      } else {
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.companyLocation || "‚Äî");
        add("–ù–∞–∑–≤–∞", eq.name || "‚Äî");
        add("–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ‚Ññ", eq.internalNumber || "‚Äî");
      }

      add("–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å", eq.status || "‚Äî");
      add("–û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", eq.lastComment || "‚Äî");
      add("–°—Ç–≤–æ—Ä–µ–Ω–æ", fmt(eq.createdAt) || "‚Äî");
      add("–û–Ω–æ–≤–ª–µ–Ω–æ", fmt(eq.updatedAt) || "‚Äî");

      $("info").innerHTML = rows.join("");

      // photos
      renderPhotos(photos);

      // log
      $("log").innerHTML = log.length
        ? log.slice(0, 12).map(r => `
          <tr>
            <td style="width:160px">${fmt(r.ts)}</td>
            <td>
              <b>${esc(r.newStatus)}</b>
              ${r.comment ? " ‚Äî " + esc(r.comment) : ""}
              ${r.actor ? ` <span class="muted">(${esc(r.actor)})</span>` : ""}
            </td>
          </tr>
        `).join("")
        : `<tr><td class="muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</td></tr>`;
    }

    function mapOwner(owner) {
      if (!owner) return "";
      const map = {
        client: "–ö–ª—ñ—î–Ω—Ç",
        company: "–ö–æ–º–ø–∞–Ω—ñ—è",
      };
      return map[owner] || owner;
    }

    function mapType(type) {
      if (!type) return "";
      const map = {
        "auto-coffee": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–∞–≤–æ–º–∞—à–∏–Ω–∞",
      };
      return map[type] || type;
    }

    function renderPhotos(photos) {
      if (!photos.length) {
        $("photosHint").textContent = "–§–æ—Ç–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ";
        $("photos").innerHTML = "";
        $("mainPhoto").src = "";
        $("mainPhoto").alt = "–§–æ—Ç–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ";
        return;
      }

      $("photosHint").textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ —Ñ–æ—Ç–æ: ${photos.length}`;
      CURRENT_PHOTOS = photos;

      const saved = getSavedCover(photos);
      setMainPhoto(saved.index);

      $("photos").innerHTML = photos.map((p, i) => {
        const driveUrl = String(p.url || "");
        const imgUrl = String(p.imgUrl || "") || driveToImageUrl(driveUrl);
        const cap = p.caption || `–§–æ—Ç–æ ${i + 1}`;
        const displayCap = /^https?:\/\//i.test(cap) ? `–§–æ—Ç–æ ${i + 1}` : cap;
        const safeCap = esc(displayCap);
        const safeDrive = esc(driveUrl);
        const fresh = (imgUrl && imgUrl.includes("?")) ? `${imgUrl}&t=${Date.now()}` : `${imgUrl}?t=${Date.now()}`;
        const isCover = saved.index === i;
        const buttonLabel = isCover ? "–ì–æ–ª–æ–≤–Ω–µ" : "–ù–∞ –æ–±–∫–ª–∞–¥–∏–Ω–∫—É";

        // –µ—Å–ª–∏ imgUrl –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–∫–∞–∂–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç—å
        if (!imgUrl) {
          return `
            <div class="ph">
              <div style="padding:18px" class="muted">
                –ù–µ–º–∞—î –ø—Ä–µ–≤‚Äô—é.
                ${driveUrl ? `<br><a href="${safeDrive}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a>` : ""}
              </div>
            </div>
          `;
        }

        return `
          <div class="ph">
            <div class="phMedia">
              <img
                src="${fresh}"
                alt="${safeCap}"
                loading="lazy"
                onclick="openLightbox('${escapeJs(fresh)}','${escapeJs(driveUrl)}','${escapeJs(cap)}')"
                onerror="this.onerror=null; this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px&quot; class=&quot;muted&quot;>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é. <a target=_blank href=&quot;${safeDrive}&quot;>–í—ñ–¥–∫—Ä–∏—Ç–∏</a></div>';"
              />
            </div>
            <div class="phFooter">
              <span title="${safeCap}">${safeCap}</span>
              <button class="phBtn ${isCover ? "is-active" : ""}" onclick="setMainPhoto(${i})">${buttonLabel}</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function buildTelegramSubscribeLink(id, botUsername) {
      const safeId = encodeURIComponent(String(id || ""));
      const safeBot = String(botUsername || "SurpressoServicebot").replace(/^@/, "");
      const url = `https://t.me/${encodeURIComponent(safeBot)}?start=eq_${safeId}`;
      return `<a class="tgLink btn-dark" href="${url}" target="_blank" rel="noopener">üîî –ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è</a>`;
    }

    // ‚úÖ –ü—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π proxy (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ img -> –∏—Å–ø–æ–ª—å–∑—É–µ–º ?k=...)
    function driveToImageUrl(driveUrl) {
      if (!driveUrl) return "";

      const s = String(driveUrl);
      let fileId = null;

      if (s.includes("uc?export=view&id=")) {
        const m = s.match(/id=([^&]+)/i);
        if (m) fileId = m[1];
      } else if (s.includes("/file/d/")) {
        const m = s.match(/\/file\/d\/([^\/]+)\//i);
        if (m) fileId = m[1];
      } else if (s.includes("id=")) {
        const m = s.match(/[?&]id=([^&]+)/i);
        if (m) fileId = m[1];
      }

      if (fileId) {
        const k = getKey();
        const q = k ? `?k=${encodeURIComponent(k)}` : "";
        return `${API_BASE}/proxy-drive/${encodeURIComponent(fileId)}${q}`;
      }

      return s;
    }

    // ==========================
    // LIGHTBOX
    // ==========================
    let LB_DRIVE_URL = "";

    function openLightbox(imgUrl, driveUrl, title) {
      LB_DRIVE_URL = driveUrl || "";
      $("lbImg").src = imgUrl || "";
      const displayTitle = /^https?:\/\//i.test(String(title || "")) ? "–§–æ—Ç–æ" : (title || "–§–æ—Ç–æ");
      $("lbTitle").textContent = displayTitle;
      $("lightbox").style.display = "flex";
      $("lbOpenDrive").style.display = LB_DRIVE_URL ? "inline-flex" : "none";
    }

    function closeLightbox(e) {
      if (e.target && e.target.id === "lightbox") {
        $("lightbox").style.display = "none";
        $("lbImg").src = "";
        LB_DRIVE_URL = "";
      }
    }

    function forceCloseLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      $("lightbox").style.display = "none";
      $("lbImg").src = "";
      LB_DRIVE_URL = "";
    }

    function openDriveFromLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      if (!LB_DRIVE_URL) return;
      window.open(LB_DRIVE_URL, "_blank");
    }

    // ==========================
    // COVER PHOTO
    // ==========================
    function getSavedCover(photos) {
      const raw = localStorage.getItem(coverKey(EQUIPMENT_ID));
      if (!raw) return { index: 0 };
      try {
        const saved = JSON.parse(raw);
        const idx = photos.findIndex((p) => String(p.url || "") === String(saved.url || ""));
        if (idx >= 0) return { index: idx };
      } catch (e) {
        return { index: 0 };
      }
      return { index: 0 };
    }

    function setMainPhoto(index) {
      const photo = CURRENT_PHOTOS[index];
      if (!photo) return;
      const driveUrl = String(photo.url || "");
      const imgUrl = String(photo.imgUrl || "") || driveToImageUrl(driveUrl);
      const cap = photo.caption || `–§–æ—Ç–æ ${index + 1}`;
      const fresh = (imgUrl && imgUrl.includes("?")) ? `${imgUrl}&t=${Date.now()}` : `${imgUrl}?t=${Date.now()}`;

      $("mainPhoto").src = fresh;
      $("mainPhoto").alt = cap;
      localStorage.setItem(coverKey(EQUIPMENT_ID), JSON.stringify({ url: driveUrl || imgUrl || "" }));

      const buttons = document.querySelectorAll(".phBtn");
      buttons.forEach((btn, idx) => {
        const isActive = idx === index;
        btn.classList.toggle("is-active", isActive);
        btn.textContent = isActive ? "–ì–æ–ª–æ–≤–Ω–µ" : "–ù–∞ –æ–±–∫–ª–∞–¥–∏–Ω–∫—É";
      });
    }

    // ==========================
    // UTILS
    // ==========================
    function fmt(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const yy = String(dt.getFullYear());
        const hh = String(dt.getHours()).padStart(2, "0");
        const mi = String(dt.getMinutes()).padStart(2, "0");
        return `${dd}.${mm}.${yy} ${hh}:${mi}`;
      } catch (e) { return ""; }
    }

    function esc(v) {
      if (v === null || v === undefined || String(v).trim() === "") return "‚Äî";
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function escapeJs(s){
      return String(s || "")
        .replaceAll("\\", "\\\\")
        .replaceAll("'", "\\'")
        .replaceAll("\n", "\\n")
        .replaceAll("\r", "");
    }
  </script>
</body>
</html>
