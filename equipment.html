<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="/gradient.css?v=1.1.4" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
  <canvas id="snow-canvas"></canvas>

  <!-- HEADER -->
  <header class="app-header">
    <div class="header-decor">
      <img src="icons/spruce-branch.png" class="spruce-branch" alt="">
    </div>

    <div class="logo-holiday">
      <img src="icons/Logo_New_Year.png" alt="Surpresso Holiday" />
    </div>

    <div class="nav-bar">
      <button class="nav-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
      <button class="nav-btn" onclick="goHome()">üè† –î–æ–º–æ–π</button>
    </div>
  </header>

  <!-- MAIN -->
  <div class="app-main">

    <!-- TEMPLATE FOR PNG -->
    <div id="posterTemplate" style="display:none; padding:24px; width:760px; background:white; font-family:'Segoe UI',sans-serif;">

      <div style="font-size:28px; font-weight:700;">Surpresso Service</div>
      <div style="font-size:18px; margin-top:4px; color:#444;">–ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>

      <hr style="margin:16px 0; border:0; border-top:2px solid #f2c94c;">

      <div id="posterFields" style="font-size:16px; line-height:1.6;"></div>

      <hr style="margin:16px 0; border:0; border-top:2px solid #f2c94c;">

      <div id="posterPhotos" style="display:flex; flex-wrap:wrap; gap:12px;"></div>

      <hr style="margin:16px 0; border:0; border-top:2px solid #f2c94c;">

      <div style="font-size:14px; color:#555;">
        ID –∑–∞—è–≤–∫–∏: <span id="posterID"></span>
      </div>
    </div>

    <!-- STEP 1 -->
    <div id="step1" class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>

      <div class="field select-ios">
        <label>–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
        <select id="equipmentType">
          <option value="">‚Äî —Å–¥–µ–ª–∞–π—Ç–µ –≤—ã–±–æ—Ä ‚Äî</option>
          <option value="grinder">–ì—Ä–∏–Ω–¥–µ—Ä</option>
          <option value="pro-coffee">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞</option>
          <option value="auto-coffee">–ê–≤—Ç–æ–º–∞—Ç –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞</option>
          <option value="osmos">–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤</option>
        </select>
      </div>
      <button class="btn primary wide" onclick="goToStep2()">–î–∞–ª–µ–µ</button>
      <hr style="margin:16px 0; border:0; border-top:1px solid #eee;">

<h3 style="margin:0 0 10px 0;">üîé –û—Ç–∫—Ä—ã—Ç—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>

<div class="field">
  <label>ID / –°–µ—Ä–∏–π–Ω—ã–π / –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ‚Ññ</label>
  <input id="equipLookupId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2P.109 –∏–ª–∏ Juliam's Coffee" />
</div>

<div class="row" style="gap:8px; margin-top:8px;">
  <button class="btn ghost" type="button" onclick="startQrScan()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
  <button class="btn primary" type="button" onclick="openEquipmentByInput()">‚û°Ô∏è –û—Ç–∫—Ä—ã—Ç—å</button>
  <button class="btn ghost" type="button" onclick="searchEquipmentByQuery()">üîç –ù–∞–π—Ç–∏</button>
</div>

<div id="equipSearchMeta" class="muted" style="margin-top:8px; font-size:12px; color:#666;"></div>
<div id="equipSearchResults" style="display:none; margin-top:10px;"></div>
      
<!-- QR SCANNER PANEL -->
<div id="qrScannerCard" class="card" style="display:none; margin-top:12px;">
  <h2>QR –°–∫–∞–Ω–µ—Ä</h2>

  <video id="qrVideo" autoplay playsinline
    style="width:100%; border-radius:12px; background:#000; max-height:360px; object-fit:cover;"></video>

  <canvas id="qrCanvas" style="display:none;"></canvas>

  <div class="row" style="margin-top:10px; gap:8px;">
    <button class="btn ghost" type="button" onclick="stopQrScan()">‚èπ –ó–∞–∫—Ä—ã—Ç—å</button>
    <button class="btn ghost" id="btnQrTorch" type="button" style="display:none" onclick="toggleQrTorch()">üí° –°–≤—ñ—Ç–ª–æ</button>
  </div>

  <div class="muted" style="margin-top:6px; font-size:12px; color:#666;">
    –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∑ ID (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: SP.225)
  </div>
</div>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="card" style="display:none;">
      <h2>–ö–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?</h2>
      <button class="btn primary wide" onclick="selectOwner('client')">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</button>
      <button class="btn ghost wide" onclick="selectOwner('company')" style="margin-top:10px;">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</button>
    </div>

    <!-- CLIENT FORM -->
    <div id="form-client" class="card" style="display:none;">
      <h2 id="clientTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ (–ö–ª–∏–µ–Ω—Ç)</h2>

      <div class="field"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input id="clientName"></div>
      <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="clientPhone" type="text" inputmode="numeric" placeholder="0XXXXXXXXX"></div>
      <div class="field"><label>–ê–¥—Ä–µ—Å / –õ–æ–∫–∞—Ü–∏—è</label><input id="clientLocation"></div>
      <div class="field"><label>–ú–æ–¥–µ–ª—å</label><input id="model"></div>
      <div class="field"><label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label><input id="serial" type="text" placeholder="000343212"></div>
      <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label><input id="problem"></div>
      <div class="field"><label>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è</label><input id="condition"></div>
      <div class="field"><label>–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞</label><input type="date" id="receivedDate"></div>

      <div class="field checkbox-field">
        <label class="checkbox-ios">
          <input type="checkbox" id="isServiceContract">
          <span class="checkbox-ios-slider"></span>
          –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
        </label>
      </div>

      <div class="actions-stack">
        <div class="btn-row">
          <button class="btn-surpresso" id="btnSaveToBase">üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
<span class="muted" id="saveHint"></span>
          <button class="btn-surpresso" onclick="sendToTelegram()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram + Trello</button>
          <button class="btn-surpresso" onclick="openPrintPage()">üñ® –ü–µ—á–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- COMPANY FORM -->
    <div id="form-company" class="card" style="display:none;">
      <h2 id="companyTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ (–ö–æ–º–ø–∞–Ω–∏—è)</h2>

      <div class="field">
        <label>–õ–æ–∫–∞—Ü–∏—è (–∫–∞—Ñ–µ/—Ü–µ—Ö)</label>
        <input id="companyLocation">
      </div>

      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
        <input id="equipmentName">
      </div>

      <div class="field">
        <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä</label>
        <input id="internalNumber" type="text" placeholder="000343212">
      </div>

      <div class="field">
        <label>–ó–∞–¥–∞—á–∞ / –ø—Ä–æ–±–ª–µ–º–∞</label>
        <input id="task">
      </div>

      <div class="field">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <input id="comment">
      </div>

      <div class="field">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="companyDate">
      </div>

      <div class="actions-stack">
        <div class="btn-row">
          <button class="btn-surpresso" id="btnSaveToBase">üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
<span class="muted" id="saveHint"></span>
          <button class="btn-surpresso" onclick="sendToTelegram()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram + Trello</button>
          <button class="btn-surpresso" onclick="openPrintPage()">üñ® –ü–µ—á–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- LIVE CAMERA -->
    <div id="cameraCard" class="card" style="display:none; margin-top:12px;">
      <h2>–ö–∞–º–µ—Ä–∞ (Live)</h2>

      <video id="cameraVideo" autoplay playsinline
        style="width:100%; border-radius:12px; background:#000; max-height:400px; object-fit:cover;"></video>
      <canvas id="cameraCanvas" style="display:none;"></canvas>

      <div class="row" style="margin-top:10px; gap:2px;">
        <button class="btn primary" onclick="startCamera()">‚ñ∂Ô∏è –í–∫–ª</button>
        <button class="btn ghost" onclick="capturePhoto()">üì∏ –§–æ—Ç–æ</button>
        <button class="btn ghost" onclick="stopCamera()">‚èπ –°—Ç–æ–ø</button>
        <button class="btn ghost" onclick="toggleFlash()">üí°–°–≤–µ—Ç</button>
      </div>

      <div id="capturedPhotos" style="margin-top:10px; display:none;"></div>
    </div>

  </div><!-- end main -->

  <script>
    // ============================
// QR -> –æ—Ç–∫—Ä—ã—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ ID
// QR —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ ID (–±–µ–∑ —Å—Å—ã–ª–æ–∫)
// ============================

let qrStream = null;
let qrLoopTimer = null;
let qrTorchOn = false; // ‚úÖ –≤—Å–ø—ã—à–∫–∞


function normalizeEquipId(raw) {
  if (!raw) return "";
  return String(raw)
    .trim()
    .replace(/^https?:\/\/.+?(\?|&|#)id=/i, "") // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    .toUpperCase()                              // –∫–∞–∫ –≤ normalizeId
    .replace(/\s+/g, "")
    .replace(/[^A-Z0-9.\-]/g, "")               // ‚Üê —Ç–æ—á–∫–∏ –∏ –¥–µ—Ñ–∏—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
    .trim();
}

// üî• –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
// –¢—É—Ç –¢–´ –í–´–ë–ò–†–ê–ï–®–¨ –∫—É–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å:
// ‚úÖ –≤–∞—Ä–∏–∞–Ω—Ç 1: –æ—Ç–∫—Ä—ã—Ç—å "–ø–∞—Å–ø–æ—Ä—Ç" –Ω–∞ —Ç–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ (–ª—É—á—à–µ)
// ‚úÖ –≤–∞—Ä–∏–∞–Ω—Ç 2: –æ—Ç–∫—Ä—ã—Ç—å GAS –Ω–∞–ø—Ä—è–º—É—é (–µ—Å–ª–∏ –Ω–∞–¥–æ)
function openEquipmentPageById(id) {
  id = normalizeEquipId(id);
  if (!id) return alert("–ù–µ—Ç ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");

  // ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–Æ: –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–∞—Å–ø–æ—Ä—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –ª–µ–∂–∏—Ç –Ω–∞ —Ç–≤–æ—ë–º Node —Å–µ—Ä–≤–µ—Ä–µ
  // (–Ω–∞–ø—Ä–∏–º–µ—Ä /equip.html?id=... –∏–ª–∏ /passport.html?id=...)
  window.location.href = `equip.html?id=${encodeURIComponent(id)}`;

  // ‚ùó –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—Ç–∫—Ä—ã–≤–∞—Ç—å GAS –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–≤–µ—Ç–∏—Ç—å URL):
  // window.location.href = `${GAS_WEBAPP_URL}?id=${encodeURIComponent(id)}`;
}

// –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å" –≤–æ–∑–ª–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
function openEquipmentByInput() {
  const v = document.getElementById("equipLookupId")?.value || "";
  const id = normalizeEquipId(v);
  if (!id) return alert("–í–≤–µ–¥–∏ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
  openEquipmentPageById(id);
}

// ============================
// SEARCH (–ø–æ –±–∞–∑–µ)
// ============================
let equipSearchTimer = null;

function buildEquipmentTitle_(item) {
  const name = String(item.name || item.model || "").trim();
  if (name) return name;
  return "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ";
}

function buildEquipmentMeta_(item) {
  const parts = [];
  const location = String(item.companyLocation || item.clientLocation || "").trim();
  const clientName = String(item.clientName || "").trim();
  const serial = String(item.serial || "").trim();
  const internal = String(item.internalNumber || "").trim();

  if (location) parts.push(`–õ–æ–∫–∞—Ü–∏—è: ${location}`);
  if (clientName) parts.push(`–ö–ª–∏–µ–Ω—Ç: ${clientName}`);
  if (internal) parts.push(`–í–Ω—É—Ç—Ä. ‚Ññ: ${internal}`);
  if (serial) parts.push(`–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ: ${serial}`);

  return parts.join(" ‚Ä¢ ");
}

function renderEquipmentSearchResults_(items, query) {
  const container = document.getElementById("equipSearchResults");
  const meta = document.getElementById("equipSearchMeta");
  if (!container || !meta) return;

  if (!query) {
    container.style.display = "none";
    container.innerHTML = "";
    meta.textContent = "";
    return;
  }

  meta.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è: ¬´${query}¬ª`;

  container.innerHTML = "";

  if (!items.length) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.padding = "10px 0";
    empty.textContent = "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
    container.appendChild(empty);
    container.style.display = "block";
    return;
  }

  items.forEach(item => {
    const row = document.createElement("div");
    row.style.padding = "10px 12px";
    row.style.border = "1px solid #eee";
    row.style.borderRadius = "10px";
    row.style.marginBottom = "8px";
    row.style.background = "#fff";

    const title = document.createElement("div");
    title.style.fontWeight = "600";
    title.textContent = buildEquipmentTitle_(item);

    const info = document.createElement("div");
    info.style.fontSize = "12px";
    info.style.color = "#666";
    info.style.marginTop = "4px";
    info.textContent = buildEquipmentMeta_(item);

    const idLine = document.createElement("div");
    idLine.style.fontSize = "12px";
    idLine.style.marginTop = "6px";
    idLine.textContent = `ID: ${item.id || "‚Äî"}`;

    const openBtn = document.createElement("button");
    openBtn.className = "btn ghost";
    openBtn.type = "button";
    openBtn.style.marginTop = "8px";
    openBtn.textContent = "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É";
    openBtn.onclick = () => openEquipmentPageById(item.id);

    row.appendChild(title);
    if (info.textContent) row.appendChild(info);
    row.appendChild(idLine);
    row.appendChild(openBtn);
    container.appendChild(row);
  });

  container.style.display = "block";
}

async function searchEquipmentByQuery(options = {}) {
  const { silent = false } = options;
  const input = document.getElementById("equipLookupId");
  const raw = input ? input.value : "";
  const query = String(raw || "").trim();

  if (query.length < 2) {
    renderEquipmentSearchResults_([], "");
    const meta = document.getElementById("equipSearchMeta");
    if (meta) meta.textContent = "–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞";
    if (!silent) {
      return alert("–í–≤–µ–¥–∏ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞");
    }
    return;
  }

  const meta = document.getElementById("equipSearchMeta");
  if (meta) meta.textContent = "–ò—â—É –≤ –±–∞–∑–µ...";

  if (silent && !sessionStorage.getItem("surpresso_pwa_key")) {
    if (meta) meta.textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫.";
    return;
  }

  try {
    const resp = await apiFetch(`/api/equip/search?q=${encodeURIComponent(query)}`);
    if (!resp.ok) {
      const text = await resp.text().catch(() => "");
      throw new Error(text || "search_failed");
    }
    const data = await resp.json();
    renderEquipmentSearchResults_(data.results || [], query);
  } catch (err) {
    console.error(err);
    if (meta) meta.textContent = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
    if (!silent) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫");
    }
  }
}

// ============================
// QR SCAN (BarcodeDetector)
// ============================

async function startQrScan() {
  const card = document.getElementById("qrScannerCard");
  const video = document.getElementById("qrVideo");
  const canvas = document.getElementById("qrCanvas");

  if (!card || !video) return;

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
  card.style.display = "block";

  // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ BarcodeDetector
  if (!("BarcodeDetector" in window)) {
    alert("‚ö†Ô∏è QR —Å–∫–∞–Ω–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.\n–û—Ç–∫—Ä–æ–π –≤ Chrome –Ω–∞ Android –∏–ª–∏ –≤–≤–µ–¥–∏ ID –≤—Ä—É—á–Ω—É—é.");
    return;
  }

  try {
    // –∫–∞–º–µ—Ä–∞
    qrStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });

    video.srcObject = qrStream;
await video.play();

// ‚úÖ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤—Å–ø—ã—à–∫–∏, –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
const track = getQrTrack_();
const caps = track?.getCapabilities ? track.getCapabilities() : {};
const btnTorch = document.getElementById("btnQrTorch");

if (btnTorch) {
  if (caps && caps.torch) {
    btnTorch.style.display = "inline-flex";
    btnTorch.textContent = "üí° –°–≤—ñ—Ç–ª–æ";
  } else {
    btnTorch.style.display = "none";
  }
}


    const detector = new BarcodeDetector({ formats: ["qr_code"] });

    const tick = async () => {
      try {
        if (!video.videoWidth) {
          qrLoopTimer = requestAnimationFrame(tick);
          return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const barcodes = await detector.detect(canvas);

        if (barcodes && barcodes.length) {
          const raw = barcodes[0].rawValue;
          const id = normalizeEquipId(raw);

          if (id) {
            // –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            const input = document.getElementById("equipLookupId");
            if (input) input.value = id;

            // –æ—Å—Ç–∞–Ω–æ–≤–∏–º —Å–∫–∞–Ω–µ—Ä
            stopQrScan();

            // –æ—Ç–∫—Ä–æ–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            openEquipmentPageById(id);
            return;
          }
        }
      } catch (e) {
        // –º–æ–ª—á–∞
      }

      qrLoopTimer = requestAnimationFrame(tick);
    };

    tick();

  } catch (e) {
    console.error(e);
    alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É");
    stopQrScan();
  }
}

function stopQrScan() {
  const card = document.getElementById("qrScannerCard");
  const video = document.getElementById("qrVideo");

  // ‚úÖ torch off + hide btn
  resetQrTorchUI_();

  if (qrLoopTimer) {
    cancelAnimationFrame(qrLoopTimer);
    qrLoopTimer = null;
  }

  if (qrStream) {
    qrStream.getTracks().forEach(t => t.stop());
    qrStream = null;
  }

  if (video) video.srcObject = null;
  if (card) card.style.display = "none";
}

function getQrTrack_() {
  if (!qrStream) return null;
  const tracks = qrStream.getVideoTracks ? qrStream.getVideoTracks() : [];
  return tracks[0] || null;
}

async function toggleQrTorch() {
  const track = getQrTrack_();
  if (!track) return;

  try {
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if (!caps.torch) {
      alert("‚ö†Ô∏è –í—Å–ø—ã—à–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ");
      return;
    }

    qrTorchOn = !qrTorchOn;
    await track.applyConstraints({ advanced: [{ torch: qrTorchOn }] });

    const btn = document.getElementById("btnQrTorch");
    if (btn) btn.textContent = qrTorchOn ? "üí° –°–≤—ñ—Ç–ª–æ: ON" : "üí° –°–≤—ñ—Ç–ª–æ";
  } catch (e) {
    console.error("Torch error:", e);
  }
}

function resetQrTorchUI_() {
  qrTorchOn = false;
  const btn = document.getElementById("btnQrTorch");
  if (btn) {
    btn.textContent = "üí° –°–≤—ñ—Ç–ª–æ";
    btn.style.display = "none";
  }
}

    // =========================================================
    // ‚úÖ AUTH: PWA -> SERVER (x-surpresso-key)
    // =========================================================
    function getPwaKey() {
      let key = sessionStorage.getItem("surpresso_pwa_key");
      if (!key) {
        key = (prompt("–í–≤–µ–¥–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ (PWA Key):") || "b78214820561570fae5f86ba7e62ed078a5e451ac25a35d4b2beec3ac5f097f0").trim();
        if (!key) throw new Error("NO_PWA_KEY");
        sessionStorage.setItem("surpresso_pwa_key", key);
      }
      return key;
    }

    async function apiFetch(url, options = {}) {
      const key = getPwaKey();
      const headers = { ...(options.headers || {}), "x-surpresso-key": key };

      // –µ—Å–ª–∏ —à–ª—ë–º JSON
      if (options.body && !(options.body instanceof FormData)) {
        headers["Content-Type"] = headers["Content-Type"] || "application/json";
      }

      return fetch(url, { ...options, headers });
    }

    // =========================================================
    // ‚úÖ –ï–¥–∏–Ω—ã–π ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (—á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª –¥–ª—è –ø–µ—á–∞—Ç–∏/–æ—Ç–ø—Ä–∞–≤–∫–∏)
    // =========================================================
  function normalizeId(raw) {
  return String(raw || "")
    .trim()
    .toUpperCase()
    .replace(/\s+/g, "")
    .replace(/[^A-Z0-9.\-]/g, ""); // ‚úÖ —Ç–æ—á–∫—É –∏ –¥–µ—Ñ–∏—Å –ù–ï –≤—ã—Ä–µ–∑–∞–µ–º
}

function getOrCreateEquipId() {
  const owner = localStorage.getItem("equip_owner") || "client";

  let rawId = "";
  if (owner === "company") {
    rawId = document.getElementById("internalNumber")?.value || "";
  } else {
    rawId = document.getElementById("serial")?.value || "";
  }

  // ‚úÖ –∫–ª—é—á —Ç–µ–∫—É—â–µ–π —Ñ–æ—Ä–º—ã (—á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ø—Ä–∏—ë–º—ã)
  const rawKey = `${owner}:${String(rawId).trim()}`;

  const storedId = localStorage.getItem("equip_current_id") || "";
  const storedKey = localStorage.getItem("equip_current_key") || "";

  // ‚úÖ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π ID —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ –≤–≤–æ–¥
  if (storedId && storedKey === rawKey) return storedId;

  // ‚úÖ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π ID
  let id = normalizeId(rawId);

  // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Ñ–æ–ª–±—ç–∫
  if (!id) id = "SURP-" + Date.now().toString().slice(-8);

  localStorage.setItem("equip_current_id", id);
  localStorage.setItem("equip_current_key", rawKey);

  return id;
}

    // =========================================================
    // PRINT PAGE
    // =========================================================
    function openPrintPage() {
      const owner = localStorage.getItem("equip_owner");
      const type = localStorage.getItem("equip_type");

      const v = (id) => document.getElementById(id)?.value?.trim() || "";

      const typeMap = {
        "grinder": "–ì—Ä—ñ–Ω–¥–µ—Ä",
        "pro-coffee": "–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –∫–∞–≤–æ–º–∞—à–∏–Ω–∞",
        "auto-coffee": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–∞–≤–æ–º–∞—à–∏–Ω–∞",
        "osmos": "–°–∏—Å—Ç–µ–º–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –≤–æ–¥–∏"
      };

      const card = {
        id: getOrCreateEquipId(),
        owner,
        type,
        typeText: typeMap[type] || type
      };

      if (owner === "client") {
        card.clientName = v("clientName");
        card.clientPhone = v("clientPhone");
        card.clientLocation = v("clientLocation");
        card.model = v("model");
        card.serial = v("serial");
        card.problem = v("problem");
        card.condition = v("condition");
        card.receivedDate = v("receivedDate");
      } else {
        card.companyLocation = v("companyLocation");
        card.name = v("equipmentName");
        card.internalNumber = v("internalNumber");
        card.task = v("task");
        card.comment = v("comment");
        card.companyDate = v("companyDate");
      }

      const isContract = document.getElementById("isServiceContract");
      card.isContract = isContract ? !!isContract.checked : false;

      localStorage.setItem("last_equipment_card", JSON.stringify(card));

      const file = (owner === "company") ? "company-print.html" : "print.html";
      window.open(file, "_blank");
    }

    // =========================================================
    // UTIL
    // =========================================================
    const value = (id) => document.getElementById(id)?.value?.trim() || "";

    // =========================================================
    // NAVIGATION
    // =========================================================
    const stepHistory = [];

    function showStep(id) {
      ["step1", "step2", "form-client", "form-company"].forEach(s => {
        const el = document.getElementById(s);
        if (el) el.style.display = "none";
      });

      document.getElementById(id).style.display = "block";
      if (stepHistory.at(-1) !== id) stepHistory.push(id);
    }

    function goBack() {
      if (stepHistory.length <= 1) return goHome();
      stepHistory.pop();
      showStep(stepHistory.at(-1));
    }

    function goHome() {
      window.location.href = "index.html";
    }

    // =========================================================
    // STEPS
    // =========================================================
    function goToStep2() {
      const type = value("equipmentType");
      if (!type) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø");

      localStorage.setItem("equip_type", type);
      showStep("step2");
    }

    function selectOwner(owner) {
      localStorage.setItem("equip_owner", owner);

      const eqType = localStorage.getItem("equip_type");
      const eqName = mapEquipmentType(eqType);

      const clientTitle = document.getElementById("clientTitle");
      if (clientTitle) clientTitle.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ (${mapOwner("client")}) ‚Äî ${eqName}`;

      const companyTitle = document.getElementById("companyTitle");
      if (companyTitle) companyTitle.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ (${mapOwner("company")}) ‚Äî ${eqName}`;

      if (owner === "client") showStep("form-client");
      else showStep("form-company");

      document.getElementById("cameraCard").style.display = "block";
    }

    // =========================================================
    // CAMERA
    // =========================================================
    let cameraStream = null;
    let capturedPhotos = [];
    let flashOn = false;

    async function startCamera() {
      if (cameraStream) return;

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });

        const video = document.getElementById("cameraVideo");
        video.srcObject = cameraStream;
        await video.play();

      } catch (e) {
        console.error(e);
        alert("–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏");
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
    }

    function toggleFlash() {
      if (!cameraStream) {
        alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞");
        return;
      }
      const track = cameraStream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.torch) {
        flashOn = !flashOn;
        track.applyConstraints({ advanced: [{ torch: flashOn }] });
      } else {
        alert("‚ö†Ô∏è –í—Å–ø—ã—à–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ");
      }
    }

    function capturePhoto() {
      const video = document.getElementById("cameraVideo");
      const canvas = document.getElementById("cameraCanvas");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const dataURL = canvas.toDataURL("image/jpeg", 1.0);
      capturedPhotos.push(dataURL);
      renderCapturedPhotos();
    }

    function renderCapturedPhotos() {
      const block = document.getElementById("capturedPhotos");
      block.innerHTML = "";

      if (!capturedPhotos.length) {
        block.style.display = "none";
        return;
      }
      block.style.display = "block";

      capturedPhotos.forEach((src, idx) => {
        const wrap = document.createElement("div");
        wrap.style.position = "relative";
        wrap.style.marginBottom = "10px";

        const img = document.createElement("img");
        img.src = src;
        img.style.width = "100%";
        img.style.borderRadius = "12px";
        img.style.objectFit = "contain";

        const del = document.createElement("button");
        del.className = "btn primary";
        del.textContent = "–£–¥–∞–ª–∏—Ç—å";
        del.style.position = "absolute";
        del.style.bottom = "8px";
        del.style.right = "8px";
        del.style.fontSize = "11px";

        del.onclick = () => {
          capturedPhotos.splice(idx, 1);
          renderCapturedPhotos();
        };

        wrap.appendChild(img);
        wrap.appendChild(del);
        block.appendChild(wrap);
      });
    }

    // =========================================================
    // MAPPERS
    // =========================================================
    function mapEquipmentType(code) {
      switch (code) {
        case "grinder": return "–ì—Ä–∏–Ω–¥–µ—Ä";
        case "pro-coffee": return "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞";
        case "auto-coffee": return "–ê–≤—Ç–æ–º–∞—Ç –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞";
        case "osmos": return "–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤";
        default: return code;
      }
    }

    function mapOwner(code) {
      switch (code) {
        case "client": return "–ö–ª–∏–µ–Ω—Ç";
        case "company": return "–ö–æ–º–ø–∞–Ω–∏—è Surpresso";
        default: return code;
      }
    }

    // =========================================================
    // PNG GENERATION
    // =========================================================
    async function generatePNG() {
      const owner = localStorage.getItem("equip_owner");
      const type = localStorage.getItem("equip_type");

      const fields = [];
      const add = (label, val) => fields.push(`<div><b>${label}</b> ${val || "-"}</div>`);

      add("–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:", mapEquipmentType(type));
      add("–í–ª–∞–¥–µ–ª–µ—Ü:", mapOwner(owner));

      if (owner === "client") {
        add("–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:", value("clientName"));
        add("–¢–µ–ª–µ—Ñ–æ–Ω:", value("clientPhone"));
        add("–ê–¥—Ä–µ—Å:", value("clientLocation"));
        add("–ú–æ–¥–µ–ª—å:", value("model"));
        add("–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:", value("serial"));
        add("–ü—Ä–æ–±–ª–µ–º–∞:", value("problem"));
        add("–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è:", value("condition"));
        add("–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞:", value("receivedDate"));
      } else {
        add("–õ–æ–∫–∞—Ü–∏—è:", value("companyLocation"));
        add("–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:", value("equipmentName"));
        add("–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä:", value("internalNumber"));
        add("–ó–∞–¥–∞—á–∞ / –ø—Ä–æ–±–ª–µ–º–∞:", value("task"));
        add("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", value("comment"));
        add("–î–∞—Ç–∞:", value("companyDate"));
      }

      document.getElementById("posterFields").innerHTML = fields.join("");

      const photoBox = document.getElementById("posterPhotos");
      photoBox.innerHTML = "";
      capturedPhotos.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.style.width = "180px";
        img.style.borderRadius = "12px";
        img.style.border = "2px solid #f2c94c";
        img.style.objectFit = "cover";
        photoBox.appendChild(img);
      });

      const id = getOrCreateEquipId();
      document.getElementById("posterID").textContent = id;

      const tmpl = document.getElementById("posterTemplate");
      tmpl.style.display = "block";

      const canvas = await html2canvas(tmpl, { scale: 2 });
      tmpl.style.display = "none";

      const url = canvas.toDataURL("image/png");

      function sanitize(s) {
        return (s || "")
          .trim()
          .replace(/\s+/g, "-")
          .replace(/[^a-zA-Z0-9–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–Ñ—î“ê“ë\-]/g, "");
      }

      let fn = "Surpresso_Equipment";
      if (owner === "client") fn = `${sanitize(value("clientName"))}_${sanitize(value("model"))}`;
      else fn = `${sanitize(value("companyLocation"))}_${sanitize(value("equipmentName"))}`;

      const a = document.createElement("a");
      a.href = url;
      a.download = fn + ".png";
      a.click();
    }

    // =========================================================
    // ‚úÖ SEND TO SERVER (TG + Trello + later registry via server)
    // =========================================================
    async function sendToTelegram() {
      const owner = localStorage.getItem("equip_owner");
      const type = localStorage.getItem("equip_type");

      let card = { owner, type };
      card.id = getOrCreateEquipId();

      if (owner === "client") {
        card.clientName = value("clientName");
        card.clientPhone = String(clientPhone.value || "").trim();
        card.clientLocation = value("clientLocation");
        card.model = value("model");
        card.serial = String(document.getElementById("serial").value || "").trim();
        card.problem = value("problem");
        card.condition = value("condition");
        card.receivedDate = value("receivedDate");
      } else {
        card.companyLocation = value("companyLocation");
        card.name = value("equipmentName");
        card.internalNumber = value("internalNumber");
        card.task = value("task");
        card.comment = value("comment");
        card.companyDate = value("companyDate");
      }
     
      const isContract = document.getElementById("isServiceContract");
      card.isContract = isContract ? !!isContract.checked : false;

      const photos = [...capturedPhotos];

      if (photos.length === 0) {
        if (!confirm("–ù–µ—Ç —Ñ–æ—Ç–æ! –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç?")) return;
      }

      try {
        const resp = await apiFetch("/send-equipment", {
          method: "POST",
          body: JSON.stringify({ card, photos })
        });

        if (!resp.ok) {
          const t = await resp.text().catch(() => "");
          throw new Error("Server error: " + t.slice(0, 160));
        }

        alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram –∏ —Å–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ Trello ‚úÖ");

        // –æ—á–∏—Å—Ç–∫–∞ UI
        capturedPhotos.length = 0;
        renderCapturedPhotos();
        stopCamera();
        localStorage.removeItem("equip_current_id");
        localStorage.removeItem("equip_current_key");

        
        

      } catch (err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚ùå");
      }
    }

    // =========================================================
    // üéÑ SNOW EFFECT
    // =========================================================
    (function startSnow() {
      const canvas = document.getElementById("snow-canvas");
      if (!canvas) return;

      const ctx = canvas.getContext("2d");
      let w, h;
      let flakes = [];

      function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resize);
      resize();

      const FLAKE_COUNT = Math.min(160, Math.floor(w / 7));

      function createFlake(x = Math.random() * w, y = Math.random() * h) {
        return {
          x, y,
          r: Math.random() * 3 + 1,
          vy: Math.random() * 0.8 + 0.4,
          vx: Math.random() * 0.6 - 0.3
        };
      }
      for (let i = 0; i < FLAKE_COUNT; i++) flakes.push(createFlake());

      function update() {
        flakes.forEach(f => {
          f.y += f.vy;
          f.x += f.vx;
          f.vx *= 0.98;
          f.vy = Math.min(f.vy + 0.01, 1.6);

          if (f.y > h) {
            f.y = -5;
            f.x = Math.random() * w;
            f.vx = Math.random() * 0.6 - 0.3;
            f.vy = Math.random() * 0.8 + 0.4;
          }
        });
      }

      function draw() {
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        ctx.beginPath();
        flakes.forEach(f => {
          ctx.moveTo(f.x, f.y);
          ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        });
        ctx.fill();
        update();
      }

      function blast(x, y) {
        flakes.forEach(f => {
          const dx = f.x - x;
          const dy = f.y - y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 120) {
            const force = (120 - dist) / 120;
            f.vx += dx * 0.04 * force;
            f.vy += dy * 0.04 * force;
          }
        });
      }

      canvas.addEventListener("click", e => blast(e.clientX, e.clientY));
      canvas.addEventListener("touchstart", e => {
        const t = e.touches[0];
        blast(t.clientX, t.clientY);
      });

      (function loop() {
        draw();
        requestAnimationFrame(loop);
      })();
    })();
document.getElementById("btnSaveToBase").onclick = saveToBaseOnly;

async function saveToBaseOnly() {
  const card = collectCardFromForm(); // —Ç–≤–æ—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª—è —Ñ–æ—Ä–º—ã

  if (!card.id) return alert("–ù–µ–º–∞—î ID –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è");
  if (!card.owner) return alert("–í–∏–±–µ—Ä–∏ –≤–ª–∞—Å–Ω–∏–∫–∞");
  if (!card.type) return alert("–í–∏–±–µ—Ä–∏ —Ç–∏–ø");

  // –°—Ç–∞—Ç—É—Å –¥–µ—Ñ–æ–ª—Ç
  if (!card.status) {
    card.status = (card.owner === "company") ? "–ü—Ä–∏–µ—Ö–∞–ª–æ –ø–æ—Å–ª–µ –∞—Ä–µ–Ω–¥—ã" : "–ü—Ä–∏–π–Ω—è—Ç–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç";
  }

  const hint = document.getElementById("saveHint");
  hint.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –≤ –±–∞–∑—É...";

  try {
    const resp = await fetch("/api/equip/create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...headersWithKey() // –∫–∞–∫ —É —Ç–µ–±—è —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ
      },
      body: JSON.stringify({ card })
    });

    const out = await resp.json();
    if (!out.ok) throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞");

    hint.textContent = "‚úÖ –î–æ–¥–∞–Ω–æ –≤ –±–∞–∑—É";
    setTimeout(() => hint.textContent = "", 2500);

    // –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –ø–∞—Å–ø–æ—Ä—Ç
    // location.href = `equip.html?id=${encodeURIComponent(card.id)}`;

  } catch (e) {
    hint.textContent = "";
    alert("‚ùå " + e.message);
  }
}
    // =========================================================
// ‚úÖ SAVE TO BASE ONLY (–±–µ–∑ TG –∏ Trello)
// =========================================================

// —Ç–µ–ª–µ—Ñ–æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É (0 –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç)
function normalizePhone(raw) {
  const s = String(raw || "").trim();
  if (!s) return "";
  return s.replace(/[^\d+]/g, "");
}

// ‚úÖ —Å–±–æ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ —Ç–≤–æ–∏—Ö –ø–æ–ª–µ–π (–∏–º–µ–Ω–Ω–æ —Ç–≤–æ–∏—Ö id)
function collectCardFromForm() {
  const owner = localStorage.getItem("equip_owner") || "";      // client / company
  const type = localStorage.getItem("equip_type") || "";        // grinder / pro-coffee / ...

  // ID –¥–ª—è –±–∞–∑—ã:
  // company -> internalNumber
  // client  -> serial
  let idRaw = "";
  if (owner === "company") idRaw = value("internalNumber");
  if (owner === "client")  idRaw = value("serial");

  const card = {
    id: normalizeEquipId(idRaw),
    owner,
    type,
    isContract: !!document.getElementById("isServiceContract")?.checked,

    // client
    clientName: value("clientName"),
    clientPhone: normalizePhone(value("clientPhone")),
    clientLocation: value("clientLocation"),
    model: value("model"),
    serial: normalizeEquipId(value("serial")),
    problem: value("problem"),

    // company
    companyLocation: value("companyLocation"),
    name: value("equipmentName"),
    internalNumber: normalizeEquipId(value("internalNumber")),
    task: value("task"),
    comment: value("comment"),

    actor: "" // –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ
  };

  // —á–∏—Å—Ç–∏–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  Object.keys(card).forEach(k => {
    if (card[k] === "") delete card[k];
  });

  return card;
}

async function saveToBaseOnly() {
  const card = collectCardFromForm();

  if (!card.owner) return alert("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ (–∫–ª—ñ—î–Ω—Ç/–∫–æ–º–ø–∞–Ω—ñ—è)");
  if (!card.type) return alert("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä–∏ —Ç–∏–ø –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è");
  if (!card.id) return alert("–î–ª—è –±–∞–∑–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω ID. –í–≤–µ–¥–∏ –°–µ—Ä—ñ–π–Ω–∏–π –∞–±–æ –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ‚Ññ");

  // ‚úÖ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–í–ê–ñ–ù–û: —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–æ–º –∫–∞–∫ –≤ GAS)
  if (!card.status) {
    card.status = (card.owner === "company") ? "–ü—Ä–∏–µ—Ö–∞–ª–æ –ø–æ—Å–ª–µ –∞—Ä–µ–Ω–¥—ã" : "–ü—Ä–∏–π–Ω—è—Ç–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç";
  }

  // ‚úÖ —Ñ–æ—Ç–æ –±–µ—Ä—ë–º –æ—Ç—Å—é–¥–∞ (—Ç–æ, —á—Ç–æ —Å–Ω—è–ª –∫–∞–º–µ—Ä–æ–π / –≤—ã–±—Ä–∞–ª –∏–∑ –ø–∞–º—è—Ç–∏)
  const photos = Array.isArray(capturedPhotos) ? [...capturedPhotos] : [];

  // –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π (–∏—Ö –¥–≤–µ ‚Äî –∫–ª–∏–µ–Ω—Ç/–∫–æ–º–ø–∞–Ω–∏—è)
  const hintEls = document.querySelectorAll("#saveHint");
  hintEls.forEach(h => h.textContent = photos.length
    ? `–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –≤ –±–∞–∑—É... (—Ñ–æ—Ç–æ: ${photos.length})`
    : "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –≤ –±–∞–∑—É..."
  );

  try {
    // ‚úÖ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º card + photos
    const resp = await apiFetch("/api/equip/create", {
      method: "POST",
      body: JSON.stringify({ card, photos })
    });

    const out = await resp.json();
    if (!out.ok) throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞");

    hintEls.forEach(h => h.textContent =
      photos.length ? "‚úÖ –î–æ–¥–∞–Ω–æ –≤ –±–∞–∑—É + —Ñ–æ—Ç–æ" : "‚úÖ –î–æ–¥–∞–Ω–æ –≤ –±–∞–∑—É"
    );
    setTimeout(() => hintEls.forEach(h => h.textContent = ""), 2000);

    // ‚úÖ –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ç–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–∞–∑—É
    // (–µ—Å–ª–∏ –ù–ï —Ö–æ—á–µ—à—å ‚Äî –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π)
    capturedPhotos.length = 0;
    if (typeof renderCapturedPhotos === "function") renderCapturedPhotos();
    localStorage.removeItem("equip_current_id");

    // –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –ø–∞—Å–ø–æ—Ä—Ç
    // location.href = `equip.html?id=${encodeURIComponent(card.id)}`;

  } catch (e) {
    console.error(e);
    hintEls.forEach(h => h.textContent = "");
    alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞"));
  }
}

// ‚úÖ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É"
function bindSaveButtons() {
  const btns = document.querySelectorAll("#btnSaveToBase");
  btns.forEach(btn => btn.onclick = saveToBaseOnly);
}

    // =========================================================
    // INIT
    // =========================================================
window.addEventListener("load", () => {
  const today = new Date().toISOString().split("T")[0];
  const companyDate = document.getElementById("companyDate");
  const receivedDate = document.getElementById("receivedDate");
  if (companyDate) companyDate.value = today;
  if (receivedDate) receivedDate.value = today;

  const equipLookupInput = document.getElementById("equipLookupId");
  if (equipLookupInput) {
    equipLookupInput.addEventListener("input", () => {
      const query = String(equipLookupInput.value || "").trim();
      if (equipSearchTimer) clearTimeout(equipSearchTimer);

      if (query.length < 2) {
        renderEquipmentSearchResults_([], "");
        return;
      }

      equipSearchTimer = setTimeout(() => {
        searchEquipmentByQuery({ silent: true });
      }, 400);
    });

    equipLookupInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        searchEquipmentByQuery();
      }
    });
  }

  bindSaveButtons();
  showStep("step1");
});

  </script>
</body>
</html>

