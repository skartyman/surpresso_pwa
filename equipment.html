<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</title>
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
<body>
<canvas id="snow-canvas"></canvas>
<!-- HEADER -->
<canvas id="snow-canvas"></canvas>
  <header class="app-header">
  <div class="header-decor">
  <img src="icons/spruce-branch.png" class="spruce-branch" alt="">
</div>
        <div class="logo-holiday">
  <img src="icons/Logo_New_Year.png" alt="Surpresso Holiday" />
</div>

  <div class="nav-bar">
    <button class="nav-btn" onclick="goBack()">‚¨Ö –ù–∞–∑–∞–¥</button>
    <button class="nav-btn" onclick="goHome()">üè† –î–æ–º–æ–π</button>
  </div>
</header>

<!-- MAIN -->
<div class="app-main">

<!-- TEMPLATE FOR PNG -->
<div id="posterTemplate" style="display:none; padding:24px; width:760px; background:white; font-family:'Segoe UI',sans-serif;">
  
  <div style="font-size:28px; font-weight:700;">Surpresso Service</div>
  <div style="font-size:18px; margin-top:4px; color:#444;">–ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>

  <hr style="margin:16px 0; border:0; border-top:2px solid #f2c94c;">

  <div id="posterFields" style="font-size:16px; line-height:1.6;"></div>

  <hr style="margin:16px 0; border:0; border-top:2px solid #f2c94c;">

  <div id="posterPhotos" style="display:flex; flex-wrap:wrap; gap:12px;"></div>

  <hr style="margin:16px 0; border:0; border-top:2px solid #f2c94c;">

  <div style="font-size:14px; color:#555;">
    ID –∑–∞—è–≤–∫–∏: <span id="posterID"></span>
  </div>

</div>

<!-- STEP 1 -->
<div id="step1" class="card">
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>

   <div class="field select-ios">
  <label>–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
  <select id="equipmentType">
    <option value="">‚Äî —Å–¥–µ–ª–∞–π—Ç–µ –≤—ã–±–æ—Ä ‚Äî</option>
    <option value="grinder">–ì—Ä–∏–Ω–¥–µ—Ä</option>
    <option value="pro-coffee">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞</option>
    <option value="auto-coffee">–ê–≤—Ç–æ–º–∞—Ç –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞</option>
	<option value="osmos">–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤</option>
  </select>
</div>


    <button class="btn primary wide" onclick="goToStep2()">–î–∞–ª–µ–µ</button>
</div>

<!-- STEP 2 -->
<div id="step2" class="card" style="display:none;">
    <h2>–ö–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?</h2>

    <button class="btn primary wide" onclick="selectOwner('client')">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</button>
    <button class="btn ghost wide" onclick="selectOwner('company')" style="margin-top:10px;">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</button>
</div>

<!-- CLIENT FORM -->
<div id="form-client" class="card" style="display:none;">
  <h2 id="clientTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ (–ö–ª–∏–µ–Ω—Ç)</h2>

  <div class="field"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input id="clientName"></div>
  <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="clientPhone"></div>
  <div class="field"><label>–ê–¥—Ä–µ—Å / –õ–æ–∫–∞—Ü–∏—è</label><input id="clientLocation"></div>
  <div class="field"><label>–ú–æ–¥–µ–ª—å</label><input id="model"></div>
  <div class="field"><label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label><input id="serial"></div>
  <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label><input id="problem"></div>
  <div class="field"><label>–í–Ω–µ—à–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è</label><input id="condition"></div>
  <div class="field"><label>–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞</label><input type="date" id="receivedDate"></div>
  <div class="field checkbox-field"><label class="checkbox-ios"><input type="checkbox" id="isServiceContract"><span class="checkbox-ios-slider"></span>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</label></div>
  <div class="actions-stack">
  <div class="btn-row">

  <button class="btn-surpresso" onclick="generatePNG()">
    üñº –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç—É
  </button>

  <button class="btn-surpresso" onclick="sendToTelegram()">
    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram + Trello
  </button>

  <button class="btn-surpresso" onclick="openPrintPage()">
    üñ® –ü–µ—á–∞—Ç—å
  </button>

</div>


  </div>
</div>

<!-- COMPANY FORM -->
<div id="form-company" class="card" style="display:none;">
  <h2 id="companyTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ (–ö–æ–º–ø–∞–Ω–∏—è)</h2>

  <div class="field">
    <label>–õ–æ–∫–∞—Ü–∏—è (–∫–∞—Ñ–µ/—Ü–µ—Ö)</label>
    <input id="companyLocation">
  </div>

  <div class="field">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
    <input id="equipmentName">
  </div>

  <div class="field">
    <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä</label>
    <input id="internalNumber">
  </div>

  <div class="field">
    <label>–ó–∞–¥–∞—á–∞ / –ø—Ä–æ–±–ª–µ–º–∞</label>
    <input id="task">
  </div>

  <div class="field">
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <input id="comment">
  </div>

  <div class="field">
    <label>–î–∞—Ç–∞</label>
    <input type="date" id="companyDate">
  </div>

  <div class="actions-stack">
    <div class="btn-row">

  <button class="btn-surpresso" onclick="generatePNG()">
    üñº –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç—É
  </button>

  <button class="btn-surpresso" onclick="sendToTelegram()">
    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram + Trello
  </button>

  <button class="btn-surpresso" onclick="openPrintPage()">
    üñ® –ü–µ—á–∞—Ç—å
  </button>

</div>


  </div>
</div>


<!-- LIVE CAMERA -->
<div id="cameraCard" class="card" style="display:none; margin-top:12px;">
    <h2>–ö–∞–º–µ—Ä–∞ (Live)</h2>

    <video id="cameraVideo" autoplay playsinline style="width:100%; border-radius:12px; background:#000; max-height:400px; object-fit:cover;"></video>
    <canvas id="cameraCanvas" style="display:none;"></canvas>

    <div class="row" style="margin-top:10px; gap:2px;">
  <button class="btn primary" onclick="startCamera()">‚ñ∂Ô∏è –í–∫–ª</button>
  <button class="btn ghost" onclick="capturePhoto()">üì∏ –§–æ—Ç–æ</button>
  <button class="btn ghost" onclick="stopCamera()">‚èπ –°—Ç–æ–ø</button>
  <button class="btn ghost" onclick="toggleFlash()">üí°–°–≤–µ—Ç</button>
    </div>

    <div id="capturedPhotos" style="margin-top:10px; display:none;"></div>
</div>

</div> <!-- end main -->

<script>
function openPrintPage() {
  const owner = localStorage.getItem("equip_owner");
  const type = localStorage.getItem("equip_type");

  // –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
  const v = (id) => {
    const el = document.getElementById(id);
    return el ? el.value.trim() : "";
  };

  // —á–µ–ª–æ–≤–µ–∫–æ-–ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç —Ç–∏–ø–∞
  const typeMap = {
    "grinder": "–ì—Ä—ñ–Ω–¥–µ—Ä",
    "pro-coffee": "–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –∫–∞–≤–æ–º–∞—à–∏–Ω–∞",
    "auto-coffee": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–∞–≤–æ–º–∞—à–∏–Ω–∞",
	"osmos": "–°–∏—Å—Ç–µ–º–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –≤–æ–¥–∏"
  };

  const card = {
    id: "SURP-" + Date.now().toString().slice(-6),
    owner,
    type,
    typeText: typeMap[type] || type
  };

  if (owner === "client") {
    card.clientName      = v("clientName");
    card.clientPhone     = v("clientPhone");
    card.clientLocation  = v("clientLocation");
    card.model           = v("model");
    card.serial          = v("serial");
    card.problem         = v("problem");
    card.condition       = v("condition");
    card.receivedDate    = v("receivedDate");

  } else {
    card.companyLocation = v("companyLocation");
    card.name            = v("equipmentName");
    card.internalNumber  = v("internalNumber");
    card.task            = v("task");
    card.comment         = v("comment");
    card.companyDate     = v("companyDate");
  }
  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫ "–∫–ª—ñ—î–Ω—Ç –∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º"
  const isContract = document.getElementById("isServiceContract");
  card.isContract = isContract ? !!isContract.checked : false;

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ø–µ—á–∞—Ç–∏
  localStorage.setItem("last_equipment_card", JSON.stringify(card));

  // üëâ –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ñ–∞–π–ª –ø–µ—á–∞—Ç–∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å
  const file = (owner === "company")
      ? "company-print.html"
      : "print.html";

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–ª–∞–Ω–∫–∞
  window.open(file, "_blank");
}

/* ===================================================================
   UTIL
=================================================================== */
const value = (id) => document.getElementById(id)?.value?.trim() || "";

/* ===================================================================
   NAVIGATION
=================================================================== */
const stepHistory = [];

function showStep(id) {
    ["step1","step2","form-client","form-company"].forEach(s => {
        const el = document.getElementById(s);
        if (el) el.style.display = "none";
    });

    document.getElementById(id).style.display = "block";

    if (stepHistory.at(-1) !== id) stepHistory.push(id);
}

function goBack() {
    if (stepHistory.length <= 1) return goHome();
    stepHistory.pop();
    showStep(stepHistory.at(-1));
}

function goHome() {
    window.location.href = "index.html";
}

/* ===================================================================
   STEPS
=================================================================== */
function goToStep2() {
    const type = value("equipmentType");
    if (!type) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø");

    localStorage.setItem("equip_type", type);
    showStep("step2");
}

function selectOwner(owner) {
    localStorage.setItem("equip_owner", owner);

    const eqType = localStorage.getItem("equip_type");
    const eqName = mapEquipmentType(eqType);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const clientTitle = document.getElementById("clientTitle");
    if (clientTitle) {
        clientTitle.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ (${mapOwner("client")}) ‚Äî ${eqName}`;
    }

    const companyTitle = document.getElementById("companyTitle");
    if (companyTitle) {
        companyTitle.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ (${mapOwner("company")}) ‚Äî ${eqName}`;
    }

    if (owner === "client") showStep("form-client");
    else showStep("form-company");

    document.getElementById("cameraCard").style.display = "block";
}

/* ===================================================================
   CAMERA ‚Äî HIGH QUALITY CAPTURE (–±–µ–∑ Blob)
=================================================================== */
let cameraStream = null;
let capturedPhotos = [];

// –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —Å –≤—ã—Å–æ–∫–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º
async function startCamera() {
    if (cameraStream) return;

    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { ideal: "environment" },
                width: { ideal: 1920 },      // FullHD
                height: { ideal: 1080 }      // –º–æ–∂–Ω–æ 4096 √ó 2160 –¥–ª—è 4K
            }
        });

        const video = document.getElementById("cameraVideo");
        video.srcObject = cameraStream;
        await video.play();

    } catch (e) {
        console.error(e);
        alert("–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏");
    }
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
    }
}
let flashOn = false;

function toggleFlash() {
  if (!cameraStream) {
    alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞");
    return;
  }

  const track = cameraStream.getVideoTracks()[0];
  const capabilities = track.getCapabilities();

  if (capabilities.torch) {
    flashOn = !flashOn;
    track.applyConstraints({
      advanced: [{ torch: flashOn }]
    });
  } else {
    alert("‚ö†Ô∏è –í—Å–ø—ã—à–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ");
  }
}
/* ===================================================================
   –°–™–ï–ú–ö–ê –§–û–¢–û –í –ú–ê–ö–°. –ö–ê–ß–ï–°–¢–í–ï (JPEG 100%, dataURL)
=================================================================== */
function capturePhoto() {
    const video = document.getElementById("cameraVideo");
    const canvas = document.getElementById("cameraCanvas");

    // ‚ùó –ë–µ—Ä—ë–º —Ä–µ–∞–ª—å–Ω–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    // ‚ùó JPEG 100% –∫–∞—á–µ—Å—Ç–≤–∞, –±–µ–∑ –ø–æ—Ç–µ—Ä—å
    const dataURL = canvas.toDataURL("image/jpeg", 1.0);

    capturedPhotos.push(dataURL);
    renderCapturedPhotos();
}

/* ===================================================================
   –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –§–û–¢–û (–±–µ–∑ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞)
=================================================================== */
function renderCapturedPhotos() {
    const block = document.getElementById("capturedPhotos");
    block.innerHTML = "";

    if (!capturedPhotos.length) {
        block.style.display = "none";
        return;
    }

    block.style.display = "block";

    capturedPhotos.forEach((src, idx) => {
        const wrap = document.createElement("div");
        wrap.style.position = "relative";
        wrap.style.marginBottom = "10px";

        const img = document.createElement("img");
        img.src = src;
        img.style.width = "100%";        // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img.style.borderRadius = "12px";
        img.style.objectFit = "contain"; // ‚ùó –Ω–µ —Ä–µ–∂–µ–º —Ñ–æ—Ç–æ

        const del = document.createElement("button");
        del.className = "btn primary";
        del.textContent = "–£–¥–∞–ª–∏—Ç—å";
        del.style.position = "absolute";
        del.style.bottom = "8px";
        del.style.right = "8px";
        del.style.fontSize = "11px";

        del.onclick = () => {
            capturedPhotos.splice(idx, 1);
            renderCapturedPhotos();
        };

        wrap.appendChild(img);
        wrap.appendChild(del);
        block.appendChild(wrap);
    });
}

//–§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Åompany - Surpresso
function mapEquipmentType(code) {
  switch (code) {
    case "grinder": return "–ì—Ä–∏–Ω–¥–µ—Ä";
    case "pro-coffee": return "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞";
    case "auto-coffee": return "–ê–≤—Ç–æ–º–∞—Ç –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞";
	case "osmos": return "–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤";
    default: return code;
  }
}

function mapOwner(code) {
  switch (code) {
    case "client": return "–ö–ª–∏–µ–Ω—Ç";
    case "company": return "–ö–æ–º–ø–∞–Ω–∏—è Surpresso";
    default: return code;
  }
}

/* ===================================================================
   PNG GENERATION
=================================================================== */
async function generatePNG() {

    const owner = localStorage.getItem("equip_owner");
    const type  = localStorage.getItem("equip_type");

    const fields = [];
    const add = (label,val)=>fields.push(`<div><b>${label}</b> ${val||"-"}</div>`);

    add("–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:", mapEquipmentType(type));
	add("–í–ª–∞–¥–µ–ª–µ—Ü:", mapOwner(owner));


    if (owner === "client") {

        add("–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:", value("clientName"));
        add("–¢–µ–ª–µ—Ñ–æ–Ω:", value("clientPhone"));
        add("–ê–¥—Ä–µ—Å:", value("clientLocation"));
        add("–ú–æ–¥–µ–ª—å:", value("model"));
        add("–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:", value("serial"));
        add("–ü—Ä–æ–±–ª–µ–º–∞:", value("problem"));
        add("–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è:", value("condition"));
        add("–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞:", value("receivedDate"));

    } else {

        add("–õ–æ–∫–∞—Ü–∏—è:", value("companyLocation"));
        add("–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:", value("equipmentName"));
        add("–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä:", value("internalNumber"));
        add("–ó–∞–¥–∞—á–∞ / –ø—Ä–æ–±–ª–µ–º–∞:", value("task"));
        add("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", value("comment"));
        add("–î–∞—Ç–∞:", value("companyDate"));
    }

    document.getElementById("posterFields").innerHTML = fields.join("");

    /* PHOTOS */
    const photoBox = document.getElementById("posterPhotos");
    photoBox.innerHTML = "";

    capturedPhotos.forEach(src=>{
        const img=document.createElement("img");
        img.src=src;
        img.style.width="180px";
        img.style.borderRadius="12px";
        img.style.border="2px solid #f2c94c";
        img.style.objectFit="cover";
        photoBox.appendChild(img);
    });

    /* ID */
    const id = "SURP-" + Date.now().toString().slice(-6);
    document.getElementById("posterID").textContent=id;

    /* RENDER */
    const tmpl=document.getElementById("posterTemplate");
    tmpl.style.display="block";

    const canvas=await html2canvas(tmpl,{scale:2});
    tmpl.style.display="none";

    const url=canvas.toDataURL("image/png");

    /* NAME */
    function sanitize(s){
        return s.trim()
                .replace(/\s+/g,"-")
                .replace(/[^a-zA-Z0-9–ê-–Ø–∞-—è–Å—ë–Ü—ñ–á—ó–Ñ—î“ê“ë\-]/g,"");
    }

    let fn="Surpresso_Equipment";

    if (owner==="client") fn=`${sanitize(value("clientName"))}_${sanitize(value("model"))}`;
    else fn=`${sanitize(value("companyLocation"))}_${sanitize(value("equipmentName"))}`;

    /* DOWNLOAD */
    const a=document.createElement("a");
    a.href=url;
    a.download=fn+".png";
    a.click();
}
/* ===================================================================
   SEND TO TELEGRAM ‚Äî JSON + base64 (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ç–≤–æ–∏–º backend)
=================================================================== */
async function sendToTelegram() {
    const owner = localStorage.getItem("equip_owner");
    const type  = localStorage.getItem("equip_type");

    // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    let card = { owner, type };

    if (owner === "client") {
        card.clientName     = value("clientName");
        card.clientPhone    = value("clientPhone");
        card.clientLocation = value("clientLocation");
        card.model          = value("model");
        card.serial         = value("serial");
        card.problem        = value("problem");
        card.condition      = value("condition");
        card.receivedDate   = value("receivedDate");

    } else {
        card.companyLocation = value("companyLocation");
        card.name            = value("equipmentName");
        card.internalNumber  = value("internalNumber");
        card.task            = value("task");
        card.comment         = value("comment");
        card.companyDate     = value("companyDate");
    }
    // ‚úÖ —Ñ–ª–∞–≥ "–∫–ª—ñ—î–Ω—Ç –∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º"
    const isContract = document.getElementById("isServiceContract");
    card.isContract = isContract ? !!isContract.checked : false;

    // –§–æ—Ç–æ –≤ base64 ‚Äî —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ç–≤–æ–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º
    const photos = [...capturedPhotos];

    if (photos.length === 0) {
        if (!confirm("–ù–µ—Ç —Ñ–æ—Ç–æ! –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç?")) return;
    }

    try {
        const resp = await fetch("/send-equipment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ card, photos })
        });

        if (!resp.ok) throw new Error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç backend");

        alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram –∏ —Å–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ trello ‚úÖ");
		capturedPhotos.length = 0;
		//renderPhotoPreview();
        stopCamera();
        

    } catch (err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram ‚ùå");
    }
}

/* ===================================================================
   COLLECT EQUIPMENT DATA
=================================================================== */
function collectEquipmentData() {
    const get = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : "";
    };

    const owner = localStorage.getItem("equip_owner");

    let data = {
        type: localStorage.getItem("equip_type"),
        owner
    };

    if (owner === "client") {
        data.clientName     = get("clientName");
        data.clientPhone    = get("clientPhone");
        data.clientLocation = get("clientLocation");
        data.model          = get("model");
        data.serial         = get("serial");
        data.problem        = get("problem");
        data.condition      = get("condition");
        data.receivedDate   = get("receivedDate");
    } else {
        data.companyLocation = get("companyLocation");
        data.name            = get("equipmentName");
        data.internalNumber  = get("internalNumber");
        data.task            = get("task");
        data.comment         = get("comment");
        data.companyDate     = get("companyDate");
    }

    return data;
}
// ============================================
// üéÑ NEW YEAR SNOW EFFECT + CLICK BLAST
// ============================================

(function startSnow() {
  const canvas = document.getElementById("snow-canvas");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  let w, h;
  let flakes = [];

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }

  window.addEventListener("resize", resize);
  resize();

  const FLAKE_COUNT = Math.min(160, Math.floor(w / 7));

  function createFlake(x = Math.random() * w, y = Math.random() * h) {
    return {
      x,
      y,
      r: Math.random() * 3 + 1,
      vy: Math.random() * 0.8 + 0.4,
      vx: Math.random() * 0.6 - 0.3
    };
  }

  for (let i = 0; i < FLAKE_COUNT; i++) {
    flakes.push(createFlake());
  }

  function draw() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();

    flakes.forEach(f => {
      ctx.moveTo(f.x, f.y);
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
    });

    ctx.fill();
    update();
  }

  function update() {
    flakes.forEach(f => {
      f.y += f.vy;
      f.x += f.vx;

      // –ª—ë–≥–∫–æ–µ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤–∑—Ä—ã–≤–∞
      f.vx *= 0.98;
      f.vy = Math.min(f.vy + 0.01, 1.6);

      if (f.y > h) {
        f.y = -5;
        f.x = Math.random() * w;
        f.vx = Math.random() * 0.6 - 0.3;
        f.vy = Math.random() * 0.8 + 0.4;
      }
    });
  }

  function blast(x, y) {
    flakes.forEach(f => {
      const dx = f.x - x;
      const dy = f.y - y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < 120) {
        const force = (120 - dist) / 120;
        f.vx += dx * 0.04 * force;
        f.vy += dy * 0.04 * force;
      }
    });
  }

  canvas.addEventListener("click", e => blast(e.clientX, e.clientY));
  canvas.addEventListener("touchstart", e => {
    const t = e.touches[0];
    blast(t.clientX, t.clientY);
  });

  function loop() {
    draw();
    requestAnimationFrame(loop);
  }

  loop();
})();


/* ===================================================================
   PRINT FORM
=================================================================== */
function printForm() {
    const card = collectEquipmentData();
    const photos = [...capturedPhotos];

    const data = { ...card, photos };

    const url = "print.html?data=" + encodeURIComponent(JSON.stringify(data));
    window.open(url, "_blank");
}


/* ===================================================================
   INIT
=================================================================== */
window.addEventListener("load", () => {

    const today = new Date().toISOString().split("T")[0];
    const companyDate = document.getElementById("companyDate");
    const receivedDate = document.getElementById("receivedDate");

    if (companyDate) companyDate.value = today;
    if (receivedDate) receivedDate.value = today;

    showStep("step1");
});

</script>

</body>
</html>
