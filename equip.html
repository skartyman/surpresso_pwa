/***********************
 * Surpresso Equipment — GAS WebApp (Registry)
 * Node <-> GAS via ?secret=...
 * Sheets + Drive folders + Photo previewUrl
 ***********************/

// ===== CONFIG =====
const SPREADSHEET_ID = '19GhF5uxmZ8NpnBXIavL1pjulALJhdKpKCCAt0IKc3OI';
const DRIVE_ROOT_FOLDER_ID = '1jbjJoxxoGN8L5YXGNpXKB1HJZ9Sk6JtD'; // папка Surpresso_Equipment

// Script Properties key name:
const SERVER_KEY_PROP = 'SURPRESSO_SERVER_KEY';

// Sheet names (НЕ gid)
const SH_EQUIPMENT = 'EQUIPMENT';
const SH_STATUS    = 'STATUS_LOG';
const SH_PHOTOS    = 'PHOTOS';

// ===== Utils =====
function json_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function now_() { return new Date(); }

function getServerKey_() {
  return PropertiesService.getScriptProperties().getProperty(SERVER_KEY_PROP) || "";
}

function assertServer_(e) {
  const secret = (e && e.parameter && e.parameter.secret) ? String(e.parameter.secret) : "";
  const real = getServerKey_();
  if (!real) throw new Error("Server key is not configured in Script Properties");
  if (!secret || secret !== real) throw new Error("unauthorized");
}

function ss_() {
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

function getOrCreateSheet_(name, headerRow) {
  const ss = ss_();
  let sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name);
  if (sh.getLastRow() === 0 && headerRow && headerRow.length) sh.appendRow(headerRow);
  return sh;
}

function rowToObj_(head, row) {
  const o = {};
  head.forEach((k, i) => o[k] = row[i]);
  return o;
}

function findRowById_(sheet, id) {
  const data = sheet.getDataRange().getValues();
  if (!data || data.length < 2) return null;
  const head = data[0];
  const idx = head.indexOf('id');
  if (idx < 0) return null;

  for (let r = 1; r < data.length; r++) {
    if (String(data[r][idx]) === String(id)) {
      return { row: r + 1, head, values: rowToObj_(head, data[r]) };
    }
  }
  return null;
}

function colIndex_(head, name) {
  const idx = head.indexOf(name);
  if (idx < 0) throw new Error("No column: " + name);
  return idx + 1;
}

// ===== Drive helpers =====
function ensureEquipmentFolder_(id) {
  const root = DriveApp.getFolderById(DRIVE_ROOT_FOLDER_ID);
  const it = root.getFoldersByName(id);
  if (it.hasNext()) {
    const f = it.next();
    return { id: f.getId(), url: f.getUrl() };
  }
  const f = root.createFolder(id);
  return { id: f.getId(), url: f.getUrl() };
}

function base64ToBlob_(base64, filename) {
  const clean = String(base64).replace(/^data:image\/\w+;base64,/, "");
  const bytes = Utilities.base64Decode(clean);
  return Utilities.newBlob(bytes, 'image/jpeg', filename);
}

function drivePreviewUrl_(fileId) {
  // ✅ вот это нормально грузится в <img src="...">
  return `https://drive.google.com/uc?export=view&id=${encodeURIComponent(fileId)}`;
}

// =========================
// Setup (запусти вручную 1 раз)
// =========================
function setup() {
  const ss = ss_();

  // EQUIPMENT
  let sh = ss.getSheetByName(SH_EQUIPMENT) || ss.insertSheet(SH_EQUIPMENT);
  sh.clear();
  sh.appendRow([
    'id', 'createdAt', 'updatedAt',
    'type', 'owner', 'isContract',
    'clientName', 'clientPhone', 'clientLocation',
    'model', 'serial',
    'companyLocation', 'name', 'internalNumber',
    'status', 'lastComment',
    'folderId', 'folderUrl',
    'passportPdfId', 'passportPdfUrl'
  ]);

  // STATUS_LOG
  sh = ss.getSheetByName(SH_STATUS) || ss.insertSheet(SH_STATUS);
  sh.clear();
  sh.appendRow(['ts','equipmentId','oldStatus','newStatus','comment','actor']);

  // PHOTOS
  sh = ss.getSheetByName(SH_PHOTOS) || ss.insertSheet(SH_PHOTOS);
  sh.clear();
  sh.appendRow(['ts','equipmentId','fileId','fileUrl','previewUrl','caption']);

  SpreadsheetApp.flush();
}

// =========================
// WebApp routes
// =========================
function doGet(e) {
  // Можно оставить простую заглушку
  return HtmlService.createHtmlOutput("Surpresso Equipment GAS WebApp ✅");
}

function doPost(e) {
  try {
    // ✅ Только сервер имеет доступ
    assertServer_(e);

    const body = (e && e.postData && e.postData.contents) ? e.postData.contents : '{}';
    const data = JSON.parse(body);

    const action = data.action;

    if (action === 'create') return json_(createOrUpdateEquipment_(data.card || {}));
    if (action === 'get')    return json_(getEquipmentBundle_(data.id));
    if (action === 'status') return json_(updateStatus_(data.id, data.newStatus, data.comment || '', data.actor || ''));
    if (action === 'photo')  return json_(addPhoto_(data.id, data.base64, data.caption || ''));
    if (action === 'pdf')    return json_(generatePassportPdfA4_(data.id));

    return json_({ ok:false, error:'Unknown action' });

  } catch (err) {
    return json_({ ok:false, error:String(err) });
  }
}

// =========================
// Core: create / upsert equipment
// =========================
function createOrUpdateEquipment_(card) {
  const sh = getOrCreateSheet_(SH_EQUIPMENT, []);

  const id = String(card.id || '').trim();
  if (!id) return { ok:false, error:'No id' };

  const found = findRowById_(sh, id);
  const now = now_();

  const folder = ensureEquipmentFolder_(id);

  const status = String(card.status || '').trim() || (
    card.owner === "company" ? "Бронь" : "Прийнято на ремонт"
  );

  const rowObj = {
    id,
    createdAt: found ? found.values.createdAt : now,
    updatedAt: now,
    type: card.type || '',
    owner: card.owner || '',
    isContract: !!card.isContract,

    clientName: card.clientName || '',
    clientPhone: card.clientPhone || '',
    clientLocation: card.clientLocation || '',
    model: card.model || '',
    serial: card.serial || '',

    companyLocation: card.companyLocation || '',
    name: card.name || '',
    internalNumber: card.internalNumber || '',

    status,
    lastComment: card.comment || '',

    folderId: folder.id,
    folderUrl: folder.url,

    passportPdfId: found ? (found.values.passportPdfId || '') : '',
    passportPdfUrl: found ? (found.values.passportPdfUrl || '') : ''
  };

  if (!found) {
    // append new
    sh.appendRow([
      rowObj.id, rowObj.createdAt, rowObj.updatedAt,
      rowObj.type, rowObj.owner, rowObj.isContract,
      rowObj.clientName, rowObj.clientPhone, rowObj.clientLocation,
      rowObj.model, rowObj.serial,
      rowObj.companyLocation, rowObj.name, rowObj.internalNumber,
      rowObj.status, rowObj.lastComment,
      rowObj.folderId, rowObj.folderUrl,
      rowObj.passportPdfId, rowObj.passportPdfUrl
    ]);

    // log
    appendStatusLog_(id, '', status, rowObj.lastComment, card.actor || '');
  } else {
    // update existing row
    const head = found.head;

    sh.getRange(found.row, colIndex_(head,'updatedAt')).setValue(rowObj.updatedAt);
    sh.getRange(found.row, colIndex_(head,'type')).setValue(rowObj.type);
    sh.getRange(found.row, colIndex_(head,'owner')).setValue(rowObj.owner);
    sh.getRange(found.row, colIndex_(head,'isContract')).setValue(rowObj.isContract);

    sh.getRange(found.row, colIndex_(head,'clientName')).setValue(rowObj.clientName);
    sh.getRange(found.row, colIndex_(head,'clientPhone')).setValue(rowObj.clientPhone);
    sh.getRange(found.row, colIndex_(head,'clientLocation')).setValue(rowObj.clientLocation);
    sh.getRange(found.row, colIndex_(head,'model')).setValue(rowObj.model);
    sh.getRange(found.row, colIndex_(head,'serial')).setValue(rowObj.serial);

    sh.getRange(found.row, colIndex_(head,'companyLocation')).setValue(rowObj.companyLocation);
    sh.getRange(found.row, colIndex_(head,'name')).setValue(rowObj.name);
    sh.getRange(found.row, colIndex_(head,'internalNumber')).setValue(rowObj.internalNumber);

    sh.getRange(found.row, colIndex_(head,'status')).setValue(rowObj.status);
    sh.getRange(found.row, colIndex_(head,'lastComment')).setValue(rowObj.lastComment);

    sh.getRange(found.row, colIndex_(head,'folderId')).setValue(rowObj.folderId);
    sh.getRange(found.row, colIndex_(head,'folderUrl')).setValue(rowObj.folderUrl);
  }

  return {
    ok:true,
    id,
    folderUrl: folder.url,
    status
  };
}

// =========================
// Read bundle
// =========================
function getEquipmentBundle_(id) {
  id = String(id || '').trim();
  if (!id) return { ok:false, error:'No id' };

  const eq = getEquipmentById_(id);
  if (!eq) return { ok:false, error:'Not found' };

  return {
    ok:true,
    equipment: eq,
    photos: getPhotosById_(id),
    log: getStatusLogById_(id)
  };
}

// =========================
// Update status
// =========================
function updateStatus_(id, newStatus, comment, actor) {
  id = String(id || '').trim();
  newStatus = String(newStatus || '').trim();
  if (!id) return { ok:false, error:'No id' };
  if (!newStatus) return { ok:false, error:'No newStatus' };

  const sh = getOrCreateSheet_(SH_EQUIPMENT, []);
  const found = findRowById_(sh, id);
  if (!found) return { ok:false, error:'Not found' };

  const oldStatus = String(found.values.status || '');
  const now = now_();

  sh.getRange(found.row, colIndex_(found.head,'status')).setValue(newStatus);
  sh.getRange(found.row, colIndex_(found.head,'updatedAt')).setValue(now);
  sh.getRange(found.row, colIndex_(found.head,'lastComment')).setValue(comment || '');

  appendStatusLog_(id, oldStatus, newStatus, comment || '', actor || '');

  return { ok:true, id, oldStatus, newStatus };
}

// =========================
// Add photo (Drive + Sheet)
// =========================
function addPhoto_(id, base64, caption) {
  id = String(id || '').trim();
  if (!id) return { ok:false, error:'No id' };
  if (!base64) return { ok:false, error:'No base64' };

  const eq = getEquipmentById_(id);
  if (!eq) return { ok:false, error:'Not found' };

  const folder = DriveApp.getFolderById(eq.folderId);

  const filename = `photo_${id}_${Date.now()}.jpg`;
  const blob = base64ToBlob_(base64, filename);

  const file = folder.createFile(blob);

  // ✅ делаем доступ для просмотра по ссылке
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  const fileId = file.getId();
  const fileUrl = file.getUrl();
  const previewUrl = drivePreviewUrl_(fileId);

  // сохраняем
  const sh = getOrCreateSheet_(SH_PHOTOS, []);
  sh.appendRow([now_(), id, fileId, fileUrl, previewUrl, caption || '']);

  return { ok:true, fileId, fileUrl, previewUrl };
}

// =========================
// PDF Passport A4
// =========================
function generatePassportPdfA4_(id) {
  id = String(id || '').trim();
  if (!id) return { ok:false, error:'No id' };

  const eq = getEquipmentById_(id);
  if (!eq) return { ok:false, error:'Not found' };

  const photos = getPhotosById_(id);
  const log = getStatusLogById_(id);

  // ✅ твой шаблон pdf_a4 должен быть в проекте как HTML-файл "pdf_a4"
  const html = HtmlService.createTemplateFromFile('pdf_a4');
  html.eq = eq;
  html.photos = photos;
  html.statuses = log;

  const content = html.evaluate().getContent();

  const blob = Utilities
    .newBlob(content, 'text/html', `passport_${id}.html`)
    .getAs('application/pdf')
    .setName(`Surpresso_Passport_${id}.pdf`);

  const folder = DriveApp.getFolderById(eq.folderId);
  const pdfFile = folder.createFile(blob);

  pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  // обновляем поля в EQUIPMENT
  const sh = getOrCreateSheet_(SH_EQUIPMENT, []);
  const found = findRowById_(sh, id);

  if (found) {
    sh.getRange(found.row, colIndex_(found.head,'passportPdfId')).setValue(pdfFile.getId());
    sh.getRange(found.row, colIndex_(found.head,'passportPdfUrl')).setValue(pdfFile.getUrl());
    sh.getRange(found.row, colIndex_(found.head,'updatedAt')).setValue(now_());
  }

  return { ok:true, id, fileId: pdfFile.getId(), url: pdfFile.getUrl() };
}

// =========================
// Helpers: Read from sheets
// =========================
function getEquipmentById_(id) {
  const sh = getOrCreateSheet_(SH_EQUIPMENT, []);
  const found = findRowById_(sh, id);
  return found ? found.values : null;
}

function getPhotosById_(id) {
  const sh = getOrCreateSheet_(SH_PHOTOS, []);
  const data = sh.getDataRange().getValues();
  if (!data || data.length < 2) return [];

  const head = data[0];
  const idxId  = head.indexOf('equipmentId');
  const idxFileId = head.indexOf('fileId');
  const idxUrl = head.indexOf('fileUrl');
  const idxPrev = head.indexOf('previewUrl');
  const idxCap = head.indexOf('caption');
  const idxTs  = head.indexOf('ts');

  return data.slice(1)
    .filter(r => String(r[idxId]) === String(id))
    .map(r => ({
      ts: r[idxTs],
      fileId: r[idxFileId],
      url: r[idxUrl],
      previewUrl: r[idxPrev] || (r[idxFileId] ? drivePreviewUrl_(r[idxFileId]) : r[idxUrl]),
      caption: r[idxCap]
    }))
    .reverse();
}

function getStatusLogById_(id) {
  const sh = getOrCreateSheet_(SH_STATUS, []);
  const data = sh.getDataRange().getValues();
  if (!data || data.length < 2) return [];

  const head = data[0];
  const idxId  = head.indexOf('equipmentId');
  const idxTs  = head.indexOf('ts');
  const idxOld = head.indexOf('oldStatus');
  const idxNew = head.indexOf('newStatus');
  const idxCom = head.indexOf('comment');
  const idxAct = head.indexOf('actor');

  return data.slice(1)
    .filter(r => String(r[idxId]) === String(id))
    .map(r => ({
      ts: r[idxTs],
      oldStatus: r[idxOld],
      newStatus: r[idxNew],
      comment: r[idxCom],
      actor: r[idxAct]
    }))
    .reverse();
}

function appendStatusLog_(id, oldStatus, newStatus, comment, actor) {
  const sh = getOrCreateSheet_(SH_STATUS, []);
  sh.appendRow([now_(), id, oldStatus || '', newStatus || '', comment || '', actor || '']);
}
