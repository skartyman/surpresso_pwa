<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surpresso ‚Äî –ü–∞—Å–ø–æ—Ä—Ç</title>
  <style>
    body{font-family:Segoe UI,system-ui,sans-serif;margin:0;background:#fff;color:#222}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;border-bottom:2px solid #F2C94C;padding-bottom:10px}
    .logo{font-size:20px;font-weight:800}
    .sub{font-size:12px;color:#666}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin-top:12px; overflow:hidden;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn-yellow{background:#F2C94C}
    .btn-ghost{background:#f4f4f4}
    .btn-danger{background:#ffe5e5;color:#b00}
    select,input,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #ddd;font-size:14px; box-sizing:border-box;}
    table{width:100%;border-collapse:collapse}
    td{padding:6px 4px;border-bottom:1px solid #eee;vertical-align:top}
    td.lbl{font-weight:700;width:220px}
    .muted{color:#666;font-size:12px}
    .warn{color:#b00;font-weight:700}
    .ok{color:#0a7;font-weight:700}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:#f4f4f4;border-radius:999px;padding:6px 10px;font-size:12px}
    .link{color:#222;text-decoration:none;border-bottom:1px dashed #999}

    /* photos in passport */
    .photosHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .photosGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px; margin-top:10px}
    @media(max-width:760px){.photosGrid{grid-template-columns:repeat(2,1fr)}}
    .ph{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fafafa}
    .ph img{width:100%;display:block;height:160px;object-fit:cover; cursor:pointer}
    .cap{padding:8px;font-size:12px;color:#444;border-top:1px solid #eee; background:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    .pager{display:flex; gap:8px; align-items:center; justify-content:center; margin-top:10px}
    .pager button{padding:8px 10px; border-radius:12px}
    .pagerInfo{font-size:12px; color:#666; min-width:120px; text-align:center}

    /* lightbox */
    .lb{
      position:fixed; inset:0; background:rgba(0,0,0,.78);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:9999;
    }
    .lbInner{max-width:980px; width:100%;}
    .lbTop{display:flex; gap:10px; align-items:center; justify-content:space-between; color:#fff; margin-bottom:10px}
    .lbTitle{font-weight:700; font-size:14px; opacity:.95; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .lbBtns{display:flex; gap:8px; flex-wrap:wrap;}
    .lbBtn{background:rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.18); padding:8px 10px; border-radius:12px; cursor:pointer; font-weight:700}
    .lbImgWrap{background:#111;border-radius:16px; overflow:hidden; box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .lbImg{width:100%; max-height:78vh; object-fit:contain; display:block; background:#111}

    /* Status photo block */
    .miniTitle{font-weight:800;margin:0 0 6px 0}
    .hintLine{font-size:12px;color:#666;margin-top:6px}
    .previewGrid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:760px){
      .previewGrid{grid-template-columns:repeat(3,1fr)}
    }
    .prevItem{
      position:relative;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      background:#fafafa;
    }
    .prevItem img{
      width:100%;
      height:120px;
      object-fit:cover;
      display:block;
    }
    .prevDel{
      position:absolute;
      right:6px;
      top:6px;
      border:0;
      background:rgba(0,0,0,.55);
      color:#fff;
      font-weight:800;
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-size:12px;
    }

    .cameraBox{
      display:none;
      margin-top:10px;
      border:1px solid #eee;
      border-radius:14px;
      overflow:hidden;
      background:#000;
    }
    .cameraBox video{
      width:100%;
      max-height:320px;
      object-fit:cover;
      display:block;
    }

    .compactInput{
      max-width:220px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="logo">Surpresso Service</div>
        <div class="sub">–ü–∞—Å–ø–æ—Ä—Ç / —Å—Ç–∞—Ç—É—Å –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</div>
      </div>
      <div class="sub">ID: <b id="eqId">‚Äî</b></div>
    </div>

    <div id="noId" class="card" style="display:none">
      <div class="warn">–ù–µ–º–∞—î ID. –í—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫—É —è–∫: <b>equip.html?id=...</b></div>
    </div>

    <div id="main" style="display:none">
      <div class="card">
        <div class="bar" style="justify-content:space-between">
          <div>
            <div class="muted">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å</div>
            <div style="font-size:18px;font-weight:800" id="curStatus">‚Äî</div>
            <div class="muted" id="updatedAt"></div>
          </div>

          <div class="row">
            <button class="btn btn-ghost" id="btnPdf">üìÑ PDF A4</button>
            <button class="btn btn-yellow" id="btnRefresh">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <span class="pill" id="pillOwner">owner: ‚Äî</span>
          <span class="pill" id="pillType">type: ‚Äî</span>
          <a class="pill link" id="driveFolderLink" href="#" target="_blank" style="display:none">üìÅ Drive –ø–∞–ø–∫–∞</a>
        </div>
      </div>

      <!-- STATUS -->
      <div class="card">
        <div class="grid">
          <div>
            <div class="muted">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</div>
            <select id="statusSelect"></select>
          </div>
          <div>
            <div class="muted">–ö–æ–º–µ–Ω—Ç–∞—Ä</div>
            <input id="comment" placeholder="–ù–∞–ø—Ä: –ó–∞–±—Ä–∞–≤ –∫–ª—ñ—î–Ω—Ç, –≤—ñ–¥–¥–∞–ª–∏ –≤ –æ—Ä–µ–Ω–¥—É..." />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="actor" class="compactInput" placeholder="–•—Ç–æ –∑–º—ñ–Ω–∏–≤ (–æ–ø—Ü.) –Ω–∞–ø—Ä: –Ü–≥–æ—Ä" />
          <button class="btn btn-yellow" id="btnStatus">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
          <span class="muted" id="statusHint"></span>
        </div>

        <!-- ‚úÖ PHOTO FOR STATUS (FRESH) -->
        <div style="margin-top:14px;border-top:1px solid #eee;padding-top:12px">
          <div class="miniTitle">üì∏ –§–æ—Ç–æ –¥–æ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É (—Å–≤—ñ–∂–µ / –∑ —Ç–µ–ª–µ—Ñ–æ–Ω—É)</div>
          <div class="muted">
            –¶–µ —Ñ–æ—Ç–æ –ø—ñ–¥–µ —Ä–∞–∑–æ–º –∑—ñ –∑–º—ñ–Ω–æ—é —Å—Ç–∞—Ç—É—Å—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–µ—Ä–≤–µ—Ä —Å–∞–º –≤–∏—Ä—ñ—à–∏—Ç—å, —á–∏ —Ä–æ–±–∏—Ç–∏ –ø–æ—Å—Ç–∏–Ω–≥ —É Telegram.
          </div>

          <div class="row" style="margin-top:10px; justify-content:space-between">
            <div class="row" style="gap:8px;">
              <button class="btn btn-ghost" id="btnCamToggle">üì∑ –ö–∞–º–µ—Ä–∞</button>
              <button class="btn btn-ghost" id="btnTorch" style="display:none">üí° –°–≤—ñ—Ç–ª–æ</button>
              <button class="btn btn-ghost" id="btnCapture" style="display:none">üì∏ –ó–Ω—è—Ç–∏</button>
              <button class="btn btn-danger" id="btnClearStatusPhotos" style="display:none">üóë –û—á–∏—Å—Ç–∏—Ç–∏</button>
            </div>

            <div class="row" style="gap:8px;">
              <input type="file" id="statusPhotoFiles" accept="image/*" multiple />
              <button class="btn btn-yellow" id="btnAddStatusFiles">‚ûï –î–æ–¥–∞—Ç–∏ –∑ –≥–∞–ª–µ—Ä–µ—ó</button>
            </div>
          </div>

          <div class="hintLine">
            –ú–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –æ–¥—Ä–∞–∑—É <b>3‚Äì5 —Ñ–æ—Ç–æ</b> (–∞–±–æ –±—ñ–ª—å—à–µ). –†–µ–∫–æ–º–µ–Ω–¥—É—é –º–∞–∫—Å–∏–º—É–º <b>10</b> –∑–∞ —Ä–∞–∑.
          </div>

          <div class="cameraBox" id="cameraBox">
            <video id="camVideo" autoplay playsinline></video>
            <canvas id="camCanvas" style="display:none;"></canvas>
          </div>

          <div id="statusPhotosHint" class="muted" style="margin-top:8px"></div>
          <div id="statusPreview" class="previewGrid" style="display:none"></div>
        </div>
      </div>

      <!-- INFO -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>
          <div class="muted" id="infoHint"></div>
        </div>
        <table id="info"></table>
      </div>

      <!-- PHOTOS from GAS -->
      <div class="card">
        <div class="photosHeader">
          <div style="font-weight:800">–§–æ—Ç–æ (–∑ –±–∞–∑–∏)</div>

          <div class="row" style="gap:8px; flex:1; justify-content:flex-end">
            <input type="file" id="photoFiles" accept="image/*" multiple />
            <button class="btn btn-yellow" id="btnUploadPhotos">üì§ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –≤ –±–∞–∑—É</button>
          </div>
        </div>

        <div class="muted" style="margin-top:6px">
          –ú–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –æ–¥—Ä–∞–∑—É <b>3‚Äì5 —Ñ–æ—Ç–æ</b> (–∞–±–æ –±—ñ–ª—å—à–µ). –ü–æ–∫–∞–∑—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ <b>10</b> –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é.
        </div>

        <div class="row" style="margin-top:10px; align-items:center; justify-content:space-between">
          <div class="muted" id="photosHint"></div>

          <div class="pager">
            <button class="btn btn-ghost" id="btnPrevPhotos">‚Üê</button>
            <div class="pagerInfo" id="photosPageInfo">–§–æ—Ç–æ: 0</div>
            <button class="btn btn-ghost" id="btnNextPhotos">‚Üí</button>
          </div>
        </div>

        <div class="photosGrid" id="photos"></div>
      </div>

      <!-- LOG -->
      <div class="card">
        <div style="font-weight:800">–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤</div>
        <table id="log"></table>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div class="lb" id="lightbox" onclick="closeLightbox(event)">
    <div class="lbInner">
      <div class="lbTop">
        <div class="lbTitle" id="lbTitle">–§–æ—Ç–æ</div>
        <div class="lbBtns">
          <button class="lbBtn" id="lbOpenDrive" onclick="openDriveFromLightbox(event)">–í—ñ–¥–∫—Ä–∏—Ç–∏ –≤ Drive</button>
          <button class="lbBtn" onclick="forceCloseLightbox(event)">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
      <div class="lbImgWrap">
        <img class="lbImg" id="lbImg" src="" alt="">
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const PWA_KEY_STORAGE = "surpresso_pwa_key";
    const API_BASE = ""; // same domain

    const PHOTOS_PAGE_SIZE = 10;

    const DEFAULT_STATUSES_CLIENT = [
      "–ü—Ä–∏–π–Ω—è—Ç–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç",
      "–í —Ä–æ–±–æ—Ç—ñ",
      "–ì–æ—Ç–æ–≤–æ",
      "–í–∏–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç—É"
    ];

    const DEFAULT_STATUSES_COMPANY = [
      "–ë—Ä–æ–Ω—å –∫ –ø—Ä–æ–¥–∞–∂–µ",
      "–ë—Ä–æ–Ω—å –∫ –∞—Ä–µ–Ω–¥–µ",
      "–ì–æ—Ç–æ–≤–æ –∫ –∞—Ä–µ–Ω–¥–µ",
      "–£–µ—Ö–∞–ª–æ –Ω–∞ –∞—Ä–µ–Ω–¥—É",
      "–ü—Ä–∏–µ—Ö–∞–ª–æ –ø–æ—Å–ª–µ –∞—Ä–µ–Ω–¥—ã",
      "–£–µ—Ö–∞–ª–æ –Ω–∞ –ø–æ–¥–º–µ–Ω—É",
      "–ü—Ä–∏–µ—Ö–∞–ª–æ —Å –ø–æ–¥–º–µ–Ω—ã",
      "–ü—Ä–æ–¥–∞–Ω–æ"
    ];

    const $ = (id) => document.getElementById(id);

    // ===========================
    // GET ID FROM URL
    // ===========================
    const params = new URLSearchParams(location.search);
    const EQUIPMENT_ID = (params.get("id") || "").trim();

    if (!EQUIPMENT_ID) {
      $("noId").style.display = "block";
    } else {
      $("main").style.display = "block";
      $("eqId").textContent = EQUIPMENT_ID;

      $("btnRefresh").onclick = load;
      $("btnStatus").onclick = saveStatus;

      $("btnUploadPhotos").onclick = uploadPhotosMulti;
      $("btnPrevPhotos").onclick = () => { photosPage--; renderPhotos(); };
      $("btnNextPhotos").onclick = () => { photosPage++; renderPhotos(); };

      $("btnPdf").onclick = () => {
        location.href = `${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/pdf${withKeyQuery()}`;
      };

      // status photos controls
      $("btnCamToggle").onclick = toggleCamera;
      $("btnCapture").onclick = captureStatusPhoto;
      $("btnTorch").onclick = toggleTorch;
      $("btnAddStatusFiles").onclick = addStatusFiles;
      $("btnClearStatusPhotos").onclick = clearStatusPhotos;

      load();
    }

    // ===========================
    // AUTH
    // ===========================
    function getKey() {
      return localStorage.getItem(PWA_KEY_STORAGE) || "";
    }

    function ensureKey() {
      let k = getKey();
      if (k) return k;
      k = (prompt("–í–≤–µ–¥–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É (PWA Key):") || "").trim();
      if (!k) return "";
      localStorage.setItem(PWA_KEY_STORAGE, k);
      return k;
    }

    function headersWithKey() {
      const k = ensureKey();
      return k ? { "x-surpresso-key": k } : {};
    }

    function withKeyQuery() {
      const k = ensureKey();
      if (!k) return "";
      return `?k=${encodeURIComponent(k)}`;
    }

    // ===========================
    // API wrapper
    // ===========================
    async function apiGet(url) {
      const resp = await fetch(url, { headers: headersWithKey() });
      return await resp.json();
    }

    async function apiPost(url, payload) {
      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...headersWithKey()
        },
        body: JSON.stringify(payload || {})
      });
      return await resp.json();
    }

    // ===========================
    // LOAD & RENDER
    // ===========================
    let CURRENT_OWNER = "";
    let allPhotos = [];
    let photosPage = 0;

    async function load() {
      $("statusHint").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      const data = await apiGet(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}`);

      if (!data.ok) {
        $("statusHint").textContent = "";
        return alert(data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è");
      }

      render(data);
      $("statusHint").textContent = "";
    }

    function render(data) {
      const eq = data.equipment || {};
      allPhotos = Array.isArray(data.photos) ? data.photos : [];
      const log = data.log || [];

      CURRENT_OWNER = eq.owner || "";

      $("curStatus").textContent = eq.status || "‚Äî";
      $("updatedAt").textContent = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + fmt(eq.updatedAt);

      $("pillOwner").textContent = "owner: " + (eq.owner || "‚Äî");
      $("pillType").textContent = "type: " + (eq.type || "‚Äî");

      // Drive folder link
      if (eq.folderUrl) {
        $("driveFolderLink").href = eq.folderUrl;
        $("driveFolderLink").style.display = "inline-flex";
      } else {
        $("driveFolderLink").style.display = "none";
      }

      // statuses by owner
      const statuses = buildStatusesFor(eq);
      fillStatuses(statuses, eq.status);

      // info table
      const rows = [];
      const add = (k, v) => rows.push(`<tr><td class="lbl">${k}</td><td>${esc(v)}</td></tr>`);

      add("–¢–∏–ø", eq.type || "‚Äî");
      add("–í–ª–∞—Å–Ω–∏–∫", eq.owner || "‚Äî");
      if (String(eq.isContract) === "true") add("–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è", "–ó–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º ‚úÖ");

      if (eq.owner === "client") {
        add("–ö–ª—ñ—î–Ω—Ç", eq.clientName || "‚Äî");
        add("–¢–µ–ª–µ—Ñ–æ–Ω", eq.clientPhone || "‚Äî");
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.clientLocation || "‚Äî");
        add("–ú–æ–¥–µ–ª—å", eq.model || "‚Äî");
        add("–°–µ—Ä—ñ–π–Ω–∏–π", eq.serial || "‚Äî");
      } else {
        add("–õ–æ–∫–∞—Ü—ñ—è (–∑–∞–∫–ª–∞–¥/—Ü–µ—Ö)", eq.companyLocation || "‚Äî");
        add("–ù–∞–∑–≤–∞", eq.name || "‚Äî");
        add("–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ‚Ññ", eq.internalNumber || "‚Äî");
      }

      add("–û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", eq.lastComment || "‚Äî");

      $("info").innerHTML = rows.join("");

      // photos render (pagination)
      photosPage = 0;
      renderPhotos();

      // log render
      $("log").innerHTML = log.length
        ? log.map(r => `
          <tr>
            <td style="width:160px">${fmt(r.ts)}</td>
            <td><b>${esc(r.newStatus)}</b>
              ${r.comment ? "‚Äî " + esc(r.comment) : ""}
              ${r.actor ? `<span class="muted">(${esc(r.actor)})</span>` : ""}
            </td>
          </tr>
        `).join("")
        : `<tr><td class="muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</td></tr>`;
    }

    function buildStatusesFor(eq) {
      if (eq.owner === "company") return DEFAULT_STATUSES_COMPANY;
      return DEFAULT_STATUSES_CLIENT;
    }

    function fillStatuses(list, current) {
      const sel = $("statusSelect");
      sel.innerHTML = "";
      list.forEach(s => {
        const o = document.createElement("option");
        o.value = s;
        o.textContent = s;
        sel.appendChild(o);
      });

      if (current && list.includes(current)) sel.value = current;
      else sel.value = list[0] || "";
    }

    // ===========================
    // PHOTOS: pagination + preview
    // ===========================
    function renderPhotos() {
      const total = allPhotos.length;
      const maxPage = Math.max(0, Math.ceil(total / PHOTOS_PAGE_SIZE) - 1);
      photosPage = Math.min(Math.max(photosPage, 0), maxPage);

      const start = photosPage * PHOTOS_PAGE_SIZE;
      const slice = allPhotos.slice(start, start + PHOTOS_PAGE_SIZE);

      $("photosPageInfo").textContent =
        total === 0 ? "–§–æ—Ç–æ: 0" : `–§–æ—Ç–æ ${start + 1}-${Math.min(start + PHOTOS_PAGE_SIZE, total)} / ${total}`;

      $("btnPrevPhotos").disabled = photosPage <= 0;
      $("btnNextPhotos").disabled = photosPage >= maxPage;

      if (!slice.length) {
        $("photos").innerHTML = `<div class="muted">–§–æ—Ç–æ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î.</div>`;
        return;
      }

      $("photos").innerHTML = slice.map((p) => {
        const driveViewUrl = String(p.url || "");
        const imgUrl = String(p.imgUrl || "") || driveToImageUrl(driveViewUrl);
        const cap = p.caption || "";
        const ts = fmt(p.ts);
        const safeCap = esc(cap || ts || "–§–æ—Ç–æ");
        const safeDrive = esc(driveViewUrl);

        const fresh = (imgUrl && imgUrl.includes("?")) ? `${imgUrl}&t=${Date.now()}` : `${imgUrl}?t=${Date.now()}`;

        return `
          <div class="ph">
            <img
              src="${fresh}"
              alt="${safeCap}"
              loading="lazy"
              onerror="this.onerror=null; this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px&quot; class=&quot;muted&quot;>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é. <a target=_blank href=&quot;${safeDrive}&quot;>–í—ñ–¥–∫—Ä–∏—Ç–∏</a></div>';"
              onclick="openLightbox('${escapeJs(fresh)}','${escapeJs(driveViewUrl)}','${escapeJs(safeCap)}')"
            >
            <div class="cap">${safeCap}</div>
          </div>
        `;
      }).join("");
    }

    // ‚úÖ –ü—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π proxy (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ img -> –∏—Å–ø–æ–ª—å–∑—É–µ–º ?k=...)
    function driveToImageUrl(driveUrl) {
      if (!driveUrl) return "";

      const s = String(driveUrl);
      let fileId = null;

      if (s.includes("uc?export=view&id=")) {
        const m = s.match(/id=([^&]+)/i);
        if (m) fileId = m[1];
      } else if (s.includes("/file/d/")) {
        const m = s.match(/\/file\/d\/([^\/]+)\//i);
        if (m) fileId = m[1];
      } else if (s.includes("id=")) {
        const m = s.match(/[?&]id=([^&]+)/i);
        if (m) fileId = m[1];
      }

      if (fileId) {
        const k = ensureKey();
        const q = k ? `?k=${encodeURIComponent(k)}` : "";
        return `${API_BASE}/proxy-drive/${encodeURIComponent(fileId)}${q}`;
      }

      return s;
    }

    // ===========================
    // LIGHTBOX
    // ===========================
    let LB_DRIVE_URL = "";
    function openLightbox(imgUrl, driveUrl, title) {
      LB_DRIVE_URL = driveUrl || "";
      $("lbImg").src = imgUrl || "";
      $("lbTitle").textContent = title || "–§–æ—Ç–æ";
      $("lightbox").style.display = "flex";
      $("lbOpenDrive").style.display = LB_DRIVE_URL ? "inline-flex" : "none";
    }

    function closeLightbox(e) {
      if (e.target && e.target.id === "lightbox") {
        $("lightbox").style.display = "none";
        $("lbImg").src = "";
        LB_DRIVE_URL = "";
      }
    }

    function forceCloseLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      $("lightbox").style.display = "none";
      $("lbImg").src = "";
      LB_DRIVE_URL = "";
    }

    function openDriveFromLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      if (!LB_DRIVE_URL) return;
      window.open(LB_DRIVE_URL, "_blank");
    }

    // ===========================
    // ‚úÖ STATUS SAVE (+ fresh photos)
    // ===========================
    async function saveStatus() {
      const newStatus = $("statusSelect").value;
      const comment = $("comment").value.trim();
      const actor = $("actor").value.trim();

      $("btnStatus").disabled = true;
      $("statusHint").textContent = "–ó–±–µ—Ä—ñ–≥–∞—é...";

      // ‚úÖ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–µ–∂–∏–µ —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
      const photos = statusPhotos.slice(0, 10);

      const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/status`, {
        newStatus, comment, actor, photos
      });

      $("btnStatus").disabled = false;
      $("statusHint").textContent = "";

      if (!out.ok) return alert(out.error || "–ü–æ–º–∏–ª–∫–∞");

      $("comment").value = "";

      // ‚úÖ –æ—á–∏—â–∞–µ–º "—Å—Ç–∞—Ç—É—Å–Ω—ã–µ" —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —É–¥–∞—á–∏
      clearStatusPhotos();

      await load();
    }

    // ===========================
    // ‚úÖ STATUS PHOTOS: –∫–∞–º–µ—Ä–∞ + –≥–∞–ª–µ—Ä–µ—è
    // ===========================
    let statusPhotos = []; // base64
    let camStream = null;
    let torchOn = false;

    function updateStatusPhotosUI() {
      const has = statusPhotos.length > 0;
      $("statusPreview").style.display = has ? "grid" : "none";
      $("btnClearStatusPhotos").style.display = has ? "inline-flex" : "none";
      $("statusPhotosHint").textContent = has ? `–û–±—Ä–∞–Ω–æ —Ñ–æ—Ç–æ: ${statusPhotos.length}` : "";
      renderStatusPreview();
    }

    function renderStatusPreview() {
      if (!statusPhotos.length) {
        $("statusPreview").innerHTML = "";
        return;
      }

      $("statusPreview").innerHTML = statusPhotos.map((b64, idx) => {
        return `
          <div class="prevItem">
            <img src="${b64}" alt="photo_${idx}">
            <button class="prevDel" onclick="removeStatusPhoto(${idx})">‚úï</button>
          </div>
        `;
      }).join("");
    }

    function removeStatusPhoto(idx) {
      statusPhotos.splice(idx, 1);
      updateStatusPhotosUI();
    }

    function clearStatusPhotos() {
      statusPhotos = [];
      const input = $("statusPhotoFiles");
      if (input) input.value = "";
      updateStatusPhotosUI();
    }

    async function addStatusFiles() {
      const input = $("statusPhotoFiles");
      const files = input && input.files ? Array.from(input.files) : [];
      if (!files.length) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)");

      const MAX = 10;
      if (files.length + statusPhotos.length > MAX) {
        if (!confirm(`–ú–∞–∫—Å–∏–º—É–º ${MAX} —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É.\n–î–æ–¥–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —á–∞—Å—Ç–∏–Ω—É?`)) return;
      }

      const remain = Math.max(0, MAX - statusPhotos.length);
      const toAdd = files.slice(0, remain);

      $("statusPhotosHint").textContent = `–î–æ–¥–∞—é ${toAdd.length} —Ñ–æ—Ç–æ...`;

      try {
        for (let i = 0; i < toAdd.length; i++) {
          const base64 = await fileToBase64(toAdd[i]);
          statusPhotos.push(base64);
        }
        $("statusPhotosHint").textContent = "";
        updateStatusPhotosUI();
      } catch (e) {
        console.error(e);
        $("statusPhotosHint").textContent = "";
        alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ");
      } finally {
        input.value = "";
      }
    }

    async function toggleCamera() {
      if (camStream) {
        stopCamera();
        return;
      }
      await startCamera();
    }

    async function startCamera() {
      try {
        camStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });

        const v = $("camVideo");
        v.srcObject = camStream;
        await v.play();

        $("cameraBox").style.display = "block";
        $("btnCapture").style.display = "inline-flex";

        // torch button if supported
        const track = camStream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if (caps && caps.torch) {
          $("btnTorch").style.display = "inline-flex";
        } else {
          $("btnTorch").style.display = "none";
        }

        $("btnCamToggle").textContent = "‚èπ –ó–∞–∫—Ä–∏—Ç–∏ –∫–∞–º–µ—Ä—É";
      } catch (e) {
        console.error(e);
        alert("‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
        stopCamera();
      }
    }

    function stopCamera() {
      if (camStream) {
        camStream.getTracks().forEach(t => t.stop());
        camStream = null;
      }
      torchOn = false;

      $("cameraBox").style.display = "none";
      $("btnCapture").style.display = "none";
      $("btnTorch").style.display = "none";
      $("btnCamToggle").textContent = "üì∑ –ö–∞–º–µ—Ä–∞";
    }

    async function toggleTorch() {
      if (!camStream) return;
      try {
        const track = camStream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if (!caps.torch) {
          alert("‚ö†Ô∏è –°–≤—ñ—Ç–ª–æ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó");
          return;
        }
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        $("btnTorch").textContent = torchOn ? "üí° –°–≤—ñ—Ç–ª–æ: ON" : "üí° –°–≤—ñ—Ç–ª–æ";
      } catch (e) {
        console.error(e);
      }
    }

    function captureStatusPhoto() {
      if (!camStream) return;

      const v = $("camVideo");
      const c = $("camCanvas");
      c.width = v.videoWidth || 1280;
      c.height = v.videoHeight || 720;

      const ctx = c.getContext("2d");
      ctx.drawImage(v, 0, 0, c.width, c.height);

      // —Å–∂–∏–º–∞–µ–º —Ä–∞–∑—É–º–Ω–æ —á—Ç–æ–±—ã –Ω–µ –≤–∑–æ—Ä–≤–∞—Ç—å –ª–∏–º–∏—Ç—ã
      const dataURL = c.toDataURL("image/jpeg", 0.88);

      const MAX = 10;
      if (statusPhotos.length >= MAX) {
        alert(`–ú–∞–∫—Å–∏–º—É–º ${MAX} —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É`);
        return;
      }

      statusPhotos.push(dataURL);
      updateStatusPhotosUI();
    }

    // ===========================
    // ‚úÖ UPLOAD PHOTOS (MULTI) -> GAS
    // ===========================
    async function uploadPhotosMulti() {
      const input = $("photoFiles");
      const files = input && input.files ? Array.from(input.files) : [];

      if (!files.length) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)");

      const MAX = 10;
      if (files.length > MAX) {
        if (!confirm(`–û–±—Ä–∞–Ω–æ ${files.length} —Ñ–æ—Ç–æ. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ ${MAX}?`)) return;
      }

      const toUpload = files.slice(0, MAX);

      $("btnUploadPhotos").disabled = true;
      $("photosHint").textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é ${toUpload.length} —Ñ–æ—Ç–æ...`;

      try {
        for (let i = 0; i < toUpload.length; i++) {
          $("photosHint").textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —Ñ–æ—Ç–æ ${i + 1} / ${toUpload.length}...`;
          const base64 = await fileToBase64(toUpload[i]);

          const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/photo`, {
            base64,
            caption: ""
          });

          if (!out.ok) {
            throw new Error(out.error || `–ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ ${i + 1}`);
          }
        }

        $("photosHint").textContent = "‚úÖ –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ";
        setTimeout(() => $("photosHint").textContent = "", 2000);

        input.value = "";
        await load();

      } catch (e) {
        console.error(e);
        $("photosHint").textContent = "";
        alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"));
      } finally {
        $("btnUploadPhotos").disabled = false;
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // ===========================
    // UTILS
    // ===========================
    function fmt(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const yy = String(dt.getFullYear()).slice(-2);
        const hh = String(dt.getHours()).padStart(2, "0");
        const mi = String(dt.getMinutes()).padStart(2, "0");
        return `${dd}.${mm}.${yy} ${hh}:${mi}`;
      } catch (e) { return ""; }
    }

    function esc(v) {
      if (v === null || v === undefined) return "‚Äî";
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function escapeJs(s){
      return String(s || "")
        .replaceAll("\\", "\\\\")
        .replaceAll("'", "\\'")
        .replaceAll("\n", "\\n")
        .replaceAll("\r", "");
    }

    // ===========================
    // Cleanup camera on page leave
    // ===========================
    window.addEventListener("beforeunload", () => {
      try { stopCamera(); } catch(e){}
    });
  </script>
</body>
</html>
