<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surpresso ‚Äî –ü–∞—Å–ø–æ—Ä—Ç</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="gradient.css" />
<style>
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
}

a{color:inherit}
a.link{color:#1f2937;text-decoration:none}
a.link:hover{text-decoration:underline}

.wrap{
  max-width: 1100px;
  margin: 22px auto 80px;
  padding: 0 14px;
}

/* =========================
   HEADER
========================= */
.top{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}

.logo{
  font-size:14px;
  font-weight:800;
  margin:0;
  letter-spacing:.2px;
  text-transform:uppercase;
  color:var(--text-3);
}
.pageTitle{
  font-size:22px;
  font-weight:900;
  margin:4px 0 2px;
}
.sub{
  font-size:12px;
  color:var(--text-3);
  margin-top:2px;
}
.idBadge{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--surface-2);
  font-size:12px;
  font-weight:700;
}

.pageMeta{
  display:flex;
  flex-direction:column;
  gap:2px;
}

/* small section title inside cards */
.sectionTitle{
  font-weight:900;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
}
.sectionTitle::before{
  content:"";
  width:10px;height:10px;border-radius:4px;
  background:var(--brand-0);
  display:inline-block;
}

.muted{color:var(--text-3);font-size:12px}
.small{font-size:12px}

.cardHeader{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.cardTitle{
  font-weight:900;
  font-size:15px;
}
.cardDesc{
  font-size:12px;
  color:var(--text-3);
  margin-top:2px;
}

.block{
  padding:12px;
  border-radius:12px;
  border:1px dashed var(--border);
  background:var(--surface);
}
.blockTitle{
  font-weight:800;
  font-size:13px;
  margin-bottom:6px;
}
.blockDesc{
  font-size:12px;
  color:var(--text-3);
  margin-bottom:8px;
}

/* =========================
   LAYOUT COLUMNS
========================= */
.grid2{
  display:grid;
  grid-template-columns:1.1fr .9fr;
  gap:14px;
  align-items:start;
}
@media (max-width: 980px){
  .grid2{grid-template-columns:1fr}
}
.col{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* =========================
   ROWS / GRIDS
========================= */
.row{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.action-row{
  width:100%;
}
.action-row .btn{
  flex:1 1 180px;
  min-width:160px;
}
@media (max-width: 720px){
  .action-row .btn{
    flex:1 1 100%;
    min-width:100%;
  }
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media (max-width: 560px){
  .grid{grid-template-columns:1fr}
}

.bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:flex-end;
}

.pillGroup{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}

/* =========================
   INPUTS / SELECT / TEXTAREA
========================= */
label.lbl{
  font-size:12px;
  color:var(--text-3);
  display:block;
  margin-bottom:6px;
}

input[type="text"],
input[type="tel"],
input[type="number"],
input[type="date"],
input:not([type]),
select,
textarea{
  width:100%;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--surface-2);
  outline:none;
  font-size:13px;
  color:var(--text);
}

textarea{
  min-height:84px;
  overflow:hidden;
  resize:vertical;
}

input:focus,
select:focus,
textarea:focus{
  border-color: rgba(242,201,76,.9);
  box-shadow: var(--glow);
}

.compactInput{
  padding:9px 12px;
  border-radius:12px;
  font-size:13px;
}

/* Select nicer arrow */
select{
  appearance:none;
  background-image:
    linear-gradient(45deg, transparent 50%, #6b7280 50%),
    linear-gradient(135deg, #6b7280 50%, transparent 50%),
    linear-gradient(to right, transparent, transparent);
  background-position:
    calc(100% - 18px) calc(50% - 2px),
    calc(100% - 12px) calc(50% - 2px),
    100% 0;
  background-size:6px 6px, 6px 6px, 2.5em 2.5em;
  background-repeat:no-repeat;
  padding-right:38px;
}

/* =========================
   SPECS EDITOR
========================= */
.specsToolbar{
  display:none;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.specsToolbar.is-visible{
  display:flex;
}
.specsEditor{
  width:100%;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--surface-2);
  outline:none;
  font-size:13px;
  color:var(--text);
  min-height:120px;
  white-space:pre-wrap;
}
.specsEditor[contenteditable="false"]{
  background:var(--surface);
}
.specsEditor:empty:before{
  content: attr(placeholder);
  color:var(--text-3);
  white-space:pre-line;
}

/* =========================
   PILLS
========================= */
.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--surface);
  font-size:12px;
  color:var(--text-3);
}
.pill b{color:var(--text)}

/* =========================
   WARN BLOCK
========================= */
.warn{
  border:1px solid #fde68a;
  background:#fffbeb;
  border-radius:14px;
  padding:10px 12px;
  color:#92400e;
  font-size:13px;
}

/* =========================
   TABLES (INFO + LOG)
========================= */
#info, #log{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:6px;
}
#info td, #log td{
  border-bottom:1px solid var(--border);
  padding:10px 0;
  vertical-align:top;
}
#info td.lbl{
  width:38%;
  color:var(--text-3);
  font-size:12px;
  padding-right:10px;
}

/* LOG "no records" line */
#log .muted{
  padding:8px 0;
  display:block;
}

/* =========================
   PHOTOS GRID (FROM BASE)
========================= */
.photosHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}

.photosGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}
@media (max-width: 980px){.photosGrid{grid-template-columns:repeat(2,1fr)}}
@media (max-width: 520px){.photosGrid{grid-template-columns:1fr}}

.ph{
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  background:var(--surface-2);
}
.ph img{
  width:100%;
  height:120px;
  object-fit:cover;
  display:block;
  cursor:zoom-in;
}
.ph .cap{
  padding:8px 10px;
  font-size:12px;
  color:var(--text-3);
  border-top:1px solid var(--border);
}

/* =========================
   PAGER
========================= */
.pager{
  display:flex;
  align-items:center;
  gap:8px;
}
.pagerInfo{
  font-size:12px;
  color:var(--text-3);
  padding:0 6px;
}

/* =========================
   FILE INPUT (–í–ê–ñ–ù–û!)
   –¥–µ–ª–∞–µ—Ç "–í—ã–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏" –∫—Ä–∞—Å–∏–≤–æ–π –∫–Ω–æ–ø–∫–æ–π
========================= */
input[type="file"]{
  width:auto;
  max-width:100%;
  font-size:12px;
  color:var(--text-3);
  padding:6px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--surface-2);
}
input[type="file"]::file-selector-button{
  border:1px solid var(--border);
  background:var(--surface);
  padding:8px 10px;
  border-radius:12px;
  cursor:pointer;
  margin-right:10px;
  color:var(--text);
  font-weight:700;
  transition: box-shadow .12s ease, border-color .12s ease;
}
input[type="file"]::file-selector-button:hover{
  border-color:#d1d5db;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}

/* =========================
   STATUS PREVIEW GRID (—Å –≥–∞–ª–µ—Ä–µ–∏/–∫–∞–º–µ—Ä—ã)
========================= */
.previewGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}
@media (max-width: 980px){.previewGrid{grid-template-columns:repeat(2,1fr)}}
@media (max-width: 520px){.previewGrid{grid-template-columns:1fr}}

.prevItem{
  position:relative;
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  background:var(--surface-2);
}
.prevItem img{
  width:100%;
  height:120px;
  object-fit:cover;
  display:block;
}
.prevItem video{
  width:100%;
  height:120px;
  object-fit:cover;
  display:block;
  background:#000;
}
.prevDel{
  position:absolute;
  top:8px;
  right:8px;
  width:30px;
  height:30px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(17,24,39,.65);
  color:#fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.prevDel:hover{
  background:rgba(17,24,39,.85);
}

/* =========================
   CAMERA BOX
========================= */
.cameraBox{
  display:none;
  margin-top:12px;
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  background:#000;
  position:relative;
}
#camVideo{
  width:100%;
  height:100%;
  display:block;
  object-fit:cover;
}
.cameraControls{
  position:absolute;
  inset:auto 0 0 0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:10px;
  background:linear-gradient(to top, rgba(0,0,0,.7), rgba(0,0,0,0));
}
.cameraControlsGroup{
  display:flex;
  align-items:center;
  gap:10px;
  flex:1;
}
.cameraControlsGroup.center{
  justify-content:center;
}
.cameraControlsGroup.right{
  justify-content:flex-end;
}
.cameraBtn{
  width:44px;
  height:44px;
  border-radius:50%;
  padding:0;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:rgba(17,24,39,.8);
  border:1px solid rgba(255,255,255,.2);
  color:#fff;
  font-size:20px;
  line-height:1;
}
.cameraBtn:hover{
  background:rgba(17,24,39,.95);
}
.cameraBtn.capture{
  width:56px;
  height:56px;
  font-size:22px;
  background:rgba(242,201,76,.95);
  color:#111827;
  border-color:rgba(0,0,0,.12);
}
.cameraBtn.capture:hover{
  background:rgba(242,201,76,1);
}
.cameraControls{
  position:absolute;
  inset:auto 0 0 0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:10px;
  background:linear-gradient(to top, rgba(0,0,0,.7), rgba(0,0,0,0));
}
.cameraControls .btn{
  background:rgba(17,24,39,.8);
  border-color:rgba(255,255,255,.2);
  color:#fff;
}
.cameraControls .btn:hover{
  background:rgba(17,24,39,.95);
}

/* =========================
   HINTS
========================= */
.hintLine{
  margin-top:8px;
  font-size:12px;
  color:var(--text-3);
}

/* =========================
   LIGHTBOX
========================= */
.lb{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999
}
.lbInner{
  width:min(980px, 92vw);
  height:min(90vh, 700px);
  background:#111;
  border-radius:18px;
  overflow:hidden;
  display:flex;
  flex-direction:column
}
.lbTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  color:#fff
}
.lbBtns{display:flex;gap:8px}
.lbBtn{
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  color:#fff;
  padding:8px 10px;
  border-radius:12px;
  cursor:pointer
}
.lbBtn:hover{background:rgba(255,255,255,.12)}
.lbImgWrap{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:8px
}
.lbImg{
  max-width:100%;
  max-height:100%;
  object-fit:contain
}
</style>


</head>
<body>
  <div class="wrap">

    <!-- TOP -->
    <div class="top">
      <div class="pageMeta">
        <div class="logo">Surpresso Service</div>
        <div class="pageTitle">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è–º</div>
        <div class="sub">–ü–∞—Å–ø–æ—Ä—Ç, —Å—Ç–∞—Ç—É—Å–∏, —Ñ–æ—Ç–æ —Ç–∞ –∑–∞–ø–∏—Ç–∏ –≤ –æ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ</div>
      </div>
      <div class="idBadge">ID: <b id="eqId">‚Äî</b></div>
    </div>

    <!-- NO ID -->
    <div id="noId" class="card" style="display:none">
      <div class="warn">–ù–µ–º–∞—î ID. –í—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫—É —è–∫: <b>equip.html?id=...</b></div>
    </div>

    <!-- MAIN -->
    <div id="main" style="display:none">

      <div class="grid2">

        <!-- LEFT COLUMN -->
        <div class="col">

          <!-- STATUS HEADER CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω</div>
                <div class="cardDesc">–®–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥ —ñ –¥—ñ—ó –∑ –ø–∞—Å–ø–æ—Ä—Ç–æ–º</div>
              </div>
              <div class="row action-row">
                <button class="btn ghost" id="btnPdf">üìÑ –ü–∞—Å–ø–æ—Ä—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</button>
                <button class="btn primary" id="btnRefresh">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
                <button class="btn ghost" id="btnPrint">üñ® –ë–ª–∞–Ω–∫</button>
              </div>
            </div>

            <div>
              <div class="muted">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å</div>
              <div style="font-size:18px;font-weight:900" id="curStatus">‚Äî</div>
              <div class="muted" id="updatedAt"></div>
            </div>

            <div class="pillGroup">
              <span class="pill" id="pillOwner">owner: ‚Äî</span>
              <span class="pill" id="pillType">type: ‚Äî</span>
            </div>
          </div>

          <!-- CHANGE STATUS CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É</div>
                <div class="cardDesc">–§—ñ–∫—Å—É–π –ø—Ä–æ–≥—Ä–µ—Å —Ç–∞ –¥–æ–¥–∞–≤–∞–π –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ</div>
              </div>
            </div>

            <div class="grid">
              <div>
                <label class="lbl">–ù–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å</label>
                <select id="statusSelect"></select>
              </div>

              <div>
                <label class="lbl">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                <input id="comment" placeholder="–ù–∞–ø—Ä: –ó–∞–±—Ä–∞–≤ –∫–ª—ñ—î–Ω—Ç, –≤—ñ–¥–¥–∞–ª–∏ –≤ –æ—Ä–µ–Ω–¥—É..." />
              </div>
            </div>

            <div class="row" style="margin-top:10px; justify-content:space-between;">
              <select id="actor" class="compactInput" style="flex:1;min-width:220px"></select>
              <button class="btn primary" id="btnStatus">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
              <span class="muted" id="statusHint"></span>
            </div>

            <!-- PHOTO FOR STATUS -->
            <div class="block" style="margin-top:14px">
              <div class="blockTitle">üì∏ –§–æ—Ç–æ –¥–æ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É</div>
              <div class="blockDesc">
                –¶–µ —Ñ–æ—Ç–æ –ø—ñ–¥–µ —Ä–∞–∑–æ–º –∑—ñ –∑–º—ñ–Ω–æ—é —Å—Ç–∞—Ç—É—Å—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–µ—Ä–≤–µ—Ä —Å–∞–º –≤–∏—Ä—ñ—à–∏—Ç—å, —á–∏ —Ä–æ–±–∏—Ç–∏ –ø–æ—Å—Ç–∏–Ω–≥ —É Telegram.
              </div>

              <div class="row" style="margin-top:10px; justify-content:space-between">
                <div class="row" style="gap:8px;">
                  <button class="btn ghost" id="btnCamOpen">üì∑ –ö–∞–º–µ—Ä–∞</button>
                  <button class="btn danger" id="btnClearStatusPhotos" style="display:none">üóë –û—á–∏—Å—Ç–∏—Ç–∏</button>
                </div>

                <div class="row" style="gap:8px;">
                  <input type="file" id="statusPhotoFiles" accept="image/*" multiple />
                  <button class="btn primary" id="btnAddStatusFiles">‚ûï –î–æ–¥–∞—Ç–∏ –∑ –≥–∞–ª–µ—Ä–µ—ó</button>
                </div>
              </div>

              <div class="hintLine">
                –ú–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –æ–¥—Ä–∞–∑—É <b>3‚Äì5 —Ñ–æ—Ç–æ</b> (–∞–±–æ –±—ñ–ª—å—à–µ). –†–µ–∫–æ–º–µ–Ω–¥—É—é –º–∞–∫—Å–∏–º—É–º <b>10</b> –∑–∞ —Ä–∞–∑.
              </div>

              <div class="cameraBox" id="cameraBox">
                <video id="camVideo" autoplay playsinline></video>
                <canvas id="camCanvas" style="display:none;"></canvas>
                <div class="cameraControls">
                  <div class="row" style="gap:8px;">
                    <button class="btn ghost" id="btnTorch" style="display:none">üí° –°–≤—ñ—Ç–ª–æ</button>
                  </div>
                  <div class="row" style="gap:8px;">
                    <button class="btn ghost" id="btnCapture" style="display:none">üì∏ –ó–Ω—è—Ç–∏</button>
                    <button class="btn ghost" id="btnCamToggle" style="display:none">‚èπ –ó–∞–∫—Ä–∏—Ç–∏</button>
                  </div>
                </div>
              </div>

              <div id="statusPhotosHint" class="muted" style="margin-top:8px"></div>
              <div id="statusPreview" class="previewGrid" style="display:none"></div>
            </div>

          </div>

          <!-- RE-INTAKE CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–ü–æ–≤—Ç–æ—Ä–Ω–∏–π –ø—Ä–∏–π–æ–º (TG + Trello)</div>
                <div class="cardDesc">–°—Ç–≤–æ—Ä–∏ –Ω–æ–≤–∏–π –ø—Ä–∏–π–æ–º –±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>
              </div>
              <div class="muted" id="reHint"></div>
            </div>

            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
              <input type="file" id="reFiles" accept="image/*" multiple />
              <input id="reComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–∞–ø—Ä: –ø–æ–≤–µ—Ä–Ω—É–ª–æ—Å—å –∑ –æ—Ä–µ–Ω–¥–∏)" style="flex:1;min-width:220px"/>
              <button class="btn primary" id="btnReSend">üì© –í TG + Trello</button>
            </div>

            <div class="muted" style="margin-top:6px">
              –í—ã–±–µ—Ä–∏ 3‚Äì5 —Å–≤–µ–∂–∏—Ö —Ñ–æ—Ç–æ (–º–æ–∂–Ω–æ –±–æ–ª—å—à–µ) –∏ –æ—Ç–ø—Ä–∞–≤—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –∫–∞–∫ –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º.
            </div>
          </div>

          <!-- APPROVAL REQUEST CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–ó–∞–ø–∏—Ç –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è</div>
                <div class="cardDesc">–ü–æ–≥–æ–¥–∂–µ–Ω–Ω—è —Ä–æ–±—ñ—Ç –∞–±–æ —Å—É–º –∑ –∫–ª—ñ—î–Ω—Ç–æ–º</div>
              </div>
              <div class="muted" id="approvalHint"></div>
            </div>

            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
              <textarea id="approvalText" placeholder="–û–ø–∏—à–∏, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–≥–æ–¥–∏—Ç–∏ (—Å—É–º–∞, —Ä–æ–±–æ—Ç–∏, –¥–µ—Ç–∞–ª—ñ)" style="flex:1;min-width:240px"></textarea>
            </div>

            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap;align-items:center;">
              <input type="file" id="approvalPhotoFiles" accept="image/*" multiple />
              <div class="muted">–î–æ–¥–∞–π 1‚Äì2 —Ñ–æ—Ç–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏</div>
            </div>

            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
              <select id="approvalActor" class="compactInput" style="flex:1;min-width:220px"></select>
              <button class="btn primary" id="btnApprovalSend">‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Ç</button>
            </div>

            <div class="muted" style="margin-top:6px">
              –ó–∞–ø–∏—Ç –ø—ñ–¥–µ –∫–ª—ñ—î–Ω—Ç—É –≤ Telegram —ñ–∑ –∫–Ω–æ–ø–∫–∞–º–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.
            </div>
          </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="col">

          <!-- INFO CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>
                <div class="cardDesc">–û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è —Ç–∞ –∫–ª—ñ—î–Ω—Ç–∞</div>
              </div>
              <div class="muted" id="infoHint"></div>
            </div>
            <table id="info"></table>
          </div>

          <!-- SPECS CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–¢–µ—Ö–Ω—ñ—á–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
                <div class="cardDesc">–û–Ω–æ–≤–ª—é–π —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–ª—è –ø–∞—Å–ø–æ—Ä—Ç—É</div>
              </div>
              <div class="row" style="gap:8px; align-items:center;">
                <div class="muted" id="specsHint"></div>
                <button class="btn ghost" id="btnEditSpecs" type="button"></button>
              </div>
            </div>

            <div class="specsToolbar" role="toolbar" aria-label="–§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ–π">
              <button class="btn ghost" type="button" data-specs-cmd="bold"><b>–ñ–∏—Ä–Ω–∏–π</b></button>
              <button class="btn ghost" type="button" data-specs-cmd="h3">–ó–∞–≥–æ–ª–æ–≤–æ–∫</button>
              <button class="btn ghost" type="button" data-specs-cmd="ul">–°–ø–∏—Å–æ–∫</button>
              <button class="btn ghost" type="button" data-specs-cmd="br">–†—è–¥–æ–∫</button>
            </div>

            <label class="lbl" for="specsInput">–í–∫–∞–∂—ñ—Ç—å —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–∞–≤–æ–º–∞—à–∏–Ω–∏</label>
            <div
              id="specsInput"
              class="specsEditor"
              contenteditable="false"
              role="textbox"
              aria-multiline="true"
              placeholder="–¢–ï–•–ù–Ü–ß–ù–Ü –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò&#10;&#10;–ú–æ–¥–µ–ª—å ‚Äî E92 Elite&#10;–í–∏—Ä–æ–±–Ω–∏–∫ ‚Äî Faema&#10;–ö—Ä–∞—ó–Ω–∞ ‚Äî –Ü—Ç–∞–ª—ñ—è&#10;–û–±'–µ–º –±–æ–π–ª–µ—Ä–∞ ‚Äî 11 –ª&#10;–í–∞–≥–∞ ‚Äî 65 –∫–≥&#10;–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å ‚Äî 5100 –í—Ç&#10;–ù–∞–ø—Ä—É–≥–∞ ‚Äî 230/380 –í&#10;–†–æ–∑–º—ñ—Ä–∏ (–®—Ö–í—Ö–ì) ‚Äî 720x520x560–º–º&#10;–¢–∏–ø: –∞–≤—Ç–æ–º–∞—Ç&#10;–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä—É–ø–ø: 2&#10;–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±–æ–π–ª–µ—Ä—ñ–≤: 1&#10;–ü–æ–º–ø–∞ –≤–±—É–¥–æ–≤–∞–Ω–∞&#10;&#10;–ñ–∏–¥–∫–æ–∫—Ä–∏—Å—Ç–∞–ª—ñ—á–Ω–∏–π –¥–∏—Å–ø–ª–µ–π ‚Äî —Ç–∞–∫&#10;&#10;–¢–∏—Å–∫ –Ω–∞ –∑–∞–≤–∞—Ä—é–≤–∞–Ω–Ω—ñ ‚Äî 8,5 bar&#10;–¢–∏—Å–∫ –Ω–∞ —Å–ª—ñ–ø–æ–º—É —Å–∏—Ç—ñ ‚Äî 12 bar"
            ></div>

            <div class="row" style="margin-top:10px; justify-content:flex-end;">
              <button class="btn primary" id="btnSaveSpecs">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</button>
            </div>

            <div class="hintLine">
              –ú–æ–∂–Ω–∞ –≤—Å—Ç–∞–≤–∏—Ç–∏ –≥–æ—Ç–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ –∞–±–æ –æ—Ñ–æ—Ä–º–∏—Ç–∏ —Ç–µ–∫—Å—Ç: –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–∫–∏.
            </div>
          </div>

          <!-- INVOICE CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–†–∞—Ö—É–Ω–æ–∫</div>
                <div class="cardDesc">–í—ñ–¥–ø—Ä–∞–≤ —Ä–∞—Ö—É–Ω–æ–∫ –∫–ª—ñ—î–Ω—Ç—É —Ç–µ–∫—Å—Ç–æ–º —á–∏ —Ñ–∞–π–ª–æ–º</div>
              </div>
              <div class="muted" id="invoiceHint"></div>
            </div>

            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
              <textarea id="invoiceText" placeholder="–¢–µ–∫—Å—Ç–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫ (—Å—É–º–∞, —Ä–æ–±–æ—Ç–∏, —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏)" style="flex:1;min-width:240px"></textarea>
            </div>

            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap;align-items:center;">
              <input type="file" id="invoiceFile" accept=".pdf,image/*" />
              <button class="btn primary" id="btnInvoiceSend">üìÑ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</button>
            </div>

            <div class="muted" style="margin-top:6px">
              –ú–æ–∂–Ω–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–µ–∫—Å—Ç–æ–º, —Ñ–∞–π–ª–æ–º –∞–±–æ —Ä–∞–∑–æ–º.
            </div>
          </div>

          <!-- PHOTOS CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–§–æ—Ç–æ (–∑ –±–∞–∑–∏)</div>
                <div class="cardDesc">–û—Å—Ç–∞–Ω–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é —Å—Ç–∞–Ω—É</div>
              </div>
              <div class="row" style="gap:8px; flex:1; justify-content:flex-end">
                <input type="file" id="photoFiles" accept="image/*" multiple />
                <button class="btn ghost" id="btnPhotoAlbum">üñºÔ∏è –§–æ—Ç–æ–∞–ª—å–±–æ–º</button>
                <button class="btn primary" id="btnUploadPhotos">üì§ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –≤ –±–∞–∑—É</button>
              </div>
            </div>

            <div class="muted" style="margin-top:6px">
              –ú–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –æ–¥—Ä–∞–∑—É <b>3‚Äì5 —Ñ–æ—Ç–æ</b> (–∞–±–æ –±—ñ–ª—å—à–µ). –ü–æ–∫–∞–∑—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ <b>10</b> –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é.
            </div>

            <div class="row" style="margin-top:10px; align-items:center; justify-content:space-between">
              <div class="muted" id="photosHint"></div>

              <div class="pager">
                <button class="btn ghost" id="btnPrevPhotos">‚Üê</button>
                <div class="pagerInfo" id="photosPageInfo">–§–æ—Ç–æ: 0</div>
                <button class="btn ghost" id="btnNextPhotos">‚Üí</button>
              </div>
            </div>

            <div class="photosGrid" id="photos"></div>
          </div>

          <!-- LOG CARD -->
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤</div>
                <div class="cardDesc">–•—Ä–æ–Ω–æ–ª–æ–≥—ñ—è –∑–º—ñ–Ω –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏</div>
              </div>
            </div>
            <table id="log"></table>
          </div>

        </div>

      </div>
    </div>

  </div>

  <!-- LIGHTBOX -->
  <div class="lb" id="lightbox" onclick="closeLightbox(event)">
    <div class="lbInner">
      <div class="lbTop">
        <div class="lbTitle" id="lbTitle">–§–æ—Ç–æ</div>
        <div class="lbBtns">
          <button class="lbBtn" id="lbOpenDrive" onclick="openDriveFromLightbox(event)">–í—ñ–¥–∫—Ä–∏—Ç–∏ –≤ Drive</button>
          <button class="lbBtn" onclick="forceCloseLightbox(event)">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
      <div class="lbImgWrap">
        <img class="lbImg" id="lbImg" src="" alt="">
      </div>
    </div>
  </div>

  <!-- –¢–í–û–ô <script> –û–°–¢–ê–Å–¢–°–Ø –ù–ò–ñ–ï –ö–ê–ö –ï–°–¢–¨ -->

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const PWA_KEY_STORAGE = "surpresso_pwa_key";
    const API_BASE = ""; // same domain
    const USER_SHEET_ID  = "1TcDW8xV_-wdkBdK0FNCVmK-ZiHahnnsB9JsXvEUBA1s";
    const USER_SHEET_GID = 0;

    let USERS = [];

    function getUserDisplayName(user) {
      return (user?.name || user?.login || "").trim();
    }

    function getUniqueUserNames() {
      const seen = new Set();
      return USERS.map(getUserDisplayName)
        .filter(Boolean)
        .filter(name => {
          if (seen.has(name)) return false;
          seen.add(name);
          return true;
        });
    }

    function parseCsv(text) {
      const rows = [];
      let row = [];
      let value = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];

        if (char === "\"") {
          if (inQuotes && next === "\"") {
            value += "\"";
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (!inQuotes && (char === "," || char === "\n")) {
          row.push(value);
          value = "";

          if (char === "\n") {
            rows.push(row);
            row = [];
          }
          continue;
        }

        if (char === "\r") continue;
        value += char;
      }

      row.push(value);
      rows.push(row);
      return rows;
    }

    async function loadUsers() {
      const url = `https://docs.google.com/spreadsheets/d/${USER_SHEET_ID}/export?format=csv&gid=${USER_SHEET_GID}`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const text = await resp.text();
        const rows = parseCsv(text);
        const headers = (rows.shift() || []).map(h => h.trim().toLowerCase());
        USERS = rows
          .filter(r => r.some(cell => String(cell || "").trim()))
          .map(r => {
            const obj = {};
            headers.forEach((h, idx) => {
              obj[h] = (r[idx] || "").trim();
            });
            return {
              login: (obj.login || "").trim(),
              pass: (obj.pass || "").trim(),
              name: (obj.name || "").trim(),
              role: (obj.role || "").trim()
            };
          });

        populateActorSelect();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", e);
      }
    }

    function populateActorSelect() {
      const selects = [$("actor"), $("approvalActor")].filter(Boolean);
      if (!selects.length) return;
      const names = getUniqueUserNames();

      const savedUser = localStorage.getItem("surp_user");
      const preferred = savedUser ? getUserDisplayName(JSON.parse(savedUser)) : "";
      const current = selects[0]?.value || preferred;

      selects.forEach((select) => {
        select.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = select.id === "approvalActor"
          ? "–•—Ç–æ –≤—ñ–¥–ø—Ä–∞–≤–∏–≤ (–æ–ø—Ü.)"
          : "–•—Ç–æ –∑–º—ñ–Ω–∏–≤ (–æ–ø—Ü.)";
        select.appendChild(placeholder);

        names.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          if (name === current) opt.selected = true;
          select.appendChild(opt);
        });

        if (current && !names.includes(current)) {
          const opt = document.createElement("option");
          opt.value = current;
          opt.textContent = current;
          opt.selected = true;
          select.appendChild(opt);
        }
      });
    }

    const PHOTOS_PAGE_SIZE = 10;

    const DEFAULT_STATUSES_CLIENT = [
      "–ü—Ä–∏–π–Ω—è—Ç–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç",
      "–í —Ä–æ–±–æ—Ç—ñ",
      "–ì–æ—Ç–æ–≤–æ",
      "–í–∏–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç—É"
    ];

    const DEFAULT_STATUSES_COMPANY = [
      "–ë—Ä–æ–Ω—å –∫ –ø—Ä–æ–¥–∞–∂–µ",
      "–ë—Ä–æ–Ω—å –∫ –∞—Ä–µ–Ω–¥–µ",
      "–ì–æ—Ç–æ–≤–æ –∫ –∞—Ä–µ–Ω–¥–µ",
      "–£–µ—Ö–∞–ª–æ –Ω–∞ –∞—Ä–µ–Ω–¥—É",
      "–ü—Ä–∏–µ—Ö–∞–ª–æ –ø–æ—Å–ª–µ –∞—Ä–µ–Ω–¥—ã",
      "–£–µ—Ö–∞–ª–æ –Ω–∞ –ø–æ–¥–º–µ–Ω—É",
      "–ü—Ä–∏–µ—Ö–∞–ª–æ —Å –ø–æ–¥–º–µ–Ω—ã",
      "–ü—Ä–æ–¥–∞–Ω–æ"
    ];

    const $ = (id) => document.getElementById(id);

    // ===========================
    // GET ID FROM URL
    // ===========================
    const params = new URLSearchParams(location.search);
    const EQUIPMENT_ID = (params.get("id") || "").trim();
    
    if (!EQUIPMENT_ID) {
      $("noId").style.display = "block";
    } else {
      $("main").style.display = "block";
      $("eqId").textContent = EQUIPMENT_ID;

      $("btnRefresh").onclick = load;
      $("btnStatus").onclick = saveStatus;

      $("btnUploadPhotos").onclick = uploadPhotosMulti;
      $("btnPrevPhotos").onclick = () => { photosPage--; renderPhotos(); };
      $("btnNextPhotos").onclick = () => { photosPage++; renderPhotos(); };
      $("btnSaveSpecs").onclick = saveSpecs;
      initSpecsEditor();

      $("btnPdf").onclick = () => {
  // ‚úÖ –Ω–æ–≤—ã–π –ø–∞—Å–ø–æ—Ä—Ç (–¥–∏–Ω–∞–º–∏–∫–∞)
  location.href = `/passport.html?id=${encodeURIComponent(EQUIPMENT_ID)}`;
};


      // status photos controls
      $("btnCamOpen").onclick = startCamera;
      $("btnCamToggle").onclick = stopCamera;
      $("btnCapture").onclick = captureStatusPhoto;
      $("btnTorch").onclick = toggleTorch;
      $("btnAddStatusFiles").onclick = addStatusFiles;
      $("btnClearStatusPhotos").onclick = clearStatusPhotos;
      $("btnApprovalSend").onclick = sendApprovalRequest;
      $("btnPhotoAlbum").onclick = sendPhotoAlbum;
      $("btnInvoiceSend").onclick = sendInvoice;

      load();
    }

    loadUsers();

    // ===========================
    // AUTH
    // ===========================
    function getKey() {
      return localStorage.getItem(PWA_KEY_STORAGE) || "";
    }

    function ensureKey() {
      let k = getKey();
      if (k) return k;
      k = (prompt("–í–≤–µ–¥–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É (PWA Key):") || "").trim();
      if (!k) return "";
      localStorage.setItem(PWA_KEY_STORAGE, k);
      return k;
    }

    function headersWithKey() {
      const k = ensureKey();
      return k ? { "x-surpresso-key": k } : {};
    }

    function withKeyQuery() {
      const k = ensureKey();
      if (!k) return "";
      return `?k=${encodeURIComponent(k)}`;
    }

    // ===========================
    // API wrapper
    // ===========================
    async function apiGet(url) {
      const resp = await fetch(url, { headers: headersWithKey() });
      return await resp.json();
    }

    async function apiPost(url, payload) {
      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...headersWithKey()
        },
        body: JSON.stringify(payload || {})
      });
      return await resp.json();
    }

    // ===========================
    // LOAD & RENDER
    // ===========================
    let LAST_EQUIPMENT = null;
    let CURRENT_OWNER = "";
    let allPhotos = [];
    let photosPage = 0;

    async function load() {
      $("statusHint").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      const data = await apiGet(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}`);

      if (!data.ok) {
        $("statusHint").textContent = "";
        return alert(data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è");
      }

      render(data);
      $("statusHint").textContent = "";
    }

    function render(data) {
      const eq = data.equipment || {};
      LAST_EQUIPMENT = eq;
      
      allPhotos = Array.isArray(data.photos) ? data.photos : [];
      const log = data.log || [];

      CURRENT_OWNER = eq.owner || "";

      $("curStatus").textContent = eq.status || "‚Äî";
      $("updatedAt").textContent = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + fmt(eq.updatedAt);

      $("pillOwner").textContent = "owner: " + (eq.owner || "‚Äî");
      $("pillType").textContent = "type: " + (eq.type || "‚Äî");

      // statuses by owner
      const statuses = buildStatusesFor(eq);
      fillStatuses(statuses, eq.status);

      // info table
      const rows = [];
      const add = (k, v) => rows.push(`<tr><td class="lbl">${k}</td><td>${esc(v)}</td></tr>`);

      add("–¢–∏–ø", eq.type || "‚Äî");
      add("–í–ª–∞—Å–Ω–∏–∫", eq.owner || "‚Äî");
      if (String(eq.isContract) === "true") add("–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è", "–ó–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º ‚úÖ");

      if (eq.owner === "client") {
        add("–ö–ª—ñ—î–Ω—Ç", eq.clientName || "‚Äî");
        add("–¢–µ–ª–µ—Ñ–æ–Ω", eq.clientPhone || "‚Äî");
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.clientLocation || "‚Äî");
        add("–ú–æ–¥–µ–ª—å", eq.model || "‚Äî");
        add("–°–µ—Ä—ñ–π–Ω–∏–π", eq.serial || "‚Äî");
      } else {
        add("–õ–æ–∫–∞—Ü—ñ—è (–∑–∞–∫–ª–∞–¥/—Ü–µ—Ö)", eq.companyLocation || "‚Äî");
        add("–ù–∞–∑–≤–∞", eq.name || "‚Äî");
        add("–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ‚Ññ", eq.internalNumber || "‚Äî");
      }

      add("–û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", eq.lastComment || "‚Äî");

      $("info").innerHTML = rows.join("");

      // specs
      loadSpecs(eq);

      // photos render (pagination)
      photosPage = 0;
      renderPhotos();

      // log render
      $("log").innerHTML = log.length
        ? log.map(r => `
          <tr>
            <td style="width:160px">${fmt(r.ts)}</td>
            <td><b>${esc(r.newStatus)}</b>
              ${r.comment ? "‚Äî " + esc(r.comment) : ""}
              ${r.actor ? `<span class="muted">(${esc(r.actor)})</span>` : ""}
            </td>
          </tr>
        `).join("")
        : `<tr><td class="muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</td></tr>`;
    }

    function buildStatusesFor(eq) {
      if (eq.owner === "company") return DEFAULT_STATUSES_COMPANY;
      return DEFAULT_STATUSES_CLIENT;
    }

    function fillStatuses(list, current) {
      const sel = $("statusSelect");
      sel.innerHTML = "";
      list.forEach(s => {
        const o = document.createElement("option");
        o.value = s;
        o.textContent = s;
        sel.appendChild(o);
      });

      if (current && list.includes(current)) sel.value = current;
      else sel.value = list[0] || "";
    }

    // ===========================
    // SPECS
    // ===========================
    function initSpecsEditor() {
      const editor = $("specsInput");
      const editBtn = $("btnEditSpecs");
      const toolbar = document.querySelector(".specsToolbar");
      if (!editor) return;

      if (editBtn) {
        editBtn.addEventListener("click", () => setSpecsEditMode(true));
      }

      document.querySelectorAll("[data-specs-cmd]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const cmd = btn.dataset.specsCmd;
          editor.focus();

          if (cmd === "bold") {
            document.execCommand("bold");
            return;
          }

          if (cmd === "h3") {
            document.execCommand("formatBlock", false, "h3");
            return;
          }

          if (cmd === "ul") {
            document.execCommand("insertUnorderedList");
            return;
          }

          if (cmd === "br") {
            document.execCommand("insertHTML", false, "<br>");
          }
        });
      });

      editor.addEventListener("paste", (event) => {
        const text = event.clipboardData?.getData("text/plain");
        if (text == null) return;
        event.preventDefault();
        document.execCommand("insertText", false, text);
      });

      editor.addEventListener("blur", () => {
        if (!editor.textContent.trim()) {
          editor.innerHTML = "";
        }
      });

      if (toolbar) toolbar.classList.remove("is-visible");
      setSpecsEditMode(false);
    }

    function loadSpecs(eq) {
      const serverSpecs = String(eq.specs || "").trim();
      const editor = $("specsInput");
      if (!editor) return;

      if (!serverSpecs) {
        editor.innerHTML = "";
        updateSpecsActionLabel();
        setSpecsEditMode(false);
        return;
      }

      if (/<[a-z][\s\S]*>/i.test(serverSpecs)) {
        editor.innerHTML = serverSpecs;
      } else {
        editor.textContent = serverSpecs;
      }

      updateSpecsActionLabel();
      setSpecsEditMode(false);
    }

    function updateSpecsActionLabel() {
      const editor = $("specsInput");
      const btn = $("btnEditSpecs");
      if (!editor || !btn) return;
      const hasContent = !!editor.textContent.trim();
      btn.textContent = hasContent ? "‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏" : "‚ûï –î–æ–¥–∞—Ç–∏";
    }

    function normalizeSpecsHtml(html) {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = html;
      const text = wrapper.textContent.replace(/\u00a0/g, " ").trim();
      if (!text) return "";
      return html;
    }

    function setSpecsEditMode(enabled) {
      const editor = $("specsInput");
      const btn = $("btnEditSpecs");
      const toolbar = document.querySelector(".specsToolbar");
      if (!editor || !btn || !toolbar) return;
      editor.setAttribute("contenteditable", enabled ? "true" : "false");
      toolbar.classList.toggle("is-visible", enabled);
      btn.disabled = enabled;
      if (enabled) {
        editor.focus();
      }
    }

    async function saveSpecs() {
      const value = normalizeSpecsHtml($("specsInput").innerHTML || "");
      $("btnSaveSpecs").disabled = true;
      $("specsHint").textContent = "–ó–±–µ—Ä—ñ–≥–∞—é...";

      try {
        const out = await apiPost(
          `${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/specs`,
          { specs: value }
        );

        if (!out.ok) throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");

        if (LAST_EQUIPMENT) LAST_EQUIPMENT.specs = value;

        $("specsHint").textContent = "‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Google Drive";
        setTimeout(() => {
          $("specsHint").textContent = "";
        }, 2000);
        updateSpecsActionLabel();
        setSpecsEditMode(false);
      } catch (e) {
        console.error(e);
        $("specsHint").textContent = "";
        alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è"));
      } finally {
        $("btnSaveSpecs").disabled = false;
      }
    }

    // ===========================
    // PHOTOS: pagination + preview
    // ===========================
    function renderPhotos() {
      const total = allPhotos.length;
      const maxPage = Math.max(0, Math.ceil(total / PHOTOS_PAGE_SIZE) - 1);
      photosPage = Math.min(Math.max(photosPage, 0), maxPage);

      const start = photosPage * PHOTOS_PAGE_SIZE;
      const slice = allPhotos.slice(start, start + PHOTOS_PAGE_SIZE);

      $("photosPageInfo").textContent =
        total === 0 ? "–§–æ—Ç–æ: 0" : `–§–æ—Ç–æ ${start + 1}-${Math.min(start + PHOTOS_PAGE_SIZE, total)} / ${total}`;

      $("btnPrevPhotos").disabled = photosPage <= 0;
      $("btnNextPhotos").disabled = photosPage >= maxPage;

      if (!slice.length) {
        $("photos").innerHTML = `<div class="muted">–§–æ—Ç–æ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î.</div>`;
        return;
      }

      $("photos").innerHTML = slice.map((p) => {
        const driveViewUrl = String(p.url || "");
        const imgUrl = String(p.imgUrl || "") || driveToImageUrl(driveViewUrl);
        const cap = p.caption || "";
        const ts = fmt(p.ts);
        const safeCap = esc(cap || ts || "–§–æ—Ç–æ");
        const safeDrive = esc(driveViewUrl);

        const fresh = (imgUrl && imgUrl.includes("?")) ? `${imgUrl}&t=${Date.now()}` : `${imgUrl}?t=${Date.now()}`;

        return `
          <div class="ph">
            <img
              src="${fresh}"
              alt="${safeCap}"
              loading="lazy"
              onerror="this.onerror=null; this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px&quot; class=&quot;muted&quot;>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–µ–≤‚Äô—é. <a target=_blank href=&quot;${safeDrive}&quot;>–í—ñ–¥–∫—Ä–∏—Ç–∏</a></div>';"
              onclick="openLightbox('${escapeJs(fresh)}','${escapeJs(driveViewUrl)}','${escapeJs(safeCap)}')"
            >
            <div class="cap">${safeCap}</div>
          </div>
        `;
      }).join("");
    }

    // ‚úÖ –ü—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π proxy (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ img -> –∏—Å–ø–æ–ª—å–∑—É–µ–º ?k=...)
    function driveToImageUrl(driveUrl) {
      if (!driveUrl) return "";

      const s = String(driveUrl);
      let fileId = null;

      if (s.includes("uc?export=view&id=")) {
        const m = s.match(/id=([^&]+)/i);
        if (m) fileId = m[1];
      } else if (s.includes("/file/d/")) {
        const m = s.match(/\/file\/d\/([^\/]+)\//i);
        if (m) fileId = m[1];
      } else if (s.includes("id=")) {
        const m = s.match(/[?&]id=([^&]+)/i);
        if (m) fileId = m[1];
      }

      if (fileId) {
        const k = ensureKey();
        const q = k ? `?k=${encodeURIComponent(k)}` : "";
        return `${API_BASE}/proxy-drive/${encodeURIComponent(fileId)}${q}`;
      }

      return s;
    }

    // ===========================
    // LIGHTBOX
    // ===========================
    let LB_DRIVE_URL = "";
    function openLightbox(imgUrl, driveUrl, title) {
      LB_DRIVE_URL = driveUrl || "";
      $("lbImg").src = imgUrl || "";
      $("lbTitle").textContent = title || "–§–æ—Ç–æ";
      $("lightbox").style.display = "flex";
      $("lbOpenDrive").style.display = LB_DRIVE_URL ? "inline-flex" : "none";
    }

    function closeLightbox(e) {
      if (e.target && e.target.id === "lightbox") {
        $("lightbox").style.display = "none";
        $("lbImg").src = "";
        LB_DRIVE_URL = "";
      }
    }

    function forceCloseLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      $("lightbox").style.display = "none";
      $("lbImg").src = "";
      LB_DRIVE_URL = "";
    }

    function openDriveFromLightbox(e){
      e.preventDefault();
      e.stopPropagation();
      if (!LB_DRIVE_URL) return;
      window.open(LB_DRIVE_URL, "_blank");
    }

    // ===========================
    // ‚úÖ STATUS SAVE (+ fresh photos)
    // ===========================
    const LOCATION_REQUIRED_STATUSES = [
      "—É–µ—Ö–∞–ª–æ –Ω–∞ –∞—Ä–µ–Ω–¥—É",
      "–ø—Ä–æ–¥–∞–Ω–æ",
      "—É–µ—Ö–∞–ª–æ –Ω–∞ –ø–æ–¥–º–µ–Ω—É"
    ];

    function normalizeStatusValue(value) {
      return String(value || "").trim().toLowerCase();
    }

    function isLocationRequiredStatus(status) {
      return LOCATION_REQUIRED_STATUSES.includes(normalizeStatusValue(status));
    }

    function getCurrentLocationForPrompt() {
      if (!LAST_EQUIPMENT) return "";
      return (LAST_EQUIPMENT.owner === "company"
        ? LAST_EQUIPMENT.companyLocation
        : LAST_EQUIPMENT.clientLocation) || "";
    }

    function requestLocationForStatus(status) {
      if (!isLocationRequiredStatus(status)) return "";
      const location = prompt("–ö—É–¥–∞ —É–µ–∑–∂–∞–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?", getCurrentLocationForPrompt());
      if (location === null) return null;
      return String(location || "").trim();
    }

    async function saveStatus() {
      const newStatus = $("statusSelect").value;
      const comment = $("comment").value.trim();
      const actor = $("actor").value.trim();
      const photos = statusPhotos.slice(0, 10);
      const location = requestLocationForStatus(newStatus);

      if (location === null) return;
      if (isLocationRequiredStatus(newStatus) && !location) {
        alert("–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏, –∫—É–¥–∏ —É—ó—Ö–∞–ª–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è.");
        return;
      }

      $("btnStatus").disabled = true;
      $("statusHint").textContent = "–ó–±–µ—Ä—ñ–≥–∞—é...";

      const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/status`, {
        newStatus,
        comment,
        actor,
        photos,
        location
      });

      $("statusHint").textContent = "";
      if (!out.ok) {
        $("btnStatus").disabled = false;
        return alert(out.error || "–ü–æ–º–∏–ª–∫–∞");
      }

      if (photos.length) {
        try {
          $("statusHint").textContent = `–ó–±–µ—Ä—ñ–≥–∞—é ${photos.length} —Ñ–æ—Ç–æ...`;
          const photoOut = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/photo`, {
            photos,
            caption: "",
            skipNotify: true
          });

          if (!photoOut.ok) {
            throw new Error(photoOut.error || "–ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ");
          }
        } catch (e) {
          console.error(e);
          $("statusHint").textContent = "";
          $("btnStatus").disabled = false;
          return alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ"));
        }
      }

      $("comment").value = "";

      // ‚úÖ –æ—á–∏—â–∞–µ–º "—Å—Ç–∞—Ç—É—Å–Ω—ã–µ" —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —É–¥–∞—á–∏
      clearStatusPhotos();

      $("btnStatus").disabled = false;
      await load();
    }

    // ===========================
    // ‚úÖ STATUS PHOTOS: –∫–∞–º–µ—Ä–∞ + –≥–∞–ª–µ—Ä–µ—è
    // ===========================
    let statusPhotos = []; // base64
    let camStream = null;
    let torchOn = false;

    function updateStatusPhotosUI() {
      const has = statusPhotos.length > 0;
      $("statusPreview").style.display = has ? "grid" : "none";
      $("btnClearStatusPhotos").style.display = has ? "inline-flex" : "none";
      $("statusPhotosHint").textContent = has ? `–û–±—Ä–∞–Ω–æ —Ñ–æ—Ç–æ: ${statusPhotos.length}` : "";
      renderStatusPreview();
    }

    function renderStatusPreview() {
      if (!statusPhotos.length) {
        $("statusPreview").innerHTML = "";
        return;
      }

      $("statusPreview").innerHTML = statusPhotos.map((b64, idx) => {
        return `
          <div class="prevItem">
            <img src="${b64}" alt="photo_${idx}">
            <button class="prevDel" onclick="removeStatusPhoto(${idx})">‚úï</button>
          </div>
        `;
      }).join("");
    }

    function removeStatusPhoto(idx) {
      statusPhotos.splice(idx, 1);
      updateStatusPhotosUI();
    }

    function clearStatusPhotos() {
      statusPhotos = [];
      const input = $("statusPhotoFiles");
      if (input) input.value = "";
      updateStatusPhotosUI();
    }

    async function addStatusFiles() {
      const input = $("statusPhotoFiles");
      const files = input && input.files ? Array.from(input.files) : [];
      if (!files.length) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)");

      const MAX = 10;
      if (files.length + statusPhotos.length > MAX) {
        if (!confirm(`–ú–∞–∫—Å–∏–º—É–º ${MAX} —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É.\n–î–æ–¥–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —á–∞—Å—Ç–∏–Ω—É?`)) return;
      }

      const remain = Math.max(0, MAX - statusPhotos.length);
      const toAdd = files.slice(0, remain);

      $("statusPhotosHint").textContent = `–î–æ–¥–∞—é ${toAdd.length} —Ñ–æ—Ç–æ...`;

      try {
        for (let i = 0; i < toAdd.length; i++) {
          const base64 = await fileToBase64(toAdd[i]);
          statusPhotos.push(base64);
        }
        $("statusPhotosHint").textContent = "";
        updateStatusPhotosUI();
      } catch (e) {
        console.error(e);
        $("statusPhotosHint").textContent = "";
        alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ");
      } finally {
        input.value = "";
      }
    }

    async function sendApprovalRequest() {
      const text = String($("approvalText")?.value || "").trim();
      const actor = String($("approvalActor")?.value || "").trim();
      const files = Array.from($("approvalPhotoFiles")?.files || []);

      if (!text) {
        alert("–í–∫–∞–∂–∏ —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Ç—É");
        return;
      }
      if (files.length > 2) {
        if (!confirm("–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –º–∞–∫—Å–∏–º—É–º 2 —Ñ–æ—Ç–æ. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ 2?")) return;
      }
      const limited = files.slice(0, 2);
      const photos = [];
      for (let i = 0; i < limited.length; i++) {
        photos.push(await fileToBase64(limited[i]));
      }

      await postApprovalRequest(text, actor, photos);
    }

    async function postApprovalRequest(text, actor, photos) {
      $("btnApprovalSend").disabled = true;
      $("approvalHint").textContent = "–í—ñ–¥–ø—Ä–∞–≤–ª—è—é...";

      try {
        const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/approval`, {
          text,
          actor,
          photos
        });

        if (!out.ok) throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏");

        if (Number(out.sent || 0) <= 0) {
          $("approvalHint").textContent = "‚ö†Ô∏è –ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤";
          alert("‚ö†Ô∏è –ó–∞–ø–∏—Ç –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ‚Äî –∫–ª—ñ—î–Ω—Ç —â–µ –Ω–µ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –Ω–∞ –ø–∞—Å–ø–æ—Ä—Ç.");
        } else {
          $("approvalHint").textContent = "‚úÖ –ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ";
          setTimeout(() => {
            $("approvalHint").textContent = "";
          }, 2000);
        }
        $("approvalText").value = "";
        const photoInput = $("approvalPhotoFiles");
        if (photoInput) photoInput.value = "";
      } catch (e) {
        console.error(e);
        $("approvalHint").textContent = "";
        alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏"));
      } finally {
        $("btnApprovalSend").disabled = false;
      }
    }

    async function sendPhotoAlbum() {
      if (!allPhotos.length) {
        alert("–§–æ—Ç–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ ‚Äî —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ.");
        return;
      }

      $("btnPhotoAlbum").disabled = true;
      $("photosHint").textContent = "–°—Ç–≤–æ—Ä—é—é —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º...";

      try {
        const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/photo-album`, {
          limit: 10
        });

        if (!out.ok) throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º—É");

        $("photosHint").textContent = `‚úÖ –§–æ—Ç–æ–∞–ª—å–±–æ–º –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ (${out.sent || 0} —Ñ–æ—Ç–æ)`;
        setTimeout(() => {
          $("photosHint").textContent = "";
        }, 2500);
      } catch (e) {
        console.error(e);
        $("photosHint").textContent = "";
        alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º—É"));
      } finally {
        $("btnPhotoAlbum").disabled = false;
      }
    }

    async function sendInvoice() {
      const text = String($("invoiceText")?.value || "").trim();
      const fileInput = $("invoiceFile");
      const file = fileInput?.files?.[0] || null;

      if (!text && !file) {
        alert("–î–æ–¥–∞–π —Ç–µ–∫—Å—Ç –∞–±–æ —Ñ–∞–π–ª —Ä–∞—Ö—É–Ω–∫—É.");
        return;
      }

      $("btnInvoiceSend").disabled = true;
      $("invoiceHint").textContent = "–í—ñ–¥–ø—Ä–∞–≤–ª—è—é...";

      try {
        const fileData = file ? await fileToBase64(file) : "";
        const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/invoice`, {
          text,
          file: fileData
        });

        if (!out.ok) throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏");

        if (Number(out.sent || 0) <= 0) {
          $("invoiceHint").textContent = "‚ö†Ô∏è –ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤";
          alert("‚ö†Ô∏è –†–∞—Ö—É–Ω–æ–∫ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ‚Äî –∫–ª—ñ—î–Ω—Ç —â–µ –Ω–µ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –Ω–∞ –ø–∞—Å–ø–æ—Ä—Ç.");
        } else {
          $("invoiceHint").textContent = "‚úÖ –†–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ";
          setTimeout(() => {
            $("invoiceHint").textContent = "";
          }, 2000);
        }

        $("invoiceText").value = "";
        if (fileInput) fileInput.value = "";
      } catch (e) {
        console.error(e);
        $("invoiceHint").textContent = "";
        alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏"));
      } finally {
        $("btnInvoiceSend").disabled = false;
      }
    }

    async function startCamera() {
      try {
        camStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });

        const v = $("camVideo");
        v.srcObject = camStream;
        await v.play();

        $("cameraBox").style.display = "block";
        $("btnCapture").style.display = "inline-flex";
        $("btnCamToggle").style.display = "inline-flex";
        $("btnCamOpen").style.display = "none";

        // torch button if supported
        const track = camStream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if (caps && caps.torch) {
          $("btnTorch").style.display = "inline-flex";
        } else {
          $("btnTorch").style.display = "none";
        }

      } catch (e) {
        console.error(e);
        alert("‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
        stopCamera();
      }
    }

    function stopCamera() {
      if (camStream) {
        camStream.getTracks().forEach(t => t.stop());
        camStream = null;
      }
      torchOn = false;

      $("cameraBox").style.display = "none";
      $("btnCapture").style.display = "none";
      $("btnTorch").style.display = "none";
      $("btnCamToggle").style.display = "none";
      $("btnCamOpen").style.display = "inline-flex";
    }

    async function toggleTorch() {
      if (!camStream) return;
      try {
        const track = camStream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if (!caps.torch) {
          alert("‚ö†Ô∏è –°–≤—ñ—Ç–ª–æ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó");
          return;
        }
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        $("btnTorch").textContent = "üí°";
        $("btnTorch").title = torchOn ? "–°–≤—ñ—Ç–ª–æ: ON" : "–°–≤—ñ—Ç–ª–æ";
      } catch (e) {
        console.error(e);
      }
    }

    function captureStatusPhoto() {
      if (!camStream) return;

      const v = $("camVideo");
      const c = $("camCanvas");
      const sourceWidth = v.videoWidth || 1280;
      const sourceHeight = v.videoHeight || 720;
      const targetAspect = 16 / 9;

      let cropWidth = sourceWidth;
      let cropHeight = sourceHeight;
      let cropX = 0;
      let cropY = 0;

      const sourceAspect = sourceWidth / sourceHeight;
      if (sourceAspect > targetAspect) {
        cropWidth = Math.round(sourceHeight * targetAspect);
        cropX = Math.round((sourceWidth - cropWidth) / 2);
      } else if (sourceAspect < targetAspect) {
        cropHeight = Math.round(sourceWidth / targetAspect);
        cropY = Math.round((sourceHeight - cropHeight) / 2);
      }

      c.width = cropWidth;
      c.height = cropHeight;

      const ctx = c.getContext("2d");
      ctx.drawImage(v, cropX, cropY, cropWidth, cropHeight, 0, 0, c.width, c.height);

      // —Å–∂–∏–º–∞–µ–º —Ä–∞–∑—É–º–Ω–æ —á—Ç–æ–±—ã –Ω–µ –≤–∑–æ—Ä–≤–∞—Ç—å –ª–∏–º–∏—Ç—ã
      const dataURL = c.toDataURL("image/jpeg", 0.88);

      const MAX = 10;
      if (statusPhotos.length >= MAX) {
        alert(`–ú–∞–∫—Å–∏–º—É–º ${MAX} —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É`);
        return;
      }

      statusPhotos.push(dataURL);
      updateStatusPhotosUI();
    }

    // ===========================
    // ‚úÖ UPLOAD PHOTOS (MULTI) -> GAS
    // ===========================
    async function uploadPhotosMulti() {
      const input = $("photoFiles");
      const files = input && input.files ? Array.from(input.files) : [];

      if (!files.length) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)");

      const MAX = 10;
      if (files.length > MAX) {
        if (!confirm(`–û–±—Ä–∞–Ω–æ ${files.length} —Ñ–æ—Ç–æ. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ ${MAX}?`)) return;
      }

      const toUpload = files.slice(0, MAX);

      $("btnUploadPhotos").disabled = true;
      $("photosHint").textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é ${toUpload.length} —Ñ–æ—Ç–æ...`;

      try {
        const photos = [];
        for (let i = 0; i < toUpload.length; i++) {
          $("photosHint").textContent = `–ì–æ—Ç—É—é —Ñ–æ—Ç–æ ${i + 1} / ${toUpload.length}...`;
          photos.push(await fileToBase64(toUpload[i]));
        }

        $("photosHint").textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é ${photos.length} —Ñ–æ—Ç–æ...`;
        const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/photo`, {
          photos,
          caption: ""
        });

        if (!out.ok) {
          throw new Error(out.error || "–ü–æ–º–∏–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ");
        }

        $("photosHint").textContent = "‚úÖ –§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ";
        setTimeout(() => $("photosHint").textContent = "", 2000);

        input.value = "";
        await load();

      } catch (e) {
        console.error(e);
        $("photosHint").textContent = "";
        alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"));
      } finally {
        $("btnUploadPhotos").disabled = false;
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

$("btnReSend").onclick = reSendToTelegramAndTrello;

async function reSendToTelegramAndTrello() {
  try {
    if (!LAST_EQUIPMENT?.id) {
      return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω–∏ –û–Ω–æ–≤–∏—Ç–∏.");
    }

    const files = Array.from($("reFiles")?.files || []);
    if (!files.length) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)");

    $("btnReSend").disabled = true;
    $("reHint").textContent = "–í—ñ–¥–ø—Ä–∞–≤–ª—è—é...";

    // ‚úÖ –°–æ–±–∏—Ä–∞–µ–º card –¢–ê–ö –ñ–ï, –∫–∞–∫ /send-equipment –æ–∂–∏–¥–∞–µ—Ç
    const eq = LAST_EQUIPMENT;

    const card = {
      id: String(eq.id || "").trim(),
      owner: eq.owner || "client",
      type: eq.type || "",
      isContract: String(eq.isContract) === "true" || eq.isContract === true,
    };

    // –¥–æ–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –ø–æ owner
    if (card.owner === "client") {
      card.clientName = eq.clientName || "";
      card.clientPhone = eq.clientPhone || "";
      card.clientLocation = eq.clientLocation || "";
      card.model = eq.model || "";
      card.serial = eq.serial || "";
      // problem/condition –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ –¥–æ–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç
      card.problem = "";
      card.condition = "";
    } else {
      card.companyLocation = eq.companyLocation || "";
      card.name = eq.name || "";
      card.internalNumber = eq.internalNumber || "";
      card.task = "";
      card.comment = "";
    }

    // ‚úÖ –¥–æ–±–∞–≤–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤ lastComment / caption)
    const extra = String($("reComment").value || "").trim();
    if (extra) {
      // —Å–µ—Ä–≤–µ—Ä –≤ buildCaption —á–∏—Ç–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è
      // –ø–æ—ç—Ç–æ–º—É –∫–ª–∞–¥—ë–º —Ç—É–¥–∞, –≥–¥–µ –æ–Ω —Ç–æ—á–Ω–æ –ø–æ–∫–∞–∂–µ—Ç:
      if (card.owner === "client") card.problem = extra;
      else card.comment = extra;
    }

    // ‚úÖ —Ñ–∞–π–ª—ã -> base64
    const photos = [];
    for (let i = 0; i < files.length; i++) {
      $("reHint").textContent = `–ì–æ—Ç—É—é —Ñ–æ—Ç–æ ${i + 1} / ${files.length}...`;
      photos.push(await fileToBase64(files[i]));
    }

    // ‚úÖ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–≤–Ω–æ –∫–∞–∫ ‚Äú–∫–Ω–æ–ø–∫–∞ –ø—Ä–∏—ë–º–∞‚Äù
    const resp = await fetch(`${API_BASE}/send-equipment`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...headersWithKey(),
      },
      body: JSON.stringify({ card, photos }),
    });

    if (!resp.ok) {
      const t = await resp.text().catch(() => "");
      throw new Error("Server error: " + t.slice(0, 200));
    }

    $("reHint").textContent = "‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ TG + Trello";
    setTimeout(() => $("reHint").textContent = "", 2500);

    // –æ—á–∏—Å—Ç–∫–∞
    $("reFiles").value = "";
    $("reComment").value = "";

  } catch (e) {
    console.error(e);
    $("reHint").textContent = "";
    alert("‚ùå " + (e.message || "–ü–æ–º–∏–ª–∫–∞"));
  } finally {
    $("btnReSend").disabled = false;
  }
}

$("btnPrint").onclick = () => printBlank();

function printBlank() {
  if (!LAST_EQUIPMENT) {
    alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö. –ù–∞—Ç–∏—Å–Ω–∏ –û–Ω–æ–≤–∏—Ç–∏.");
    return;
  }

  const owner = LAST_EQUIPMENT.owner || "client";
  const page = owner === "company" ? "company-print.html" : "print.html";

  // ‚úÖ –±–µ—Ä–µ–º —Ç–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ
  const baseTask = owner === "company"
    ? (LAST_EQUIPMENT.task || "")
    : (LAST_EQUIPMENT.problem || "");

  const baseComment = owner === "company"
    ? (LAST_EQUIPMENT.comment || LAST_EQUIPMENT.lastComment || "")
    : (LAST_EQUIPMENT.lastComment || "");

  // ‚úÖ –±–µ—Ä–µ–º —Ç–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –≤–≤–µ–¥–µ–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å—Ç–∞—Ç—É—Å—É)
  const liveComment = (document.getElementById("comment")?.value || "").trim();

  // ‚úÖ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É/–ø—Ä–æ–±–ª–µ–º—É –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é (—É–¥–æ–±–Ω–æ!)
  const task = prompt("–ó–∞–≤–¥–∞–Ω–Ω—è / –ø—Ä–æ–±–ª–µ–º–∞ (–¥–ª—è –¥—Ä—É–∫—É):", baseTask) || baseTask;

  // ‚úÖ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –µ—Å–ª–∏ –≤ –ø–æ–ª–µ –≤–≤–µ–ª–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ ‚Äî –µ–≥–æ –∏ –±–µ—Ä–µ–º
  const commentForPrint = prompt("–ö–æ–º–µ–Ω—Ç–∞—Ä (–¥–ª—è –¥—Ä—É–∫—É):", liveComment || baseComment) || (liveComment || baseComment);

  const k = ensureKey();

  const url =
    `/${page}?id=${encodeURIComponent(EQUIPMENT_ID)}` +
    `&k=${encodeURIComponent(k)}` +
    `&task=${encodeURIComponent(task)}` +
    `&comment=${encodeURIComponent(commentForPrint)}`;

  window.open(url, "_blank");
}


    // ===========================
    // UTILS
    // ===========================
    function fmt(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const yy = String(dt.getFullYear()).slice(-2);
        const hh = String(dt.getHours()).padStart(2, "0");
        const mi = String(dt.getMinutes()).padStart(2, "0");
        return `${dd}.${mm}.${yy} ${hh}:${mi}`;
      } catch (e) { return ""; }
    }

    function esc(v) {
      if (v === null || v === undefined) return "‚Äî";
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function escapeJs(s){
      return String(s || "")
        .replaceAll("\\", "\\\\")
        .replaceAll("'", "\\'")
        .replaceAll("\n", "\\n")
        .replaceAll("\r", "");
    }

    // ===========================
    // Cleanup camera on page leave
    // ===========================
    window.addEventListener("beforeunload", () => {
      try { stopCamera(); } catch(e){}
    });
  </script>
</body>
</html>
