<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surpresso ‚Äî –ü–∞—Å–ø–æ—Ä—Ç</title>
  <style>
    body{font-family:Segoe UI,system-ui,sans-serif;margin:0;background:#fff;color:#222}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;border-bottom:2px solid #F2C94C;padding-bottom:10px}
    .logo{font-size:20px;font-weight:800}
    .sub{font-size:12px;color:#666}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-yellow{background:#F2C94C}
    .btn-ghost{background:#f4f4f4}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    select,input{width:100%;padding:10px;border-radius:12px;border:1px solid #ddd;font-size:14px}
    table{width:100%;border-collapse:collapse}
    td{padding:6px 4px;border-bottom:1px solid #eee;vertical-align:top}
    td.lbl{font-weight:700;width:220px}
    .muted{color:#666;font-size:12px}
    .warn{color:#b00;font-weight:800}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:#f4f4f4;border-radius:999px;padding:6px 10px;font-size:12px}
    .link{color:#222;text-decoration:none;border-bottom:1px dashed #999}
    .hint{font-size:12px;color:#666}

    /* ===== Gallery (grid) ===== */
    .photosGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    @media(max-width:760px){.photosGrid{grid-template-columns:repeat(2,1fr)}}
    .phTile{border:1px solid #eee;border-radius:12px;overflow:hidden;position:relative;background:#fafafa}
    .phTile img{width:100%;display:block;height:160px;object-fit:cover}
    .phCap{position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,.55);color:#fff;font-size:11px;padding:4px 6px;border-radius:999px}
    .phDate{position:absolute;right:8px;bottom:8px;background:rgba(255,255,255,.8);color:#222;font-size:11px;padding:4px 6px;border-radius:999px}

    /* ===== Fullscreen viewer ===== */
    .viewer{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;z-index:9999}
    .viewer.open{display:block}
    .viewerTop{display:flex;align-items:center;justify-content:space-between;padding:12px 12px 6px 12px;color:#fff}
    .viewerTitle{font-weight:800;font-size:14px}
    .viewerClose{background:rgba(255,255,255,.15);color:#fff;border:0;border-radius:12px;padding:8px 10px;font-weight:800}
    .viewerBody{height:calc(100vh - 56px);display:flex;align-items:center;justify-content:center;position:relative}
    .viewerImg{max-width:94vw;max-height:84vh;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .navBtn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.15);border:0;color:#fff;border-radius:999px;padding:10px 12px;font-weight:900}
    .navBtn.left{left:10px}
    .navBtn.right{right:10px}
    .viewerMeta{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);color:#fff;font-size:12px;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:999px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="logo">Surpresso Service</div>
        <div class="sub">–ü–∞—Å–ø–æ—Ä—Ç / —Å—Ç–∞—Ç—É—Å –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</div>
      </div>
      <div class="sub">ID: <b id="eqId">‚Äî</b></div>
    </div>

    <div id="noId" class="card" style="display:none">
      <div class="warn">–ù–µ–º–∞—î ID. –í—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫—É —è–∫: <b>equip.html?id=...</b></div>
      <div class="hint" style="margin-top:6px">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: <b>equip.html?id=SURP-12345</b></div>
    </div>

    <div id="main" style="display:none">

      <div class="card">
        <div class="bar" style="justify-content:space-between">
          <div>
            <div class="muted">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å</div>
            <div style="font-size:18px;font-weight:800" id="curStatus">‚Äî</div>
            <div class="muted" id="updatedAt"></div>
          </div>

          <div class="row">
            <button class="btn btn-ghost" id="btnPdf">üìÑ PDF A4</button>
            <button class="btn btn-yellow" id="btnRefresh">‚ü≥ –û–Ω–æ–≤–∏—Ç–∏</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <span class="pill" id="pillOwner">owner: ‚Äî</span>
          <span class="pill" id="pillType">type: ‚Äî</span>
          <a class="pill link" id="driveFolderLink" href="#" target="_blank" style="display:none">üìÅ Drive –ø–∞–ø–∫–∞</a>
        </div>

        <div class="muted" style="margin-top:8px" id="authInfo"></div>
      </div>

      <div class="card">
        <div class="grid">
          <div>
            <div class="muted">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</div>
            <select id="statusSelect"></select>
          </div>
          <div>
            <div class="muted">–ö–æ–º–µ–Ω—Ç–∞—Ä</div>
            <input id="comment" placeholder="–ù–∞–ø—Ä: –ó–∞–±—Ä–∞–≤ –∫–ª—ñ—î–Ω—Ç, –≤—ñ–¥–¥–∞–ª–∏ –≤ –æ—Ä–µ–Ω–¥—É..." />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="actor" placeholder="–•—Ç–æ –∑–º—ñ–Ω–∏–≤ (–æ–ø—Ü.) –Ω–∞–ø—Ä: –Ü–≥–æ—Ä" style="max-width:220px" />
          <button class="btn btn-yellow" id="btnStatus">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
          <span class="muted" id="statusHint"></span>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>
          <div class="muted" id="infoHint"></div>
        </div>
        <table id="info"></table>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800">–§–æ—Ç–æ</div>
          <div class="row">
            <input type="file" id="photoFile" accept="image/*" />
            <button class="btn btn-yellow" id="btnUpload">üì∏ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
          </div>
        </div>
        <div class="muted" style="margin-top:6px">–§–æ—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –ø–∞–ø—Ü—ñ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è (Drive).</div>

        <div class="photosGrid" id="photos"></div>
      </div>

      <div class="card">
        <div style="font-weight:800">–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤</div>
        <table id="log"></table>
      </div>
    </div>
  </div>

  <!-- Fullscreen viewer -->
  <div class="viewer" id="viewer">
    <div class="viewerTop">
      <div class="viewerTitle" id="viewerTitle">–§–æ—Ç–æ</div>
      <button class="viewerClose" id="viewerClose">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div class="viewerBody" id="viewerBody">
      <button class="navBtn left" id="viewerPrev">‚üµ</button>
      <img class="viewerImg" id="viewerImg" src="" alt="">
      <button class="navBtn right" id="viewerNext">‚ü∂</button>
      <div class="viewerMeta" id="viewerMeta">‚Äî</div>
    </div>
  </div>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const PWA_KEY_STORAGE = "surpresso_pwa_key";
    // –ï—Å–ª–∏ equip.html –ª–µ–∂–∏—Ç –Ω–∞ –¥—Ä—É–≥–æ–º –¥–æ–º–µ–Ω–µ (GAS/GitHub/file) ‚Äî —É–∫–∞–∂–∏ —Å—é–¥–∞ URL —Å–µ—Ä–≤–µ—Ä–∞:
    // const API_BASE = "https://wpa-surpresso.fly.dev";
    const API_BASE = "";

    const DEFAULT_STATUSES_CLIENT = [
      "–ü—Ä–∏–π–Ω—è—Ç–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç",
      "–í —Ä–æ–±–æ—Ç—ñ",
      "–ì–æ—Ç–æ–≤–æ",
      "–í–∏–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç—É"
    ];

    const DEFAULT_STATUSES_COMPANY = [
      "–ü—Ä–∏–µ—Ö–∞–ª–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç",
      "–ì–æ—Ç–æ–≤–æ –∫ –∞—Ä–µ–Ω–¥–µ",
      "–£–µ–∑–∂–∞–µ—Ç –Ω–∞ –∞—Ä–µ–Ω–¥—É",
      "–ü—Ä–∏–µ—Ö–∞–ª–æ –ø–æ—Å–ª–µ –∞—Ä–µ–Ω–¥—ã",
      "–£–µ–∑–∂–∞–µ—Ç –Ω–∞ –ø–æ–¥–º–µ–Ω—É",
      "–ü—Ä–∏–µ—Ö–∞–ª–æ —Å –ø–æ–¥–º–µ–Ω—ã",
      "–ë—Ä–æ–Ω—å",
      "–ü—Ä–æ–¥–∞–Ω–æ"
    ];

    const $ = (id) => document.getElementById(id);

    // ===========================
    // GET ID FROM URL
    // ===========================
    const params = new URLSearchParams(location.search);
    const EQUIPMENT_ID = (params.get("id") || "").trim();

    // ===========================
    // AUTH: key (—á–µ—Ä–µ–∑ query ?k=)
    // ===========================
    function getKey() {
      return localStorage.getItem(PWA_KEY_STORAGE) || "";
    }

    function ensureKey() {
      let k = getKey();
      if (k) return k;
      k = (prompt("–í–≤–µ–¥–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É (PWA Key):") || "").trim();
      if (!k) return "";
      localStorage.setItem(PWA_KEY_STORAGE, k);
      return k;
    }

    function addKey(url) {
      const k = ensureKey();
      if (!k) return url;
      return url.includes("?")
        ? `${url}&k=${encodeURIComponent(k)}`
        : `${url}?k=${encodeURIComponent(k)}`;
    }

    async function apiGet(url) {
      const resp = await fetch(addKey(url));
      return await resp.json();
    }

    async function apiPost(url, payload) {
      const resp = await fetch(addKey(url), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload || {})
      });
      return await resp.json();
    }

    // ===========================
    // INIT
    // ===========================
    if (!EQUIPMENT_ID) {
      $("noId").style.display = "block";
    } else {
      $("main").style.display = "block";
      $("eqId").textContent = EQUIPMENT_ID;

      $("btnRefresh").onclick = load;
      $("btnStatus").onclick = saveStatus;
      $("btnUpload").onclick = uploadPhoto;

      $("btnPdf").onclick = () => {
        location.href = addKey(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/pdf`);
      };

      $("authInfo").textContent = getKey()
        ? "üîê –ö–ª—é—á –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ ‚úÖ"
        : "üîê –ü–æ—Ç—Ä—ñ–±–µ–Ω –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É (–∑–∞–ø–∏—Ç–∞—î –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø–∏—Ç—ñ)";

      // Viewer events
      $("viewerClose").onclick = closeViewer;
      $("viewerPrev").onclick = () => stepViewer(-1);
      $("viewerNext").onclick = () => stepViewer(+1);
      $("viewer").addEventListener("click", (e) => {
        if (e.target.id === "viewer") closeViewer();
      });

      // keyboard
      window.addEventListener("keydown", (e) => {
        if (!$("viewer").classList.contains("open")) return;
        if (e.key === "Escape") closeViewer();
        if (e.key === "ArrowLeft") stepViewer(-1);
        if (e.key === "ArrowRight") stepViewer(+1);
      });

      // swipe
      let sx=0, sy=0;
      $("viewerBody").addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        sx = t.clientX; sy = t.clientY;
      }, {passive:true});
      $("viewerBody").addEventListener("touchend", (e) => {
        const t = e.changedTouches[0];
        const dx = t.clientX - sx;
        const dy = t.clientY - sy;
        if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
          stepViewer(dx > 0 ? -1 : +1);
        }
      }, {passive:true});

      load();
    }

    // ===========================
    // STATE
    // ===========================
    let CURRENT_OWNER = "";
    let PHOTOS_CACHE = [];
    let VIEW_INDEX = 0;

    // ===========================
    // LOAD
    // ===========================
    async function load() {
      $("statusHint").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      $("btnRefresh").disabled = true;

      const data = await apiGet(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}`);

      $("btnRefresh").disabled = false;
      $("statusHint").textContent = "";

      if (!data.ok) {
        return alert(data.error || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è");
      }

      render(data);
    }

    // ===========================
    // RENDER
    // ===========================
    function render(data) {
      const eq = data.equipment || {};
      const photos = data.photos || [];
      const log = data.log || [];

      CURRENT_OWNER = eq.owner || "";
      PHOTOS_CACHE = photos;

      $("curStatus").textContent = eq.status || "‚Äî";
      $("updatedAt").textContent = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + fmt(eq.updatedAt);

      $("pillOwner").textContent = "owner: " + (eq.owner || "‚Äî");
      $("pillType").textContent = "type: " + (eq.type || "‚Äî");

      // Drive folder link
      if (eq.folderUrl) {
        $("driveFolderLink").href = eq.folderUrl;
        $("driveFolderLink").style.display = "inline-flex";
      } else {
        $("driveFolderLink").style.display = "none";
      }

      // statuses
      const statuses = buildStatusesFor(eq);
      fillStatuses(statuses, eq.status);

      // info
      const rows = [];
      const add = (k, v) => rows.push(`<tr><td class="lbl">${k}</td><td>${esc(v)}</td></tr>`);

      add("–¢–∏–ø", eq.type || "‚Äî");
      add("–í–ª–∞—Å–Ω–∏–∫", eq.owner || "‚Äî");

      if (String(eq.isContract) === "true") add("–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è", "–ó–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–º ‚úÖ");

      if (eq.owner === "client") {
        add("–ö–ª—ñ—î–Ω—Ç", eq.clientName || "‚Äî");
        add("–¢–µ–ª–µ—Ñ–æ–Ω", eq.clientPhone || "‚Äî");
        add("–õ–æ–∫–∞—Ü—ñ—è", eq.clientLocation || "‚Äî");
        add("–ú–æ–¥–µ–ª—å", eq.model || "‚Äî");
        add("–°–µ—Ä—ñ–π–Ω–∏–π", eq.serial || "‚Äî");
      } else {
        add("–õ–æ–∫–∞—Ü—ñ—è (–∑–∞–∫–ª–∞–¥/—Ü–µ—Ö)", eq.companyLocation || "‚Äî");
        add("–ù–∞–∑–≤–∞", eq.name || "‚Äî");
        add("–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ‚Ññ", eq.internalNumber || "‚Äî");
      }

      add("–û—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä", eq.lastComment || "‚Äî");

      $("info").innerHTML = rows.join("");

      // Gallery
      renderGallery(photos);

      // Log
      $("log").innerHTML = log.length
        ? log.map(r => `
          <tr>
            <td style="width:160px">${fmt(r.ts)}</td>
            <td><b>${esc(r.newStatus)}</b>
              ${r.comment ? "‚Äî " + esc(r.comment) : ""}
              ${r.actor ? `<span class="muted">(${esc(r.actor)})</span>` : ""}
            </td>
          </tr>
        `).join("")
        : `<tr><td class="muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤</td></tr>`;
    }

    function buildStatusesFor(eq) {
      if (eq.owner === "company") return DEFAULT_STATUSES_COMPANY;
      return DEFAULT_STATUSES_CLIENT;
    }

    function fillStatuses(list, current) {
      const sel = $("statusSelect");
      sel.innerHTML = "";
      list.forEach(s => {
        const o = document.createElement("option");
        o.value = s;
        o.textContent = s;
        sel.appendChild(o);
      });

      if (current && list.includes(current)) sel.value = current;
      else sel.value = list[0] || "";
    }

    // ===========================
    // GALLERY
    // ===========================
    function renderGallery(photos) {
      const box = $("photos");

      if (!photos.length) {
        box.innerHTML = `<div class="muted">–§–æ—Ç–æ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î.</div>`;
        return;
      }

      box.innerHTML = photos.map((p, idx) => {
        const date = p.ts ? fmtShort(p.ts) : "";
        const cap = p.caption ? String(p.caption).slice(0, 18) : "";
        return `
          <div class="phTile" role="button" tabindex="0" onclick="openViewer(${idx})">
            <img src="${p.thumb || p.url}" alt="">
            ${cap ? `<div class="phCap">${esc(cap)}</div>` : ""}
            ${date ? `<div class="phDate">${esc(date)}</div>` : ""}
          </div>
        `;
      }).join("");
    }

    // expose for onclick
    window.openViewer = function(idx) {
      if (!PHOTOS_CACHE.length) return;
      VIEW_INDEX = clamp(idx, 0, PHOTOS_CACHE.length - 1);

      const p = PHOTOS_CACHE[VIEW_INDEX];
      $("viewerImg").src = p.url;
      $("viewerTitle").textContent = `–§–æ—Ç–æ ${VIEW_INDEX + 1} / ${PHOTOS_CACHE.length}`;
      $("viewerMeta").textContent = `${p.caption ? p.caption : ""}${p.ts ? " ‚Ä¢ " + fmt(p.ts) : ""}`.trim() || "‚Äî";

      $("viewer").classList.add("open");
    }

    function closeViewer() {
      $("viewer").classList.remove("open");
      $("viewerImg").src = "";
    }

    function stepViewer(dir) {
      if (!PHOTOS_CACHE.length) return;
      VIEW_INDEX = clamp(VIEW_INDEX + dir, 0, PHOTOS_CACHE.length - 1);
      openViewer(VIEW_INDEX);
    }

    // ===========================
    // SAVE STATUS
    // ===========================
    async function saveStatus() {
      const newStatus = $("statusSelect").value;
      const comment = $("comment").value.trim();
      const actor = $("actor").value.trim();

      $("btnStatus").disabled = true;
      $("statusHint").textContent = "–ó–±–µ—Ä—ñ–≥–∞—é...";

      const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/status`, {
        newStatus, comment, actor
      });

      $("btnStatus").disabled = false;
      $("statusHint").textContent = "";

      if (!out.ok) return alert(out.error || "–ü–æ–º–∏–ª–∫–∞");

      $("comment").value = "";
      await load();
    }

    // ===========================
    // UPLOAD PHOTO
    // ===========================
    async function uploadPhoto() {
      const file = $("photoFile").files[0];
      if (!file) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ");

      $("btnUpload").disabled = true;
      $("infoHint").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —Ñ–æ—Ç–æ...";

      const base64 = await fileToBase64(file);

      const out = await apiPost(`${API_BASE}/api/equip/${encodeURIComponent(EQUIPMENT_ID)}/photo`, {
        base64,
        caption: ""
      });

      $("btnUpload").disabled = false;
      $("infoHint").textContent = "";

      if (!out.ok) return alert(out.error || "–ü–æ–º–∏–ª–∫–∞");

      $("photoFile").value = "";
      await load();
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // ===========================
    // UTILS
    // ===========================
    function fmt(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const yy = String(dt.getFullYear()).slice(-2);
        const hh = String(dt.getHours()).padStart(2, "0");
        const mi = String(dt.getMinutes()).padStart(2, "0");
        return `${dd}.${mm}.${yy} ${hh}:${mi}`;
      } catch (e) { return ""; }
    }

    function fmtShort(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return "";
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      } catch (e) { return ""; }
    }

    function esc(v) {
      if (v === null || v === undefined) return "‚Äî";
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function clamp(n, a, b) {
      return Math.max(a, Math.min(b, n));
    }
  </script>
</body>
</html>
